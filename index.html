<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inmobiliario - Corvacruz</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Colores del Sistema --- */
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #2980b9;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --light: #f4f6f9;
            --white: #ffffff;

            /* Extra estética */
            --bg1: #0f172a;
            --bg2: #111827;
            --glass: rgba(255,255,255,0.08);
            --glass2: rgba(255,255,255,0.14);
            --shadow: 0 18px 55px rgba(0,0,0,0.35);
            --shadowSoft: 0 8px 25px rgba(0,0,0,0.12);
            --ring: rgba(41,128,185,0.25);
            --muted: rgba(255,255,255,0.65);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }

        body {
            background-color: var(--light);
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .gap-2 { gap: 10px; }
        .w-100 { width: 100%; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            color: #fff;
            transition: 0.18s ease;
            font-size: 0.92rem;
            letter-spacing: 0.2px;
            box-shadow: 0 10px 22px rgba(0,0,0,0.12);
        }
        .btn:hover { transform: translateY(-1px); opacity: 0.95; }
        .btn:active { transform: translateY(0px); opacity: 0.92; }

        .btn-p { background: linear-gradient(135deg, #2f80ed, var(--accent)); }
        .btn-s { background: linear-gradient(135deg, #2ecc71, var(--success)); }
        .btn-d { background: linear-gradient(135deg, #e74c3c, var(--danger)); }
        .btn-w { background: linear-gradient(135deg, #f1c40f, var(--warning)); color: #2c3e50; }
        .btn-g { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .btn-sm { padding: 7px 12px; font-size: 0.82rem; border-radius: 9px; }

        #loader {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.88);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: var(--accent);
            backdrop-filter: blur(6px);
        }

        /* --- Login --- */
        #login-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background:
              radial-gradient(1000px 600px at 15% 10%, rgba(41,128,185,0.45), transparent 60%),
              radial-gradient(900px 550px at 90% 35%, rgba(39,174,96,0.25), transparent 55%),
              radial-gradient(800px 500px at 55% 95%, rgba(243,156,18,0.18), transparent 60%),
              linear-gradient(135deg, var(--bg1), var(--bg2));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 18px;
        }

        .login-box {
            width: 440px;
            max-width: 95vw;
            border-radius: 18px;
            padding: 28px 28px 24px 28px;
            background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .login-box:before {
            content: "";
            position: absolute;
            inset: -2px;
            background: radial-gradient(600px 240px at 20% 0%, rgba(255,255,255,0.20), transparent 60%);
            pointer-events: none;
        }

        .login-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .login-logo {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.18);
        }

        .login-logo i { color: rgba(255,255,255,0.92); font-size: 20px; }

        .login-title {
            font-size: 1.35rem;
            font-weight: 800;
            letter-spacing: 0.3px;
            line-height: 1.1;
        }

        .login-subtitle {
            color: var(--muted);
            margin-bottom: 18px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .input-group { margin-bottom: 14px; text-align: left; }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 800;
            color: #475569;
            font-size: 0.92rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 11px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: 0.18s ease;
            background: #fff;
            box-shadow: 0 6px 18px rgba(0,0,0,0.04);
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: rgba(41,128,185,0.55);
            box-shadow: 0 0 0 4px var(--ring);
        }

        #login-screen .input-group label { color: rgba(255,255,255,0.82); }
        #login-screen .input-group input {
            border: 1px solid rgba(255,255,255,0.18);
            background: rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.95);
            box-shadow: none;
        }
        #login-screen .input-group input::placeholder { color: rgba(255,255,255,0.55); }
        #login-screen .input-group input:focus { box-shadow: 0 0 0 4px rgba(41,128,185,0.25); }

        .number-preview {
            font-size: 0.88rem;
            color: var(--success);
            font-weight: 800;
            margin-top: 6px;
            display: inline-block;
            background: #e8f8f5;
            padding: 3px 10px;
            border-radius: 999px;
            border: 1px solid #c3e6cb;
        }

        #app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background: radial-gradient(1200px 600px at 20% 5%, rgba(41,128,185,0.12), transparent 65%),
                        radial-gradient(900px 500px at 85% 18%, rgba(39,174,96,0.10), transparent 55%),
                        linear-gradient(180deg, #f7fafc, #eef2f7);
        }

        aside {
            width: 270px;
            background: linear-gradient(180deg, #0f172a, #111827);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 35px rgba(0,0,0,0.16);
            border-right: 1px solid rgba(255,255,255,0.06);
        }

        aside h3 {
            padding: 18px 18px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.05rem;
            font-weight: 900;
            letter-spacing: 0.2px;
        }

        .menu { padding: 10px; }

        .menu button {
            width: 100%;
            padding: 12px 14px;
            background: transparent;
            border: 1px solid transparent;
            color: rgba(255,255,255,0.78);
            text-align: left;
            cursor: pointer;
            font-size: 0.98rem;
            transition: 0.18s ease;
            border-radius: 12px;
            margin-bottom: 6px;
        }

        .menu button:hover {
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.95);
            border-color: rgba(255,255,255,0.10);
        }

        .menu button.active {
            background: linear-gradient(135deg, rgba(41,128,185,0.24), rgba(41,128,185,0.10));
            color: rgba(255,255,255,0.98);
            border-color: rgba(41,128,185,0.35);
            font-weight: 900;
            position: relative;
        }

        .menu button.active:before {
            content: "";
            position: absolute;
            left: 8px;
            top: 10px;
            bottom: 10px;
            width: 4px;
            border-radius: 999px;
            background: linear-gradient(180deg, #2f80ed, #2980b9);
        }

        .menu i {
            margin-right: 10px;
            width: 22px;
            text-align: center;
            opacity: 0.95;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: transparent;
        }

        header {
            background: rgba(255,255,255,0.72);
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadowSoft);
            border-bottom: 1px solid rgba(15,23,42,0.06);
            backdrop-filter: blur(10px);
        }

        #page-title { font-weight: 950; letter-spacing: 0.2px; }

        #content {
            flex: 1;
            padding: 18px;
            overflow-y: auto;
        }

        .card {
            background: rgba(255,255,255,0.85);
            padding: 18px;
            border-radius: 16px;
            box-shadow: var(--shadowSoft);
            margin-bottom: 16px;
            border: 1px solid rgba(15,23,42,0.06);
            backdrop-filter: blur(10px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            overflow: hidden;
            border-radius: 14px;
        }

        th, td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid #eef2f7;
            vertical-align: middle;
        }

        th {
            background: rgba(248,250,252,0.9);
            color: #0f172a;
            font-weight: 900;
            font-size: 0.92rem;
        }

        tr:hover { background: rgba(248,250,252,0.9); }

        .status-badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 900;
            letter-spacing: 0.2px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-disponible {
            background: #e8f8f5;
            color: #1f8a51;
            border: 1px solid rgba(39,174,96,0.45);
        }

        .status-vendido {
            background: #eef2f7;
            color: #64748b;
            border: 1px solid rgba(100,116,139,0.35);
        }

        .gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .img-preview-box {
            position: relative;
            width: 110px;
            height: 110px;
            border: 1px solid rgba(15,23,42,0.10);
            background: rgba(255,255,255,0.92);
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 10px 24px rgba(0,0,0,0.08);
        }

        .img-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .pdf-icon {
            font-size: 42px;
            color: var(--danger);
            margin-bottom: 6px;
        }

        .file-name {
            font-size: 10px;
            color: #475569;
            text-align: center;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding: 0 6px 6px 6px;
            font-weight: 800;
        }

        .btn-del-img {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(200,0,0,0.90);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 900;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.25);
        }

        .thumb-container {
            width: 62px;
            height: 62px;
            position: relative;
            cursor: pointer;
        }

        .thumb-small {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid rgba(15,23,42,0.10);
            background: #fff;
            box-shadow: 0 10px 22px rgba(0,0,0,0.08);
        }

        .thumb-pdf {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--danger);
            background: #fff0f0;
            border: 1px solid #ffcccc;
            border-radius: 12px;
            box-shadow: 0 10px 22px rgba(0,0,0,0.08);
        }

        .file-count {
            position: absolute;
            bottom: -6px;
            right: -6px;
            background: #0f172a;
            color: white;
            font-size: 10px;
            padding: 2px 7px;
            border-radius: 999px;
            font-weight: 900;
            border: 2px solid rgba(255,255,255,0.9);
        }

        .img-full {
            width: 100%;
            max-height: 460px;
            object-fit: contain;
            background: rgba(248,250,252,0.9);
            border: 1px solid rgba(15,23,42,0.06);
            margin-bottom: 12px;
            border-radius: 14px;
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
        }

        .doc-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px;
            background: rgba(255,255,255,0.92);
            border: 1px solid rgba(15,23,42,0.08);
            border-left: 6px solid var(--danger);
            margin-bottom: 10px;
            border-radius: 14px;
            color: #0f172a;
            text-decoration: none;
            font-weight: 900;
            transition: 0.18s ease;
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
        }

        .doc-link:hover {
            background: #fff5f5;
            transform: translateX(3px);
        }

        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(2,6,23,0.65);
            z-index: 2500;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 14px;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: rgba(255,255,255,0.92);
            padding: 18px;
            border-radius: 18px;
            width: 96%;
            max-width: 640px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            border: 1px solid rgba(15,23,42,0.10);
            backdrop-filter: blur(10px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(15,23,42,0.08);
            padding-bottom: 10px;
        }

        .close-modal {
            background: rgba(15,23,42,0.06);
            border: 1px solid rgba(15,23,42,0.08);
            font-size: 1.4rem;
            cursor: pointer;
            color: #0f172a;
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-modal:hover { background: rgba(15,23,42,0.10); }

        .chart-container {
            position: relative;
            height: 260px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .live-calc-box {
            background: rgba(224,242,241,0.95);
            padding: 10px 12px;
            border-radius: 14px;
            margin-top: 10px;
            text-align: center;
            border: 1px solid rgba(128,203,196,0.85);
            box-shadow: 0 10px 22px rgba(0,0,0,0.06);
        }

        .date-filters {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(255,255,255,0.78);
            padding: 10px 12px;
            border-radius: 14px;
            box-shadow: var(--shadowSoft);
            margin-bottom: 16px;
            border: 1px solid rgba(15,23,42,0.06);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .date-filters input {
            border: 1px solid rgba(15,23,42,0.14);
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.92);
        }

        .hint-box {
            background: rgba(41,128,185,0.08);
            border: 1px solid rgba(41,128,185,0.18);
            padding: 10px 12px;
            border-radius: 14px;
            color: #0f172a;
            font-weight: 800;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        .hint-box small { display:block; margin-top:4px; font-weight:700; color:#334155; opacity:0.85; }

        @media (max-width: 860px) {
            aside { width: 240px; }
            #content { padding: 14px; }
            .card { padding: 14px; }
        }

        @media (max-width: 700px) {
            #app-container { flex-direction: column; }
            aside { width: 100%; }
            .menu { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
            .menu button { margin-bottom: 0; }
        }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top:15px; font-weight:900;">Cargando...</p>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <div class="login-brand">
                <div class="login-logo"><i class="fas fa-city"></i></div>
                <div>
                    <div class="login-title">Corvacruz Inmobiliaria</div>
                    <div class="login-subtitle">Sistema seguro & privado</div>
                </div>
            </div>

            <form id="form-login">
                <div class="input-group">
                    <label>Correo Electrónico</label>
                    <input type="email" id="email" required placeholder="tu@empresa.com">
                </div>
                <div class="input-group">
                    <label>Contraseña</label>
                    <input type="password" id="password" required placeholder="******">
                </div>
                <button type="submit" class="btn btn-p w-100"><i class="fas fa-right-to-bracket"></i> Ingresar</button>
                <p id="login-msg" style="color:#ffd5d5; margin-top:14px; font-weight:900;"></p>
            </form>

            <div style="margin-top:14px; color:rgba(255,255,255,0.68); font-weight:700; font-size:0.85rem;">
                <i class="fas fa-shield-halved"></i> Acceso restringido a usuarios autorizados
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">

        <aside>
            <h3><i class="fas fa-city"></i> Corvacruz Panel</h3>
            <div class="menu">
                <button id="btn-resumen" onclick="nav('resumen')" class="active"><i class="fas fa-chart-pie"></i> Resumen</button>
                <button id="btn-registro" onclick="nav('registro')"><i class="fas fa-plus-circle"></i> Registrar Terreno</button>
                <button id="btn-listado" onclick="nav('listado')"><i class="fas fa-list"></i> Inventario</button>
                <button id="btn-ventas" onclick="nav('ventas')"><i class="fas fa-file-invoice-dollar"></i> Ventas</button>
            </div>
        </aside>

        <main>
            <header>
                <h3 id="page-title" style="color:#0f172a">Resumen General</h3>
                <div class="flex" style="align-items:center; gap:12px; flex-wrap:wrap;">
                    <span id="user-email-display" style="font-weight:900; color:#334155;"></span>
                    <button onclick="logout()" class="btn btn-g btn-sm"><i class="fas fa-sign-out-alt"></i> Salir</button>
                </div>
            </header>

            <div id="content">

                <div id="view-resumen">
                    <div class="date-filters">
                        <label style="font-weight:900; color:#0f172a;"><i class="fas fa-calendar-alt"></i> Desde:</label>
                        <input type="date" id="filter-date-start" onchange="updateDashboard()">
                        <label style="font-weight:900; color:#0f172a;">Hasta:</label>
                        <input type="date" id="filter-date-end" onchange="updateDashboard()">
                        <span style="font-size:0.82rem; color:#334155; margin-left:8px; font-weight:800;">(Filtra lo recaudado)</span>
                    </div>

                    <div class="flex gap-2" style="margin-bottom:16px; flex-wrap:wrap;">
                        <div class="card" style="flex:1; text-align:center;">
                            <h4 style="color:#64748b; font-weight:900;">Total Terrenos</h4>
                            <h1 id="kpi-total" style="font-size:2.4rem; margin-top:8px; color:#0f172a;">0</h1>
                        </div>
                        <div class="card" style="flex:1; text-align:center;">
                            <h4 style="color:#64748b; font-weight:900;">Disponibles</h4>
                            <h1 id="kpi-disp" style="font-size:2.4rem; margin-top:8px; color:var(--success)">0</h1>
                        </div>
                        <div class="card" style="flex:1; text-align:center;">
                            <h4 style="color:#64748b; font-weight:900;">Vendidos</h4>
                            <h1 id="kpi-vendidos" style="font-size:2.4rem; margin-top:8px; color:#64748b">0</h1>
                        </div>
                        <div class="card" style="flex:1; text-align:center; border: 1px solid rgba(41,128,185,0.18);">
                            <h4 style="color:var(--accent); font-weight:950;">Recaudado (Ref. Bs)</h4>
                            <h1 id="kpi-money" style="font-size:2.4rem; margin-top:8px; color:#0f172a;">0</h1>
                        </div>
                    </div>

                    <div class="card">
                        <div class="chart-container">
                            <canvas id="chart-fin"></canvas>
                        </div>
                    </div>
                </div>

                <div id="view-registro" class="hidden">
                    <div class="card">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                            <h3 style="font-weight:950; color:#0f172a;">Registrar Nuevo Terreno</h3>
                            <span style="font-weight:900; color:#64748b; font-size:0.9rem;">
                                <i class="fas fa-paperclip"></i> Puedes añadir archivos uno por uno (se acumulan)
                            </span>
                        </div>

                        <form id="form-terreno" style="margin-top:16px;">
                            <div class="flex gap-2" style="flex-wrap:wrap;">
                                <div class="input-group w-100">
                                    <label>Código Interno</label>
                                    <input type="text" id="t-codigo" required>
                                </div>
                                <div class="input-group w-100">
                                    <label>Nombre / Ubicación</label>
                                    <input type="text" id="t-nome" required>
                                </div>
                            </div>

                            <div class="flex gap-2" style="flex-wrap:wrap;">
                                <div class="input-group w-100">
                                    <label>Superficie (m²)</label>
                                    <input type="number" id="t-area" oninput="window.showPreview(this, 'preview-t-area', 'm²')">
                                    <span id="preview-t-area" class="number-preview">0 m²</span>
                                </div>
                                <div class="input-group w-100">
                                    <label>Moneda</label>
                                    <select id="t-moneda" onchange="window.showPreview(document.getElementById('t-precio'), 'preview-precio-t', this.value)">
                                        <option value="BOB">Bolivianos (Bs)</option>
                                        <option value="USD">Dólar ($us)</option>
                                    </select>
                                </div>
                                <div class="input-group w-100">
                                    <label>Precio Base</label>
                                    <input type="number" id="t-precio" required min="0" step="0.01" oninput="window.showPreview(this, 'preview-precio-t', document.getElementById('t-moneda').value)">
                                    <span id="preview-precio-t" class="number-preview">0,00</span>
                                </div>
                            </div>

                            <div class="input-group">
                                <label><i class="fas fa-camera"></i> Fotos y Documentos (PDF)</label>
                                <input type="file" id="t-files" multiple accept="image/*,.pdf">
                                <div class="hint-box">
                                    Selecciona una foto, confirma. Luego selecciona el PDF, confirma.
                                    <small>Los archivos se acumulan abajo antes de guardar.</small>
                                </div>

                                <div class="flex gap-2" style="margin-top:10px; flex-wrap:wrap;">
                                    <button type="button" class="btn btn-g btn-sm" onclick="clearTerrenoFilePool()">
                                        <i class="fas fa-broom"></i> Limpiar archivos
                                    </button>
                                    <span id="t-files-count" style="font-weight:900; color:#334155; align-self:center;"></span>
                                </div>

                                <div id="t-files-pool" class="gallery"></div>
                            </div>

                            <div class="input-group">
                                <label>Notas Adicionales</label>
                                <textarea id="t-notas" rows="3"></textarea>
                            </div>

                            <button type="submit" class="btn btn-s w-100" style="font-size:1.05rem;">
                                <i class="fas fa-floppy-disk"></i> Guardar Terreno
                            </button>
                        </form>
                    </div>
                </div>

                <div id="view-listado" class="hidden">
                    <div class="card">
                        <div class="flex justify-between items-center" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                            <h3 style="font-weight:950; color:#0f172a;">Inventario</h3>
                            <input type="text" id="search-land" placeholder="Buscar por nombre o código..."
                                   style="padding:11px 12px; width:320px; max-width:100%; border:1px solid rgba(15,23,42,0.14); border-radius:14px;"
                                   onkeyup="renderTerrenos()">
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Archivos</th>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Superficie</th>
                                    <th>Precio</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="lista-terrenos"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-ventas" class="hidden">
                    <div class="card">
                        <div class="flex gap-2" style="margin-bottom:14px; flex-wrap:wrap;">
                            <button onclick="switchVendas('resumo')" class="btn btn-p">Cobranzas</button>
                            <button onclick="switchVendas('completos')" class="btn btn-s">Completados</button>
                            <button onclick="switchVendas('hist')" class="btn btn-g">Editar / Historial</button>
                            <button onclick="loadData()" class="btn btn-w" title="Recargar"><i class="fas fa-sync"></i></button>
                        </div>

                        <div id="tab-vendas-resumo">
                            <input type="text" id="search-venda" placeholder="Buscar cliente..."
                                   style="width:100%; padding:11px 12px; margin-bottom:12px; border:1px solid rgba(15,23,42,0.14); border-radius:14px;"
                                   onkeyup="renderVendas()">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Terreno</th>
                                        <th>Cuota</th>
                                        <th>Vencimiento</th>
                                        <th>Monto</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-cobrancas"></tbody>
                            </table>
                        </div>

                        <div id="tab-vendas-completos" class="hidden">
                            <h4 style="margin-bottom:10px; color:var(--success); font-weight:950;">Pagos Finalizados</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Terreno</th>
                                        <th>Total Pagado</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-completos"></tbody>
                            </table>
                        </div>

                        <div id="tab-vendas-hist" class="hidden">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Terreno</th>
                                        <th>Total</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-historico"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="modal-venda" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Realizar Venta</h3>
                <button class="close-modal" onclick="closeModal('modal-venda')">&times;</button>
            </div>
            <form id="form-venda">
                <input type="hidden" id="v-land-id">
                <p style="background:rgba(41,128,185,0.08); border:1px solid rgba(41,128,185,0.14); padding:12px; border-radius:14px; margin-bottom:12px; font-weight:900;">
                    Terreno: <strong id="v-land-info"></strong>
                </p>

                <div class="flex gap-2" style="flex-wrap:wrap;">
                    <div class="input-group w-100"><label>Cliente</label><input type="text" id="v-cliente" required></div>
                    <div class="input-group w-100"><label>CI/Doc</label><input type="text" id="v-ci"></div>
                </div>

                <div class="input-group">
                    <label>Documentos (Fotos/PDF)</label>
                    <!-- FIX: este input también acumula via pool -->
                    <input type="file" id="v-files" multiple accept="image/*,.pdf">
                    <div class="hint-box">
                        Selecciona archivos uno por uno (imagen, luego PDF, etc.)
                        <small>Los archivos se acumulan abajo antes de confirmar la venta.</small>
                    </div>

                    <div class="flex gap-2" style="margin-top:10px; flex-wrap:wrap;">
                        <button type="button" class="btn btn-g btn-sm" onclick="clearVendaFilePool()">
                            <i class="fas fa-broom"></i> Limpiar archivos
                        </button>
                        <span id="v-files-count" style="font-weight:900; color:#334155; align-self:center;"></span>
                    </div>

                    <div id="v-files-pool" class="gallery"></div>
                </div>

                <hr style="margin:14px 0; border:0; border-top:1px solid rgba(15,23,42,0.08);">

                <div class="flex gap-2" style="flex-wrap:wrap;">
                    <div class="input-group w-100">
                        <label>Precio Final</label>
                        <input type="number" id="v-total" required step="0.01" oninput="window.calcLive(); window.showPreview(this, 'preview-v-total', document.getElementById('lbl-moneda-venda').innerText)">
                        <span id="preview-v-total" class="number-preview">0,00</span>
                    </div>
                    <div class="input-group w-100">
                        <label>Entrada</label>
                        <input type="number" id="v-entrada" value="0" step="0.01" oninput="window.calcLive(); window.showPreview(this, 'preview-v-entrada', document.getElementById('lbl-moneda-venda').innerText)">
                        <span id="preview-v-entrada" class="number-preview">0,00</span>
                    </div>
                </div>

                <div class="flex gap-2" style="flex-wrap:wrap;">
                    <div class="input-group w-100"><label>Nº Cuotas</label><input type="number" id="v-ncuotas" value="12" oninput="window.calcLive()"></div>
                    <div class="input-group w-100"><label>1er Vencimiento</label><input type="date" id="v-data1" required></div>
                </div>

                <div class="live-calc-box">
                    <h4 style="font-weight:950; color:#0f172a;">
                        Cuota Mensual: <span id="live-result-text">0,00</span> <span id="lbl-moneda-venda" style="font-size:0.85rem"></span>
                    </h4>
                </div>

                <div class="text-right" style="margin-top:16px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
                    <button type="button" onclick="closeModal('modal-venda')" class="btn btn-g">Cancelar</button>
                    <button type="submit" class="btn btn-p">Confirmar Venta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-pagar" class="modal hidden">
        <div class="modal-content" style="max-width:420px;">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Registrar Pago</h3>
                <button class="close-modal" onclick="closeModal('modal-pagar')">&times;</button>
            </div>
            <form id="form-pagar">
                <input type="hidden" id="p-venda-id">
                <input type="hidden" id="p-cuota-idx">

                <div style="text-align:center; margin:12px 0; background:rgba(39,174,96,0.08); border:1px solid rgba(39,174,96,0.18); padding:12px; border-radius:14px;">
                    <h2 id="p-valor-display" style="color:var(--success); font-weight:950;"></h2>
                    <small style="font-weight:800; color:#334155;">Valor Original de la Cuota</small>
                </div>

                <div class="input-group">
                    <label>Monto a Pagar (Amortizable)</label>
                    <input type="number" id="p-valor-real" step="0.01" required style="font-size:1.2rem; font-weight:950; color:#166534; text-align:center;"
                           oninput="window.showPreview(this, 'preview-p-valor', document.getElementById('p-valor-display').innerText.substring(0,3))">
                    <span id="preview-p-valor" class="number-preview" style="width:100%; text-align:center; margin-top:8px;">0,00</span>
                </div>

                <div id="div-tc" class="input-group hidden" style="background:#fff3cd; padding:10px; border-radius:14px; border:1px solid rgba(243,156,18,0.35);">
                    <label>T.C. Día (Bs/USD)</label>
                    <input type="number" id="p-tc" value="6.96" step="0.01">
                </div>

                <div class="input-group">
                    <label>Fecha Pago</label>
                    <input type="date" id="p-data" required>
                </div>

                <button type="submit" class="btn btn-s w-100"><i class="fas fa-check"></i> Confirmar Recepción</button>
            </form>
        </div>
    </div>

    <div id="modal-edit" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Editar / Detalles</h3>
                <button class="close-modal" onclick="closeModal('modal-edit')">&times;</button>
            </div>
            <form id="form-edit">
                <input type="hidden" id="e-id"><input type="hidden" id="e-type">

                <div class="input-group"><label>Nombre / Cliente</label><input type="text" id="e-nome"></div>
                <div class="input-group"><label>Valor / Precio</label><input type="number" id="e-valor" step="0.01"></div>
                <div class="input-group"><label>Notas / Observaciones</label><textarea id="e-notas" rows="3"></textarea></div>

                <label style="font-weight:950; color:#0f172a;"><strong>Archivos (Fotos/PDF):</strong></label>
                <div id="e-gallery" class="gallery"></div>

                <div class="input-group" style="margin-top:14px;">
                    <label><i class="fas fa-plus"></i> Agregar archivos</label>
                    <input type="file" id="e-new-files" multiple accept="image/*,.pdf">
                </div>

                <div class="text-right" style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
                    <button type="button" onclick="closeModal('modal-edit')" class="btn btn-g">Cerrar</button>
                    <button type="submit" class="btn btn-p">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-detalles" class="modal hidden">
        <div class="modal-content" style="max-width:760px;">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Detalles Completos</h3>
                <button class="close-modal" onclick="closeModal('modal-detalles')">&times;</button>
            </div>
            <div id="detalles-contenido"></div>
        </div>
    </div>

    <script>
        const { Client, Account, Databases, Storage, ID, Query, Permission, Role } = Appwrite;
        const client = new Client();

        const PROJECT_ID = '693b19f6002a7ae91448';
        client.setEndpoint('https://nyc.cloud.appwrite.io/v1').setProject(PROJECT_ID);

        const account = new Account(client);
        const db = new Databases(client);
        const storage = new Storage(client);

        const DB_ID = 'db_main';
        const COL_TERRENOS = 'col_terrenos';
        const COL_VENDAS = 'col_vendas';
        const BUCKET_ID = 'bucket_fotos';

        let terrenos = [], vendas = [], user = null;

        // ==============================
        // FIX REGISTRO: POOL DE ARCHIVOS (acumula selecciones)
        // ==============================
        let terrenoFilePool = []; // Array<File>
        let terrenoPoolObjectUrls = new Map(); // key -> objectURL

        // ==============================
        // FIX VENTA: POOL DE ARCHIVOS (acumula selecciones)
        // ==============================
        let vendaFilePool = []; // Array<File>
        let vendaPoolObjectUrls = new Map(); // key -> objectURL

        function fileKey(f) {
            try { return `${f.name || ''}|${f.size || 0}|${f.lastModified || 0}`; }
            catch (_) { return String(Math.random()); }
        }

        function safeRevokeObjectURL(url) {
            try { if (url) URL.revokeObjectURL(url); } catch (_) {}
        }

        function isPoolPdf(file) {
            const name = String(file?.name || '').toLowerCase();
            const type = String(file?.type || '').toLowerCase();
            return type === 'application/pdf' || name.endsWith('.pdf');
        }

        function isPoolImage(file) {
            const type = String(file?.type || '').toLowerCase();
            if (type.startsWith('image/')) return true;
            const name = String(file?.name || '').toLowerCase();
            return name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.png') || name.endsWith('.webp') || name.endsWith('.gif') || name.endsWith('.heic') || name.endsWith('.heif') || name.endsWith('.bmp') || name.endsWith('.svg');
        }

        // ------------------------------
        // RENDER POOL: REGISTRO
        // ------------------------------
        function renderTerrenoFilePool() {
            const box = document.getElementById('t-files-pool');
            const counter = document.getElementById('t-files-count');
            if (!box || !counter) return;

            box.innerHTML = '';
            counter.innerText = terrenoFilePool.length ? `${terrenoFilePool.length} archivo(s) seleccionados` : '';

            terrenoFilePool.forEach((f, idx) => {
                const key = fileKey(f);
                const isPdf = isPoolPdf(f);
                const name = f?.name || 'Archivo';

                let content = '';
                if (isPdf) {
                    content = `
                        <div style="cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; height:100%; padding-top:6px;"
                             onclick="previewPoolFile(${idx})">
                            <i class="fas fa-file-pdf pdf-icon"></i>
                            <div class="file-name" title="${name}">${name}</div>
                        </div>
                    `;
                } else {
                    let url = terrenoPoolObjectUrls.get(key);
                    if (!url && isPoolImage(f)) {
                        try {
                            url = URL.createObjectURL(f);
                            terrenoPoolObjectUrls.set(key, url);
                        } catch (_) { url = ''; }
                    }
                    content = `
                        <img src="${url || ''}" alt="${name}" onclick="previewPoolFile(${idx})"
                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px;text-align:center;font-weight:900;color:#64748b;&quot;>Imagen no previsualizable</div>';">
                        <div class="file-name" title="${name}">${name}</div>
                    `;
                }

                box.innerHTML += `
                    <div class="img-preview-box" title="${name}">
                        ${content}
                        <div class="btn-del-img" onclick="event.stopPropagation(); removePoolFile(${idx})">X</div>
                    </div>
                `;
            });
        }

        window.previewPoolFile = (idx) => {
            const f = terrenoFilePool[idx];
            if (!f) return;
            try {
                const url = URL.createObjectURL(f);
                window.open(url, '_blank', 'noopener,noreferrer');
            } catch (_) {}
        };

        window.removePoolFile = (idx) => {
            const f = terrenoFilePool[idx];
            if (!f) return;
            const key = fileKey(f);
            const u = terrenoPoolObjectUrls.get(key);
            if (u) {
                safeRevokeObjectURL(u);
                terrenoPoolObjectUrls.delete(key);
            }
            terrenoFilePool.splice(idx, 1);
            renderTerrenoFilePool();
        };

        window.clearTerrenoFilePool = () => {
            try { for (const u of terrenoPoolObjectUrls.values()) safeRevokeObjectURL(u); } catch (_) {}
            terrenoPoolObjectUrls.clear();
            terrenoFilePool = [];
            renderTerrenoFilePool();
        };

        function setupTerrenoPoolInput() {
            const input = document.getElementById('t-files');
            if (!input) return;

            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;

                const existing = new Set(terrenoFilePool.map(fileKey));
                files.forEach(f => {
                    const k = fileKey(f);
                    if (!existing.has(k)) {
                        terrenoFilePool.push(f);
                        existing.add(k);
                    }
                });

                try { input.value = ''; } catch (_) {}
                renderTerrenoFilePool();
            });

            renderTerrenoFilePool();
        }

        // ------------------------------
        // RENDER POOL: VENTA
        // ------------------------------
        function renderVendaFilePool() {
            const box = document.getElementById('v-files-pool');
            const counter = document.getElementById('v-files-count');
            if (!box || !counter) return;

            box.innerHTML = '';
            counter.innerText = vendaFilePool.length ? `${vendaFilePool.length} archivo(s) seleccionados` : '';

            vendaFilePool.forEach((f, idx) => {
                const key = fileKey(f);
                const isPdf = isPoolPdf(f);
                const name = f?.name || 'Archivo';

                let content = '';
                if (isPdf) {
                    content = `
                        <div style="cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; height:100%; padding-top:6px;"
                             onclick="previewVendaPoolFile(${idx})">
                            <i class="fas fa-file-pdf pdf-icon"></i>
                            <div class="file-name" title="${name}">${name}</div>
                        </div>
                    `;
                } else {
                    let url = vendaPoolObjectUrls.get(key);
                    if (!url && isPoolImage(f)) {
                        try {
                            url = URL.createObjectURL(f);
                            vendaPoolObjectUrls.set(key, url);
                        } catch (_) { url = ''; }
                    }
                    content = `
                        <img src="${url || ''}" alt="${name}" onclick="previewVendaPoolFile(${idx})"
                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px;text-align:center;font-weight:900;color:#64748b;&quot;>Imagen no previsualizable</div>';">
                        <div class="file-name" title="${name}">${name}</div>
                    `;
                }

                box.innerHTML += `
                    <div class="img-preview-box" title="${name}">
                        ${content}
                        <div class="btn-del-img" onclick="event.stopPropagation(); removeVendaPoolFile(${idx})">X</div>
                    </div>
                `;
            });
        }

        window.previewVendaPoolFile = (idx) => {
            const f = vendaFilePool[idx];
            if (!f) return;
            try {
                const url = URL.createObjectURL(f);
                window.open(url, '_blank', 'noopener,noreferrer');
            } catch (_) {}
        };

        window.removeVendaPoolFile = (idx) => {
            const f = vendaFilePool[idx];
            if (!f) return;
            const key = fileKey(f);
            const u = vendaPoolObjectUrls.get(key);
            if (u) {
                safeRevokeObjectURL(u);
                vendaPoolObjectUrls.delete(key);
            }
            vendaFilePool.splice(idx, 1);
            renderVendaFilePool();
        };

        window.clearVendaFilePool = () => {
            try { for (const u of vendaPoolObjectUrls.values()) safeRevokeObjectURL(u); } catch (_) {}
            vendaPoolObjectUrls.clear();
            vendaFilePool = [];
            renderVendaFilePool();

            // also clear input for safety
            const input = document.getElementById('v-files');
            try { if (input) input.value = ''; } catch (_) {}
        };

        function setupVendaPoolInput() {
            const input = document.getElementById('v-files');
            if (!input) return;

            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;

                const existing = new Set(vendaFilePool.map(fileKey));
                files.forEach(f => {
                    const k = fileKey(f);
                    if (!existing.has(k)) {
                        vendaFilePool.push(f);
                        existing.add(k);
                    }
                });

                try { input.value = ''; } catch (_) {}
                renderVendaFilePool();
            });

            renderVendaFilePool();
        }

        // ------------------------------
        // HELPERS (AJUSTE DEFINITIVO)
        // ------------------------------
        function extractFileIdFromUrl(u) {
            const s = String(u || '');
            const m = s.match(/\/files\/([^\/]+)\//i);
            return m ? m[1] : null;
        }

        function getExt(name) {
            const s = String(name || '').toLowerCase().trim();
            const i = s.lastIndexOf('.');
            if (i === -1) return '';
            return s.slice(i + 1);
        }

        function isPdfByNameOrUrl(v) {
            const s = String(v || '').toLowerCase();
            return s.endsWith('.pdf') || s.includes('application/pdf');
        }

        function isImageByNameOrMime(file) {
            if (!file) return false;
            const name = (typeof file === 'string') ? file : (file.name || file.filename || '');
            const mime = (typeof file === 'object' && file) ? (file.mime || file.type || '') : '';
            const ext = getExt(name);
            if (mime && String(mime).toLowerCase().startsWith('image/')) return true;
            if (['jpg','jpeg','png','webp','gif','bmp','svg','heic','heif'].includes(ext)) return true;
            return false;
        }

        function normalizeFotos(fotos) {
            if (!fotos) return [];
            const arr = Array.isArray(fotos) ? fotos : [fotos];

            return arr
                .map((f) => {
                    if (typeof f === 'string') {
                        const id = extractFileIdFromUrl(f);
                        const name = 'Archivo';
                        return {
                            id: id || null,
                            url: String(f || ''),
                            name,
                            mime: '',
                            ext: getExt(f),
                            isPdf: isPdfByNameOrUrl(f),
                            createdAt: null
                        };
                    }

                    if (typeof f === 'object' && f) {
                        const rawUrl = (typeof f.url === 'string')
                            ? f.url
                            : (f.url && f.url.href ? f.url.href : (f.url ? String(f.url) : ''));

                        const id = f.id || f.fileId || extractFileIdFromUrl(rawUrl) || null;
                        const name = f.name || f.filename || 'Archivo';
                        const mime = f.mime || f.type || '';
                        const ext = f.ext || getExt(name) || getExt(rawUrl);

                        const isPdf = (typeof f.isPdf === 'boolean')
                            ? f.isPdf
                            : (String(mime).toLowerCase() === 'application/pdf' || ext === 'pdf' || isPdfByNameOrUrl(name) || isPdfByNameOrUrl(rawUrl));

                        return {
                            ...f,
                            id,
                            url: String(rawUrl || ''),
                            name,
                            mime: String(mime || ''),
                            ext: String(ext || ''),
                            isPdf,
                            createdAt: f.createdAt || f.created_at || null
                        };
                    }

                    return null;
                })
                .filter(Boolean);
        }

        function getFileUrl(file) {
            if (!file) return '';
            const f = (typeof file === 'string') ? { url: file } : file;

            const id = f.id || f.fileId;
            if (id) {
                const view = storage.getFileView(BUCKET_ID, id);
                const url = (typeof view === 'string') ? view : (view && view.href ? view.href : String(view));
                return String(url || '');
            }

            const u = (typeof f.url === 'string') ? f.url : (f.url && f.url.href ? f.url.href : (f.url ? String(f.url) : ''));
            return String(u || '');
        }

        function getFileName(file) {
            if (!file) return 'Archivo';
            if (typeof file === 'string') return 'Archivo';
            return file.name || file.filename || 'Archivo';
        }

        function isPdfFile(file) {
            if (!file) return false;
            if (typeof file === 'string') return isPdfByNameOrUrl(file);
            if (typeof file.isPdf === 'boolean') return file.isPdf;
            const mime = (file.mime || file.type || '');
            const name = (file.name || file.filename || '');
            const ext = file.ext || getExt(name);
            if (String(mime).toLowerCase() === 'application/pdf') return true;
            if (String(ext).toLowerCase() === 'pdf') return true;
            return isPdfByNameOrUrl(name) || isPdfByNameOrUrl(file.url);
        }

        window.openFile = (url) => {
            const u = String(url || '');
            if (!u) return;
            window.open(u, '_blank', 'noopener,noreferrer');
        };

        // ------------------------------
        // Permisos de Seguridad
        // ------------------------------
        function getPermissions() {
            if (!user) return [];
            return [
                Permission.read(Role.user(user.$id)),
                Permission.update(Role.user(user.$id)),
                Permission.delete(Role.user(user.$id))
            ];
        }

        // ------------------------------
        // AUTH
        // ------------------------------
        async function checkSession() {
            try {
                user = await account.get();
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-email-display').innerText = user.email;
                initDateFilters();
                setupTerrenoPoolInput();
                setupVendaPoolInput(); // <-- FIX: activa el pool en venta
                loadData();
            } catch (e) {
                console.log("Login necesario");
            }
        }
        checkSession();

        function initDateFilters() {
            const date = new Date();
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filter-date-start').value = firstDay;
            document.getElementById('filter-date-end').value = today;
        }

        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await account.createEmailPasswordSession(email, pass);
                checkSession();
            } catch (error) {
                if (error.message && error.message.includes('session is active')) { checkSession(); return; }
                try {
                    await account.create(ID.unique(), email, pass);
                    await account.createEmailPasswordSession(email, pass);
                    checkSession();
                } catch (ce) {
                    document.getElementById('login-msg').innerText = "Error: " + (error.message || String(error));
                }
            }
        });

        window.logout = async () => {
            await account.deleteSession('current');
            location.reload();
        };

        // ------------------------------
        // DATA
        // ------------------------------
        async function loadData() {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const tRes = await db.listDocuments(DB_ID, COL_TERRENOS, [Query.limit(100)]);
                terrenos = tRes.documents.map(d => {
                    const parsed = JSON.parse(d.dados);
                    parsed.fotos = normalizeFotos(parsed.fotos);
                    return { $id: d.$id, ...parsed };
                });

                const vRes = await db.listDocuments(DB_ID, COL_VENDAS, [Query.limit(100)]);
                vendas = vRes.documents.map(d => {
                    const parsed = JSON.parse(d.dados);
                    parsed.fotos = normalizeFotos(parsed.fotos);
                    return { $id: d.$id, ...parsed };
                });

                renderTerrenos();
                renderVendas();
                updateDashboard();
            } catch (e) {
                console.error(e);
            }
            document.getElementById('loader').classList.add('hidden');
        }

        // ------------------------------
        // UPLOAD (acepta input o Array<File>)
        // ------------------------------
        async function uploadFiles(source) {
            let fileList = [];

            if (Array.isArray(source)) {
                fileList = source;
            } else if (source && source.files) {
                fileList = Array.from(source.files || []);
            }

            if (!fileList.length) return [];

            let filesData = [];
            for (let i = 0; i < fileList.length; i++) {
                try {
                    const file = fileList[i];
                    const res = await storage.createFile(BUCKET_ID, ID.unique(), file, getPermissions());

                    const isPdf = (file.type === 'application/pdf') || String(file.name || '').toLowerCase().endsWith('.pdf');
                    filesData.push({
                        id: res.$id,
                        name: file.name,
                        mime: file.type || '',
                        ext: getExt(file.name),
                        size: file.size || 0,
                        isPdf: isPdf,
                        createdAt: new Date().toISOString()
                    });
                } catch (e) {
                    console.error("Upload error", e);
                    const msg =
                        (e && e.message) ? e.message :
                        (typeof e === "string") ? e :
                        JSON.stringify(e);
                    alert("Error subiendo archivo.\n\n" + msg);
                }
            }

            try { if (source && source.value !== undefined) source.value = ''; } catch (_) {}
            return filesData;
        }

        // ------------------------------
        // TERRENOS (usa pool acumulado)
        // ------------------------------
        document.getElementById('form-terreno').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');

            const uploaded = await uploadFiles(terrenoFilePool);

            const data = {
                codigo: document.getElementById('t-codigo').value,
                nome: document.getElementById('t-nome').value,
                area: parseFloat(document.getElementById('t-area').value),
                moneda: document.getElementById('t-moneda').value,
                precio: parseFloat(document.getElementById('t-precio').value),
                notas: document.getElementById('t-notas').value,
                fotos: normalizeFotos(uploaded),
                estado: 'Disponible',
                habilitado: true
            };

            await db.createDocument(DB_ID, COL_TERRENOS, ID.unique(), { dados: JSON.stringify(data) }, getPermissions());

            document.getElementById('form-terreno').reset();
            clearTerrenoFilePool();

            nav('listado');
            loadData();
        });

        function renderTerrenos() {
            const b = document.getElementById('lista-terrenos');
            b.innerHTML = '';
            const f = document.getElementById('search-land').value.toLowerCase();

            terrenos.forEach(t => {
                if (!t.nome.toLowerCase().includes(f) && !t.codigo.toLowerCase().includes(f)) return;

                const files = normalizeFotos(t.fotos);
                const fileCount = files.length;

                const images = files.filter(x => !isPdfFile(x) && isImageByNameOrMime(x));
                const cover = images[0] || files.find(x => !isPdfFile(x)) || files[0] || null;

                let thumbInner = `<div style="width:62px;height:62px;background:rgba(15,23,42,0.06);border-radius:12px;border:1px dashed rgba(15,23,42,0.14);"></div>`;
                if (cover) {
                    const url = getFileUrl(cover);
                    const pdf = isPdfFile(cover);
                    if (pdf) {
                        thumbInner = `<div class="thumb-pdf"><i class="fas fa-file-pdf"></i></div>`;
                    } else {
                        thumbInner = `<img src="${url}" class="thumb-small" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=&quot;thumb-pdf&quot;><i class=&quot;fas fa-image&quot;></i></div>';">`;
                    }
                }

                const badge = (fileCount > 1) ? `<span class="file-count">+${fileCount}</span>` : '';
                const imgHtml = `<div class="thumb-container" onclick="verDetalles('${t.$id}', 'land')">${thumbInner}${badge}</div>`;

                let btn = t.estado === 'Disponible'
                    ? `<button class="btn btn-p" style="padding:7px 10px; border-radius:12px;" onclick="openVenda('${t.$id}')">Vender</button>`
                    : `<span class="status-badge status-vendido"><i class="fas fa-lock"></i> Vendido</span>`;

                b.innerHTML += `<tr>
                    <td>${imgHtml}</td>
                    <td><strong>${t.codigo}</strong></td>
                    <td>${t.nome}</td>
                    <td>${new Intl.NumberFormat('es-BO').format(t.area)} m²</td>
                    <td>${t.moneda} ${new Intl.NumberFormat('es-BO').format(t.precio)}</td>
                    <td>${t.estado}</td>
                    <td style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-g btn-sm" onclick="openEdit('${t.$id}', 'land')"><i class="fas fa-edit"></i></button>
                        ${btn}
                        <button class="btn btn-d btn-sm" onclick="deleteItem('${t.$id}', 'land')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        // (continua en la PARTE 2/2)
        
                // ------------------------------
        // VENTAS (FIX: usa pool acumulado también)
        // ------------------------------
        window.openVenda = (id) => {
            const t = terrenos.find(x => x.$id === id);

            // FIX: limpiar pool cada vez que abre el modal de venta
            clearVendaFilePool();

            document.getElementById('v-land-id').value = id;
            document.getElementById('v-land-info').innerText = `${t.codigo} - ${t.nome}`;
            document.getElementById('lbl-moneda-venda').innerText = t.moneda;
            document.getElementById('v-total').value = t.precio;
            document.getElementById('v-data1').value = new Date().toISOString().split('T')[0];
            window.calcLive();
            window.showPreview(document.getElementById('v-total'), 'preview-v-total', t.moneda);
            window.showPreview(document.getElementById('v-entrada'), 'preview-v-entrada', t.moneda);

            // refresh view pool
            renderVendaFilePool();

            document.getElementById('modal-venda').classList.remove('hidden');
        };

        document.getElementById('form-venda').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');

            const tId = document.getElementById('v-land-id').value;
            const terreno = terrenos.find(x => x.$id === tId);

            // FIX: subir TODO lo acumulado en el pool de venta
            const uploaded = await uploadFiles(vendaFilePool);

            const total = parseFloat(document.getElementById('v-total').value);
            const ent = parseFloat(document.getElementById('v-entrada').value);
            const qtd = parseInt(document.getElementById('v-ncuotas').value);
            const data1 = new Date(document.getElementById('v-data1').value);
            const today = new Date().toISOString().split('T')[0];

            let cuotas = [];
            for (let i = 0; i < qtd; i++) {
                let dt = new Date(data1);
                dt.setMonth(dt.getMonth() + i);
                cuotas.push({
                    n: i + 1,
                    valor: (total - ent) / qtd,
                    venc: dt.toISOString().split('T')[0],
                    pago: false
                });
            }

            const venda = {
                cliente: document.getElementById('v-cliente').value,
                ci: document.getElementById('v-ci').value,
                fotos: normalizeFotos(uploaded),
                landId: tId,
                landNome: terreno.nome,
                moneda: terreno.moneda,
                total: total,
                entrada: ent,
                fecha_entrada: today,
                cuotas: cuotas,
                data: new Date().toISOString()
            };

            await db.createDocument(DB_ID, COL_VENDAS, ID.unique(), { dados: JSON.stringify(venda) }, getPermissions());

            terreno.estado = 'Vendido';
            terreno.fotos = normalizeFotos(terreno.fotos);
            await db.updateDocument(DB_ID, COL_TERRENOS, tId, { dados: JSON.stringify(terreno) });

            // FIX: limpiar pool cuando termina
            clearVendaFilePool();

            closeModal('modal-venda');
            loadData();
        });

        function renderVendas() {
            const l1 = document.getElementById('lista-cobrancas');
            const l2 = document.getElementById('lista-historico');
            const l3 = document.getElementById('lista-completos');
            l1.innerHTML = ''; l2.innerHTML = ''; l3.innerHTML = '';
            const f = document.getElementById('search-venda').value.toLowerCase();

            vendas.forEach(v => {
                if (!v.cliente.toLowerCase().includes(f)) return;

                l2.innerHTML += `<tr>
                    <td>${v.$id.substring(0,5)}</td>
                    <td>${v.cliente}</td>
                    <td>${v.landNome}</td>
                    <td>${v.moneda} ${new Intl.NumberFormat('es-BO').format(v.total)}</td>
                    <td style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-w btn-sm" onclick="openEdit('${v.$id}', 'sale')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-d btn-sm" onclick="deleteItem('${v.$id}', 'sale')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;

                let pendente = v.cuotas.find(c => !c.pago);
                if (!pendente) {
                    l3.innerHTML += `<tr>
                        <td>${v.cliente}</td>
                        <td>${v.landNome}</td>
                        <td style="color:var(--success);font-weight:950">${v.moneda} ${new Intl.NumberFormat('es-BO').format(v.total)}</td>
                        <td><span class="status-badge status-disponible"><i class="fas fa-check"></i> PAGADO</span></td>
                        <td><button class="btn btn-g btn-sm" onclick="openEdit('${v.$id}', 'sale')">Ver</button></td>
                    </tr>`;
                } else {
                    let cor = new Date(pendente.venc) < new Date() ? 'red' : '#0f172a';
                    l1.innerHTML += `<tr>
                        <td><strong>${v.cliente}</strong></td>
                        <td>${v.landNome}</td>
                        <td>${pendente.n}/${v.cuotas.length}</td>
                        <td style="color:${cor};font-weight:950">${pendente.venc}</td>
                        <td>${v.moneda} ${new Intl.NumberFormat('es-BO').format(pendente.valor)}</td>
                        <td><button class="btn btn-s btn-sm" onclick="openPagar('${v.$id}', ${pendente.n})">Cobrar</button></td>
                    </tr>`;
                }
            });
        }

        // ------------------------------
        // PAGOS
        // ------------------------------
        window.openPagar = (vId, n) => {
            const v = vendas.find(x => x.$id === vId);
            const c = v.cuotas.find(x => x.n === n);
            document.getElementById('p-venda-id').value = vId;
            document.getElementById('p-cuota-idx').value = v.cuotas.indexOf(c);
            document.getElementById('p-valor-display').innerText = v.moneda + ' ' + new Intl.NumberFormat('es-BO').format(c.valor);
            document.getElementById('p-valor-real').value = c.valor.toFixed(2);
            document.getElementById('p-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('div-tc').classList.toggle('hidden', v.moneda !== 'USD');
            window.showPreview(document.getElementById('p-valor-real'), 'preview-p-valor', v.moneda);
            document.getElementById('modal-pagar').classList.remove('hidden');
        };

        document.getElementById('form-pagar').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            const vId = document.getElementById('p-venda-id').value;
            const idx = parseInt(document.getElementById('p-cuota-idx').value);
            const pago = parseFloat(document.getElementById('p-valor-real').value);
            const tc = parseFloat(document.getElementById('p-tc').value);
            const dataPago = document.getElementById('p-data').value;

            const v = vendas.find(x => x.$id === vId);
            let saldo = pago, i = idx;

            while (saldo > 0.1 && i < v.cuotas.length) {
                let c = v.cuotas[i];
                if (c.pago) { i++; continue; }
                if (saldo >= c.valor) {
                    saldo -= c.valor;
                    c.pago = true;
                    c.valor_pago = c.valor;
                    c.tc = tc;
                    c.data_pago = dataPago;
                } else {
                    c.valor -= saldo;
                    saldo = 0;
                }
                i++;
            }

            await db.updateDocument(DB_ID, COL_VENDAS, vId, { dados: JSON.stringify(v) });
            closeModal('modal-pagar');
            loadData();
        });

        // ------------------------------
        // EDICIÓN Y DETALLES
        // ------------------------------
        window.openEdit = (id, type) => {
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            d.fotos = normalizeFotos(d.fotos);

            document.getElementById('e-id').value = id;
            document.getElementById('e-type').value = type;
            document.getElementById('e-nome').value = (type === 'land') ? d.nome : d.cliente;
            document.getElementById('e-valor').value = (type === 'land') ? d.precio : d.total;
            document.getElementById('e-notas').value = (type === 'land') ? (d.notas || '') : '';

            const g = document.getElementById('e-gallery');
            g.innerHTML = '';

            d.fotos.forEach((u, i) => {
                const url = getFileUrl(u);
                const pdf = isPdfFile(u);
                const name = getFileName(u);

                let content = '';
                if (pdf) {
                    content = `
                        <a href="${url}" target="_blank" rel="noopener noreferrer"
                           style="text-decoration:none; color:inherit; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding-top:6px;">
                            <i class="fas fa-file-pdf pdf-icon"></i>
                            <div class="file-name" title="${name}">${name}</div>
                        </a>
                    `;
                } else {
                    content = `
                        <a href="${url}" target="_blank" rel="noopener noreferrer" style="width:100%; height:100%; display:block;">
                            <img src="${url}" style="width:100%;height:100%;object-fit:cover;cursor:pointer;">
                        </a>
                        <div class="file-name" title="${name}">${name}</div>
                    `;
                }

                g.innerHTML += `<div class="img-preview-box">
                    ${content}
                    <div class="btn-del-img" onclick="event.stopPropagation(); remFoto('${id}', '${type}', ${i})">X</div>
                </div>`;
            });

            document.getElementById('modal-edit').classList.remove('hidden');
        };

        window.remFoto = async (id, type, i) => {
            if (!confirm("¿Borrar archivo?")) return;
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            d.fotos = normalizeFotos(d.fotos);
            d.fotos.splice(i, 1);
            await db.updateDocument(DB_ID, (type === 'land' ? COL_TERRENOS : COL_VENDAS), id, { dados: JSON.stringify(d) });
            closeModal('modal-edit');
            loadData();
        };

        document.getElementById('form-edit').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            const id = document.getElementById('e-id').value, type = document.getElementById('e-type').value;
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);

            d.fotos = normalizeFotos(d.fotos);

            const newFiles = await uploadFiles(document.getElementById('e-new-files'));
            d.fotos = [...d.fotos, ...normalizeFotos(newFiles)];

            if (type === 'land') {
                d.nome = document.getElementById('e-nome').value;
                d.precio = parseFloat(document.getElementById('e-valor').value);
                d.notas = document.getElementById('e-notas').value;
            } else {
                d.cliente = document.getElementById('e-nome').value;
            }

            await db.updateDocument(DB_ID, (type === 'land' ? COL_TERRENOS : COL_VENDAS), id, { dados: JSON.stringify(d) });
            closeModal('modal-edit');
            loadData();
        });

        window.deleteItem = async (id, type) => {
            if (!confirm("¿Eliminar?")) return;
            document.getElementById('loader').classList.remove('hidden');

            if (type === 'sale') {
                const v = vendas.find(x => x.$id === id);
                const t = terrenos.find(x => x.$id === v.landId);
                if (t) {
                    t.estado = 'Disponible';
                    t.fotos = normalizeFotos(t.fotos);
                    await db.updateDocument(DB_ID, COL_TERRENOS, t.$id, { dados: JSON.stringify(t) });
                }
            }

            await db.deleteDocument(DB_ID, (type === 'land' ? COL_TERRENOS : COL_VENDAS), id);
            loadData();
        };

        window.verDetalles = (id, type) => {
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            d.fotos = normalizeFotos(d.fotos);

            let mediaHtml = '';
            d.fotos.forEach(u => {
                const url = getFileUrl(u);
                const pdf = isPdfFile(u);
                const name = getFileName(u);

                if (pdf) {
                    mediaHtml += `<a href="${url}" target="_blank" rel="noopener noreferrer" class="doc-link">
                        <i class="fas fa-file-pdf" style="color:var(--danger);font-size:1.2rem;"></i>
                        <span>${name}</span>
                    </a>`;
                } else {
                    mediaHtml += `<a href="${url}" target="_blank" rel="noopener noreferrer" style="display:block;">
                        <img src="${url}" class="img-full">
                    </a>`;
                }
            });

            const c = document.getElementById('detalles-contenido');
            c.innerHTML = (type === 'land')
                ? `<h2 style="font-weight:950; color:#0f172a; margin-bottom:8px;">${d.nome}</h2>
                   <p style="font-weight:900; color:#334155;"><strong>Precio:</strong> ${d.moneda} ${new Intl.NumberFormat('es-BO').format(d.precio)}</p>
                   <p style="font-weight:900; color:#334155;"><strong>Superficie:</strong> ${new Intl.NumberFormat('es-BO').format(d.area)} m²</p>
                   <p style="font-weight:900; color:#334155;"><strong>Estado:</strong> ${d.estado}</p>
                   <p style="color:#334155; margin-top:6px;">${d.notas || ''}</p>
                   <hr style="margin:12px 0; border:0; border-top:1px solid rgba(15,23,42,0.08);">${mediaHtml}`
                : `<h2 style="font-weight:950; color:#0f172a; margin-bottom:8px;">${d.cliente}</h2>
                   <p style="font-weight:900; color:#334155;"><strong>CI:</strong> ${d.ci || ''}</p>
                   <hr style="margin:12px 0; border:0; border-top:1px solid rgba(15,23,42,0.08);">${mediaHtml}`;

            document.getElementById('modal-detalles').classList.remove('hidden');
        };

        // ------------------------------
        // UTILS
        // ------------------------------
        window.nav = (v) => {
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-' + v).classList.remove('hidden');
            document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + v).classList.add('active');

            const titles = { resumen: "Resumen General", registro: "Registrar Terreno", listado: "Inventario", ventas: "Ventas" };
            document.getElementById('page-title').innerText = titles[v] || "Panel";

            if (v === 'listado') renderTerrenos();
            if (v === 'ventas') renderVendas();
        };

        window.switchVendas = (t) => {
            document.getElementById('tab-vendas-resumo').classList.add('hidden');
            document.getElementById('tab-vendas-hist').classList.add('hidden');
            document.getElementById('tab-vendas-completos').classList.add('hidden');
            document.getElementById('tab-vendas-' + t).classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.showPreview = (i, id, type) => {
            let val = parseFloat(i.value);
            if (isNaN(val)) val = 0;
            let res = '';
            if (type === 'm²') res = new Intl.NumberFormat('es-BO', { minimumFractionDigits: 2 }).format(val) + ' m²';
            else res = new Intl.NumberFormat('es-BO', { style: 'currency', currency: (type === 'Ref' || type.length > 3) ? 'BOB' : type }).format(val);
            if (type === 'Ref') res = res.replace('Bs', '');
            document.getElementById(id).innerText = res;
        };

        window.calcLive = () => {
            const p = parseFloat(document.getElementById('v-total').value) || 0,
                  e = parseFloat(document.getElementById('v-entrada').value) || 0,
                  c = parseInt(document.getElementById('v-ncuotas').value) || 1;
            const m = document.getElementById('lbl-moneda-venda').innerText || 'BOB';
            document.getElementById('live-result-text').innerText =
                new Intl.NumberFormat('es-BO', { style: 'currency', currency: m }).format((p - e) / c);
        };

        function updateDashboard() {
            document.getElementById('kpi-total').innerText = terrenos.length;
            document.getElementById('kpi-disp').innerText = terrenos.filter(t => t.estado === 'Disponible').length;
            document.getElementById('kpi-vendidos').innerText = terrenos.filter(t => t.estado === 'Vendido').length;

            const s = document.getElementById('filter-date-start').value,
                  e = document.getElementById('filter-date-end').value;

            const start = s ? new Date(s) : new Date(0),
                  end = e ? new Date(e) : new Date(8640000000000000);
            end.setHours(23, 59, 59, 999);

            let rec = 0;
            vendas.forEach(v => {
                let dEnt = v.fecha_entrada ? new Date(v.fecha_entrada) : new Date(v.data);
                if (dEnt >= start && dEnt <= end) {
                    let pg = v.entrada;
                    if (v.moneda === 'USD') pg *= 6.96;
                    rec += pg;
                }
                v.cuotas.forEach(c => {
                    if (c.pago && c.data_pago) {
                        let dC = new Date(c.data_pago);
                        if (dC >= start && dC <= end) {
                            let val = c.valor_pago || c.valor;
                            if (v.moneda === 'USD') val *= (c.tc || 6.96);
                            rec += val;
                        }
                    }
                });
            });

            document.getElementById('kpi-money').innerText = "Bs " + rec.toLocaleString('es-BO', { minimumFractionDigits: 2 });

            const ctx1 = document.getElementById('chart-fin').getContext('2d');
            if (window.ch1) window.ch1.destroy();
            window.ch1 = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Disp', 'Vend'],
                    datasets: [{
                        data: [
                            terrenos.filter(t => t.estado === 'Disponible').length,
                            terrenos.filter(t => t.estado === 'Vendido').length
                        ],
                        backgroundColor: ['#27ae60', '#7f8c8d']
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>