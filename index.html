<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inmobiliario - Corvac</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- ESTILOS VISUALES --- */
        :root {
            --primary: #2c3e50;    /* Azul Oscuro */
            --secondary: #34495e;  /* Azul Petróleo */
            --accent: #2980b9;     /* Azul Brillante */
            --success: #27ae60;    /* Verde */
            --warning: #f39c12;    /* Naranja */
            --danger: #c0392b;     /* Rojo */
            --light: #f4f6f9;      /* Fondo */
            --white: #ffffff;      /* Blanco */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { background-color: var(--light); color: #333; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Utilidades */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .gap-2 { gap: 10px; }
        .w-100 { width: 100%; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }

        /* Botones */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: #fff; transition: 0.2s; font-size: 0.9rem; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-p { background: var(--accent); } 
        .btn-s { background: var(--success); } 
        .btn-d { background: var(--danger); } 
        .btn-w { background: var(--warning); } 
        .btn-g { background: #7f8c8d; }

        /* Login */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 2.5rem; border-radius: 10px; width: 400px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.3); }
        
        /* Inputs */
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .input-group input:focus { border-color: var(--accent); outline: none; }
        
        /* Preview de Dinero/Numeros */
        .number-preview { font-size: 0.9rem; color: var(--success); font-weight: bold; margin-top: 4px; display: inline-block; background: #e8f8f5; padding: 2px 8px; border-radius: 4px; border: 1px solid #c3e6cb; }

        /* Layout */
        #app-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        aside h3 { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu button { width: 100%; padding: 15px 20px; background: none; border: none; color: #ccc; text-align: left; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .menu button:hover { background: var(--secondary); color: white; }
        .menu button.active { background: var(--secondary); color: white; border-left: 5px solid var(--accent); font-weight: bold; }
        .menu i { margin-right: 10px; width: 25px; text-align: center; }

        /* Main Content */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--light); }
        header { background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #content { flex: 1; padding: 25px; overflow-y: auto; }

        /* Cards & Tables */
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: var(--primary); font-weight: bold; }
        tr:hover { background: #f9f9f9; }

        /* Badges */
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .status-disponible { background: #e8f8f5; color: #27ae60; border: 1px solid #27ae60; }
        .status-vendido { background: #eaeded; color: #7f8c8d; border: 1px solid #7f8c8d; }

        /* Galeria */
        .gallery { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .img-preview-box { position: relative; width: 90px; height: 90px; border: 1px solid #ddd; background:#fff; border-radius: 4px; overflow: hidden; }
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .btn-del-img { position: absolute; top: 0; right: 0; background: rgba(200,0,0,0.8); color: white; width: 25px; height: 25px; text-align: center; cursor: pointer; font-weight: bold; }
        
        .thumb-small { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; background:#fff; transition: transform 0.2s; }
        .thumb-small:hover { transform: scale(3.5); position: relative; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .img-full { width: 100%; max-height: 450px; object-fit: contain; background: #fafafa; border: 1px solid #eee; margin-bottom: 15px; }

        /* Loader */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 3000; display: flex; justify-content: center; align-items: center; flex-direction: column; color: var(--accent); }
        
        /* Modals */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index: 2500; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-modal { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #777; }

        .chart-container { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }
        .live-calc-box { background: #e0f2f1; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: center; border: 1px solid #80cbc4; }
        
        /* Filtros de Fecha */
        .date-filters { display: flex; gap: 10px; align-items: center; background: #fff; padding: 10px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .date-filters input { border: 1px solid #ccc; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top:15px; font-weight:bold;">Cargando sistema...</p>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:10px;">Corvac Inmobiliaria</h2>
            <p style="color:#666; margin-bottom:25px;">Sistema Seguro & Privado</p>
            <form id="form-login">
                <div class="input-group">
                    <label>Correo Electrónico</label>
                    <input type="email" id="email" required placeholder="tu@empresa.com">
                </div>
                <div class="input-group">
                    <label>Contraseña</label>
                    <input type="password" id="password" required placeholder="******">
                </div>
                <button type="submit" class="btn btn-p w-100">Ingresar</button>
                <p id="login-msg" style="color:var(--danger); margin-top:15px; font-weight:bold;"></p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <aside>
            <h3><i class="fas fa-city"></i> Corvac Panel</h3>
            <div class="menu">
                <button id="btn-resumen" onclick="nav('resumen')" class="active"><i class="fas fa-chart-pie"></i> Resumen</button>
                <button id="btn-registro" onclick="nav('registro')"><i class="fas fa-plus-circle"></i> Registrar Terreno</button>
                <button id="btn-listado" onclick="nav('listado')"><i class="fas fa-list"></i> Inventario</button>
                <button id="btn-ventas" onclick="nav('ventas')"><i class="fas fa-file-invoice-dollar"></i> Ventas</button>
            </div>
        </aside>

        <main>
            <header>
                <h3 id="page-title" style="color:var(--primary)">Resumen General</h3>
                <div class="flex" style="align-items:center; gap:15px;">
                    <span id="user-email-display" style="font-weight:600; color:#555;"></span>
                    <button onclick="logout()" class="btn btn-g btn-sm"><i class="fas fa-sign-out-alt"></i> Salir</button>
                </div>
            </header>
            
            <div id="content">
                
                <div id="view-resumen">
                    <div class="date-filters">
                        <label><i class="fas fa-calendar-alt"></i> Desde:</label>
                        <input type="date" id="filter-date-start" onchange="updateDashboard()">
                        <label>Hasta:</label>
                        <input type="date" id="filter-date-end" onchange="updateDashboard()">
                        <span style="font-size:0.8rem; color:#666; margin-left:10px;">(Filtra lo recaudado)</span>
                    </div>

                    <div class="flex gap-2" style="margin-bottom:25px; flex-wrap:wrap;">
                        <div class="card" style="flex:1; text-align:center; min-width:200px;">
                            <h4 style="color:#777">Total Terrenos</h4>
                            <h1 id="kpi-total" style="font-size:2.5rem; margin-top:10px;">0</h1>
                        </div>
                        <div class="card" style="flex:1; text-align:center; min-width:200px;">
                            <h4 style="color:#777">Disponibles</h4>
                            <h1 id="kpi-disp" style="font-size:2.5rem; margin-top:10px; color:var(--success)">0</h1>
                        </div>
                        <div class="card" style="flex:1; text-align:center; min-width:200px;">
                            <h4 style="color:#777">Vendidos</h4>
                            <h1 id="kpi-vendidos" style="font-size:2.5rem; margin-top:10px; color:#7f8c8d">0</h1>
                        </div>
                        <div class="card" style="flex:1; text-align:center; min-width:200px; border-bottom: 4px solid var(--accent);">
                            <h4 style="color:var(--accent)">Recaudado (Ref. Bs)</h4>
                            <h1 id="kpi-money" style="font-size:2.5rem; margin-top:10px; color:var(--primary)">0</h1>
                            <small id="date-range-display" style="color:#888"></small>
                        </div>
                    </div>
                    <div class="card">
                        <div class="chart-container">
                            <canvas id="chart-fin"></canvas>
                        </div>
                    </div>
                </div>

                <div id="view-registro" class="hidden">
                    <div class="card">
                        <h3>Registrar Nuevo Terreno</h3>
                        <form id="form-terreno" style="margin-top:20px;">
                            <div class="flex gap-2">
                                <div class="input-group w-100"><label>Código Interno</label><input type="text" id="t-codigo" required placeholder="Ej: L-01"></div>
                                <div class="input-group w-100"><label>Nombre / Ubicación</label><input type="text" id="t-nome" required></div>
                            </div>
                            <div class="flex gap-2">
                                <div class="input-group w-100">
                                    <label>Superficie (m²)</label>
                                    <input type="number" id="t-area" oninput="window.showPreview(this, 'preview-t-area', 'm²')">
                                    <span id="preview-t-area" class="number-preview">0 m²</span>
                                </div>
                                <div class="input-group w-100">
                                    <label>Moneda</label>
                                    <select id="t-moneda" onchange="window.showPreview(document.getElementById('t-precio'), 'preview-precio-t', this.value)">
                                        <option value="BOB">Bolivianos (Bs)</option>
                                        <option value="USD">Dólar ($us)</option>
                                    </select>
                                </div>
                                <div class="input-group w-100">
                                    <label>Precio Base</label>
                                    <input type="number" id="t-precio" required min="0" step="0.01" oninput="window.showPreview(this, 'preview-precio-t', document.getElementById('t-moneda').value)">
                                    <span id="preview-precio-t" class="number-preview">0,00</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label><i class="fas fa-camera"></i> Fotos y Documentos (PDF)</label>
                                <input type="file" id="t-files" multiple accept="image/*, .pdf">
                            </div>
                            <div class="input-group"><label>Notas Adicionales</label><textarea id="t-notas" rows="3"></textarea></div>
                            <button type="submit" class="btn btn-s w-100" style="font-size:1.1rem;">Guardar Terreno</button>
                        </form>
                    </div>
                </div>

                <div id="view-listado" class="hidden">
                    <div class="card">
                        <div class="flex justify-between items-center" style="margin-bottom:15px;">
                            <h3>Inventario</h3>
                            <input type="text" id="search-land" placeholder="Buscar por nombre o código..." style="padding:10px; width:300px; border:1px solid #ddd; border-radius:5px;" onkeyup="renderTerrenos()">
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Superficie</th> <th>Precio</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="lista-terrenos"></tbody>
                        </table>
                    </div>
                </div>

                <div id="view-ventas" class="hidden">
                    <div class="card">
                        <div class="flex gap-2" style="margin-bottom:20px;">
                            <button onclick="switchVendas('resumo')" class="btn btn-p"><i class="fas fa-file-invoice-dollar"></i> Cobranzas</button>
                            <button onclick="switchVendas('completos')" class="btn btn-s"><i class="fas fa-check-circle"></i> Completados</button>
                            <button onclick="switchVendas('hist')" class="btn btn-g"><i class="fas fa-history"></i> Editar / Historial</button>
                            <button onclick="loadData()" class="btn btn-w" title="Recargar"><i class="fas fa-sync"></i></button>
                        </div>

                        <div id="tab-vendas-resumo">
                            <input type="text" id="search-venda" placeholder="Buscar cliente..." style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd;" onkeyup="renderVendas()">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Terreno</th>
                                        <th>Cuota</th>
                                        <th>Vencimiento</th>
                                        <th>Monto</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-cobrancas"></tbody>
                            </table>
                        </div>

                        <div id="tab-vendas-completos" class="hidden">
                            <h4 style="margin-bottom:10px; color:var(--success)">Clientes que finalizaron sus pagos</h4>
                            <table>
                                <thead><tr><th>Cliente</th><th>Terreno</th><th>Total Pagado</th><th>Estado</th><th>Acciones</th></tr></thead>
                                <tbody id="lista-completos"></tbody>
                            </table>
                        </div>

                        <div id="tab-vendas-hist" class="hidden">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Terreno</th>
                                        <th>Total</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-historico"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="modal-venda" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header"><h3>Realizar Venta</h3><button class="close-modal" onclick="closeModal('modal-venda')">&times;</button></div>
            <form id="form-venda">
                <input type="hidden" id="v-land-id">
                <p style="background:#eef; padding:15px; border-radius:5px; margin-bottom:15px; color:#444;">Terreno: <strong id="v-land-info"></strong></p>
                <div class="flex gap-2">
                    <div class="input-group w-100"><label>Cliente</label><input type="text" id="v-cliente" required></div>
                    <div class="input-group w-100"><label>CI/Doc</label><input type="text" id="v-ci"></div>
                </div>
                <div class="input-group">
                    <label>Documentos / Fotos (PDF/IMG)</label>
                    <input type="file" id="v-files" multiple accept="image/*, .pdf">
                </div>
                <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                <div class="flex gap-2">
                    <div class="input-group w-100">
                        <label>Precio Final</label>
                        <input type="number" id="v-total" required step="0.01" oninput="window.calcLive(); window.showPreview(this, 'preview-v-total', document.getElementById('lbl-moneda-venda').innerText)">
                        <span id="preview-v-total" class="number-preview">0,00</span>
                    </div>
                    <div class="input-group w-100">
                        <label>Entrada</label>
                        <input type="number" id="v-entrada" value="0" step="0.01" oninput="window.calcLive(); window.showPreview(this, 'preview-v-entrada', document.getElementById('lbl-moneda-venda').innerText)">
                        <span id="preview-v-entrada" class="number-preview">0,00</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <div class="input-group w-100"><label>Nº Cuotas</label><input type="number" id="v-ncuotas" value="12" oninput="window.calcLive()"></div>
                    <div class="input-group w-100"><label>1er Vencimiento</label><input type="date" id="v-data1" required></div>
                </div>
                <div class="live-calc-box"><h4>Cuota Mensual: <span id="live-result-text">0,00</span> <span id="lbl-moneda-venda" style="font-size:0.8rem"></span></h4></div>
                <div class="text-right" style="margin-top:20px;">
                    <button type="button" onclick="closeModal('modal-venda')" class="btn btn-g">Cancelar</button>
                    <button type="submit" class="btn btn-p">Confirmar Venta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-pagar" class="modal hidden">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header"><h3>Registrar Pago</h3><button class="close-modal" onclick="closeModal('modal-pagar')">&times;</button></div>
            <form id="form-pagar">
                <input type="hidden" id="p-venda-id"><input type="hidden" id="p-cuota-idx">
                <div style="text-align:center; margin:15px 0; background:#f9f9f9; padding:15px; border-radius:5px;">
                    <h2 id="p-valor-display" style="color:var(--success)"></h2>
                    <small>Valor Original de la Cuota</small>
                </div>
                <div class="input-group">
                    <label>Monto a Pagar (Amortizable)</label>
                    <input type="number" id="p-valor-real" step="0.01" required style="font-size:1.3rem; font-weight:bold; color:green; text-align:center;" oninput="window.showPreview(this, 'preview-p-valor', document.getElementById('p-valor-display').innerText.substring(0,3))">
                    <span id="preview-p-valor" class="number-preview" style="width:100%; text-align:center; margin-top:5px;">0,00</span>
                </div>
                <div id="div-tc" class="input-group hidden" style="background:#fff3cd; padding:10px; border-radius:5px;">
                    <label>T.C. Día (Bs/USD)</label><input type="number" id="p-tc" value="6.96" step="0.01">
                </div>
                <div class="input-group"><label>Fecha Pago</label><input type="date" id="p-data" required></div>
                <button type="submit" class="btn btn-s w-100">Confirmar Recepción</button>
            </form>
        </div>
    </div>

    <div id="modal-edit" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar / Detalles</h3><button class="close-modal" onclick="closeModal('modal-edit')">&times;</button></div>
            <form id="form-edit">
                <input type="hidden" id="e-id"><input type="hidden" id="e-type">
                <div class="input-group"><label>Nombre / Cliente</label><input type="text" id="e-nome"></div>
                <div class="input-group"><label>Valor / Precio</label><input type="number" id="e-valor" step="0.01"></div>
                <div class="input-group"><label>Notas / Observaciones</label><textarea id="e-notas" rows="3"></textarea></div>
                <label><strong>Galeria:</strong></label>
                <div id="e-gallery" class="gallery"></div>
                <div class="input-group" style="margin-top:15px;"><label><i class="fas fa-plus"></i> Agregar fotos/docs</label><input type="file" id="e-new-files" multiple accept="image/*, .pdf"></div>
                <div class="text-right" style="margin-top:20px;">
                    <button type="button" onclick="closeModal('modal-edit')" class="btn btn-g">Cerrar</button>
                    <button type="submit" class="btn btn-p">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-detalles" class="modal hidden">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header"><h3>Detalles Completos</h3><button class="close-modal" onclick="closeModal('modal-detalles')">&times;</button></div>
            <div id="detalles-contenido"></div>
        </div>
    </div>

    <script>
        const { Client, Account, Databases, Storage, ID, Query, Permission, Role } = Appwrite;
        const client = new Client();

        const PROJECT_ID = '693b19f6002a7ae91448'; 
        client.setEndpoint('https://nyc.cloud.appwrite.io/v1').setProject(PROJECT_ID);

        const account = new Account(client);
        const db = new Databases(client);
        const storage = new Storage(client);

        const DB_ID = 'db_main';
        const COL_TERRENOS = 'col_terrenos';
        const COL_VENDAS = 'col_vendas';
        const BUCKET_ID = 'bucket_fotos';

        let terrenos = [], vendas = [], user = null;

        // Permisos de Seguridad
        function getPermissions() {
            if (!user) return [];
            return [
                Permission.read(Role.user(user.$id)),
                Permission.update(Role.user(user.$id)),
                Permission.delete(Role.user(user.$id))
            ];
        }

        // --- AUTH ---
        async function checkSession() {
            try {
                user = await account.get();
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-email-display').innerText = user.email;
                // Inicializar filtros de fecha (Mes actual)
                initDateFilters();
                loadData();
            } catch (e) { console.log("Esperando login..."); }
        }
        checkSession();

        function initDateFilters() {
            const date = new Date();
            // Primer día del mes
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
            // Hoy
            const today = new Date().toISOString().split('T')[0];
            
            document.getElementById('filter-date-start').value = firstDay;
            document.getElementById('filter-date-end').value = today;
        }

        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await account.createEmailPasswordSession(email, pass);
                checkSession();
            } catch (error) {
                try {
                    await account.create(ID.unique(), email, pass);
                    await account.createEmailPasswordSession(email, pass);
                    checkSession();
                } catch (ce) { document.getElementById('login-msg').innerText = "Error: " + error.message; }
            }
        });
        window.logout = async () => { await account.deleteSession('current'); location.reload(); }

        // --- DATA ---
        async function loadData() {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const tRes = await db.listDocuments(DB_ID, COL_TERRENOS, [Query.limit(100)]);
                terrenos = tRes.documents.map(d => ({ $id: d.$id, ...JSON.parse(d.dados) }));
                
                const vRes = await db.listDocuments(DB_ID, COL_VENDAS, [Query.limit(100)]);
                vendas = vRes.documents.map(d => ({ $id: d.$id, ...JSON.parse(d.dados) }));

                renderTerrenos(); renderVendas(); updateDashboard();
            } catch (e) { console.error(e); }
            document.getElementById('loader').classList.add('hidden');
        }

        async function uploadFiles(filesInput) {
            if (!filesInput.files.length) return [];
            let urls = [];
            for (let i = 0; i < filesInput.files.length; i++) {
                try {
                    const res = await storage.createFile(BUCKET_ID, ID.unique(), filesInput.files[i], getPermissions());
                    const fileUrl = storage.getFileView(BUCKET_ID, res.$id);
                    urls.push(fileUrl);
                } catch (e) { console.error("Upload error", e); }
            }
            return urls;
        }

        // --- TERRENOS ---
        document.getElementById('form-terreno').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            const urls = await uploadFiles(document.getElementById('t-files'));
            const data = {
                codigo: document.getElementById('t-codigo').value, nome: document.getElementById('t-nome').value,
                area: document.getElementById('t-area').value, moneda: document.getElementById('t-moneda').value,
                precio: parseFloat(document.getElementById('t-precio').value), notas: document.getElementById('t-notas').value,
                fotos: urls, estado: 'Disponible', habilitado: true
            };
            await db.createDocument(DB_ID, COL_TERRENOS, ID.unique(), { dados: JSON.stringify(data) }, getPermissions());
            document.getElementById('form-terreno').reset(); nav('listado'); loadData();
        });

        function renderTerrenos() {
            const b = document.getElementById('lista-terrenos'); b.innerHTML = '';
            const f = document.getElementById('search-land').value.toLowerCase();
            terrenos.forEach(t => {
                if (!t.nome.toLowerCase().includes(f) && !t.codigo.toLowerCase().includes(f)) return;
                let img = t.fotos && t.fotos.length ? `<img src="${t.fotos[0]}" class="thumb-small" onclick="verDetalles('${t.$id}', 'land')">` : '<div style="width:60px;height:60px;background:#eee;border-radius:4px;"></div>';
                let btn = t.estado === 'Disponible' ? `<button class="btn btn-p" style="padding:5px 10px" onclick="openVenda('${t.$id}')">Vender</button>` : `<span class="status-badge status-vendido">Vendido</span>`;
                b.innerHTML += `<tr><td>${img}</td><td><strong>${t.codigo}</strong></td><td>${t.nome}</td><td>${new Intl.NumberFormat('es-BO').format(t.area)} m²</td><td>${t.moneda} ${new Intl.NumberFormat('es-BO').format(t.precio)}</td><td>${t.estado}</td><td><button class="btn btn-g" onclick="openEdit('${t.$id}', 'land')"><i class="fas fa-edit"></i></button> ${btn} <button class="btn btn-d" onclick="deleteItem('${t.$id}', 'land')"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- VENTAS ---
        window.openVenda = (id) => {
            const t = terrenos.find(x => x.$id === id);
            document.getElementById('v-land-id').value = id;
            document.getElementById('v-land-info').innerText = `${t.codigo} - ${t.nome}`;
            document.getElementById('lbl-moneda-venda').innerText = t.moneda;
            
            // Set defaults and triggers
            document.getElementById('v-total').value = t.precio;
            document.getElementById('v-data1').value = new Date().toISOString().split('T')[0];
            
            window.calcLive();
            // Trigger preview manually
            window.showPreview(document.getElementById('v-total'), 'preview-v-total', t.moneda);
            window.showPreview(document.getElementById('v-entrada'), 'preview-v-entrada', t.moneda);
            
            document.getElementById('modal-venda').classList.remove('hidden');
        }

        document.getElementById('form-venda').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            const tId = document.getElementById('v-land-id').value;
            const terreno = terrenos.find(x => x.$id === tId);
            const urls = await uploadFiles(document.getElementById('v-files'));
            const total = parseFloat(document.getElementById('v-total').value);
            const ent = parseFloat(document.getElementById('v-entrada').value);
            const qtd = parseInt(document.getElementById('v-ncuotas').value);
            const data1 = new Date(document.getElementById('v-data1').value);
            
            // Fecha de la entrada (hoy)
            const today = new Date().toISOString().split('T')[0];

            let cuotas = [];
            for(let i=0; i<qtd; i++) {
                let dt = new Date(data1); dt.setMonth(dt.getMonth() + i);
                cuotas.push({ n: i+1, valor: (total-ent)/qtd, venc: dt.toISOString().split('T')[0], pago: false });
            }
            const venda = {
                cliente: document.getElementById('v-cliente').value, ci: document.getElementById('v-ci').value,
                fotos: urls, landId: tId, landNome: terreno.nome, moneda: terreno.moneda,
                total: total, entrada: ent, fecha_entrada: today, cuotas: cuotas, data: new Date().toISOString()
            };
            await db.createDocument(DB_ID, COL_VENDAS, ID.unique(), { dados: JSON.stringify(venda) }, getPermissions());
            terreno.estado = 'Vendido';
            await db.updateDocument(DB_ID, COL_TERRENOS, tId, { dados: JSON.stringify(terreno) });
            closeModal('modal-venda'); loadData();
        });

        function renderVendas() {
            const l1 = document.getElementById('lista-cobrancas');
            const l2 = document.getElementById('lista-historico');
            const l3 = document.getElementById('lista-completos'); // Nueva pestaña
            l1.innerHTML = ''; l2.innerHTML = ''; l3.innerHTML = '';
            
            const f = document.getElementById('search-venda').value.toLowerCase();

            vendas.forEach(v => {
                if (!v.cliente.toLowerCase().includes(f)) return;

                // Histórico (Todos)
                l2.innerHTML += `<tr><td>${v.$id.substring(0,5)}</td><td>${v.cliente}</td><td>${v.landNome}</td><td>${v.moneda} ${new Intl.NumberFormat('es-BO').format(v.total)}</td><td><button class="btn btn-w" onclick="openEdit('${v.$id}', 'sale')"><i class="fas fa-edit"></i></button> <button class="btn btn-d" onclick="deleteItem('${v.$id}', 'sale')"><i class="fas fa-trash"></i></button></td></tr>`;

                // Verificar si está completo
                let pendente = v.cuotas.find(c => !c.pago);
                
                if (!pendente) {
                    // Completado
                    l3.innerHTML += `<tr><td>${v.cliente}</td><td>${v.landNome}</td><td style="color:var(--success);font-weight:bold">${v.moneda} ${new Intl.NumberFormat('es-BO').format(v.total)}</td><td><span class="status-badge status-disponible">PAGADO</span></td><td><button class="btn btn-g" onclick="openEdit('${v.$id}', 'sale')">Ver</button></td></tr>`;
                } else {
                    // Cobranza (Pendiente)
                    let cor = new Date(pendente.venc) < new Date() ? 'red' : '#333';
                    l1.innerHTML += `<tr><td><strong>${v.cliente}</strong></td><td>${v.landNome}</td><td>${pendente.n}/${v.cuotas.length}</td><td style="color:${cor};font-weight:bold">${pendente.venc}</td><td>${v.moneda} ${new Intl.NumberFormat('es-BO').format(pendente.valor)}</td><td><button class="btn btn-s" onclick="openPagar('${v.$id}', ${pendente.n})">Cobrar</button></td></tr>`;
                }
            });
        }

        // --- PAGOS ---
        window.openPagar = (vId, n) => {
            const v = vendas.find(x => x.$id === vId);
            const c = v.cuotas.find(x => x.n === n);
            document.getElementById('p-venda-id').value = vId;
            document.getElementById('p-cuota-idx').value = v.cuotas.indexOf(c);
            document.getElementById('p-valor-display').innerText = v.moneda + ' ' + new Intl.NumberFormat('es-BO').format(c.valor);
            document.getElementById('p-valor-real').value = c.valor.toFixed(2);
            document.getElementById('p-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('div-tc').classList.toggle('hidden', v.moneda!=='USD');
            
            // Preview con Moneda correcta
            window.showPreview(document.getElementById('p-valor-real'), 'preview-p-valor', v.moneda);
            
            document.getElementById('modal-pagar').classList.remove('hidden');
        }

        document.getElementById('form-pagar').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            const vId = document.getElementById('p-venda-id').value;
            const idx = parseInt(document.getElementById('p-cuota-idx').value);
            const pago = parseFloat(document.getElementById('p-valor-real').value);
            const tc = parseFloat(document.getElementById('p-tc').value);
            const dataPago = document.getElementById('p-data').value;
            
            const v = vendas.find(x => x.$id === vId);
            let saldo = pago, i = idx;
            
            while(saldo > 0.1 && i < v.cuotas.length) {
                let c = v.cuotas[i];
                if(c.pago) { i++; continue; }
                if(saldo >= c.valor) { 
                    saldo -= c.valor; 
                    c.pago = true; 
                    c.valor_pago = c.valor; 
                    c.tc = tc;
                    c.data_pago = dataPago; // GUARDAR FECHA DE PAGO (Importante para reportes)
                }
                else { c.valor -= saldo; saldo = 0; }
                i++;
            }
            await db.updateDocument(DB_ID, COL_VENDAS, vId, { dados: JSON.stringify(v) });
            closeModal('modal-pagar'); loadData();
        });

        // --- GENERAL ---
        window.openEdit = (id, type) => {
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            document.getElementById('e-id').value = id; document.getElementById('e-type').value = type;
            document.getElementById('e-nome').value = (type === 'land') ? d.nome : d.cliente;
            document.getElementById('e-valor').value = (type === 'land') ? d.precio : d.total;
            document.getElementById('e-notas').value = (type === 'land') ? d.notas : '';
            const g = document.getElementById('e-gallery'); g.innerHTML = '';
            if(d.fotos) d.fotos.forEach((u, i) => g.innerHTML += `<div class="img-preview-box"><img src="${u}" onclick="window.open('${u}')"><div class="btn-del-img" onclick="remFoto('${id}', '${type}', ${i})">X</div></div>`);
            document.getElementById('modal-edit').classList.remove('hidden');
        }

        window.remFoto = async (id, type, i) => {
            if(!confirm("¿Borrar foto?")) return;
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            d.fotos.splice(i, 1);
            await db.updateDocument(DB_ID, (type==='land'?COL_TERRENOS:COL_VENDAS), id, { dados: JSON.stringify(d) });
            closeModal('modal-edit'); loadData();
        }

        document.getElementById('form-edit').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            const id = document.getElementById('e-id').value, type = document.getElementById('e-type').value;
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            const urls = await uploadFiles(document.getElementById('e-new-files'));
            if(!d.fotos) d.fotos = []; d.fotos = [...d.fotos, ...urls];
            if(type === 'land') { d.nome = document.getElementById('e-nome').value; d.precio = parseFloat(document.getElementById('e-valor').value); d.notas = document.getElementById('e-notas').value; }
            else { d.cliente = document.getElementById('e-nome').value; }
            await db.updateDocument(DB_ID, (type==='land'?COL_TERRENOS:COL_VENDAS), id, { dados: JSON.stringify(d) });
            closeModal('modal-edit'); loadData();
        });

        window.deleteItem = async (id, type) => {
            if(!confirm("¿Eliminar permanentemente?")) return;
            document.getElementById('loader').classList.remove('hidden');
            if(type === 'sale') {
                const v = vendas.find(x => x.$id === id);
                const t = terrenos.find(x => x.$id === v.landId);
                if(t) { t.estado = 'Disponible'; await db.updateDocument(DB_ID, COL_TERRENOS, t.$id, { dados: JSON.stringify(t) }); }
            }
            await db.deleteDocument(DB_ID, (type==='land'?COL_TERRENOS:COL_VENDAS), id);
            loadData();
        }

        window.verDetalles = (id, type) => {
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            let imgs = ''; if(d.fotos) d.fotos.forEach(u => imgs += `<img src="${u}" class="img-full" onclick="window.open('${u}')">`);
            const c = document.getElementById('detalles-contenido');
            c.innerHTML = (type === 'land') ? 
                `<h2>${d.nome}</h2><p><strong>Precio:</strong> ${d.moneda} ${new Intl.NumberFormat('es-BO').format(d.precio)}</p><p><strong>Superficie:</strong> ${new Intl.NumberFormat('es-BO').format(d.area)} m²</p><p><strong>Estado:</strong> ${d.estado}</p><p>${d.notas}</p><hr>${imgs}` : 
                `<h2>${d.cliente}</h2><p><strong>CI:</strong> ${d.ci}</p><hr>${imgs}`;
            document.getElementById('modal-detalles').classList.remove('hidden');
        }

        // --- UTILS & FILTROS ---
        window.nav = (v) => { 
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); 
            document.getElementById('view-'+v).classList.remove('hidden'); 
            document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+v).classList.add('active');
            if(v==='listado') renderTerrenos(); if(v==='ventas') renderVendas(); 
        }
        window.switchVendas=(t)=>{
            document.getElementById('tab-vendas-resumo').classList.add('hidden'); 
            document.getElementById('tab-vendas-hist').classList.add('hidden'); 
            document.getElementById('tab-vendas-completos').classList.add('hidden');
            document.getElementById('tab-vendas-'+t).classList.remove('hidden');
        }
        window.closeModal=(id)=>document.getElementById(id).classList.add('hidden');
        
        // --- CORRECCIÓN DE PREVIEW ---
        window.showPreview=(i, id, type)=>{
            let val = parseFloat(i.value);
            if(isNaN(val)) val = 0;
            
            let result = '';
            if(type === 'm²') {
                // Formato para Area
                result = new Intl.NumberFormat('es-BO', { minimumFractionDigits: 2 }).format(val) + ' m²';
            } else {
                // Formato para Moneda (BOB, USD, Ref)
                // Se o type for 'Ref', usa o simbolo da moeda da venda se possivel, ou vazio
                let currencyCode = (type === 'Ref' || type === 'm²') ? undefined : type;
                let options = { minimumFractionDigits: 2 };
                if(currencyCode) {
                    options.style = 'currency';
                    options.currency = currencyCode;
                }
                result = new Intl.NumberFormat('es-BO', options).format(val);
                if(!currencyCode && type !== 'm²') result = type + ' ' + result; // Fallback text prefix
            }
            
            document.getElementById(id).innerText = result;
        }
        
        window.calcLive=()=>{ 
            const p = parseFloat(document.getElementById('v-total').value)||0, e = parseFloat(document.getElementById('v-entrada').value)||0, c = parseInt(document.getElementById('v-ncuotas').value)||1; 
            const m = document.getElementById('lbl-moneda-venda').innerText || 'BOB';
            document.getElementById('live-result-text').innerText = new Intl.NumberFormat('es-BO', { style: 'currency', currency: m }).format((p-e)/c); 
        }
        
        function updateDashboard(){ 
            document.getElementById('kpi-total').innerText=terrenos.length; 
            document.getElementById('kpi-disp').innerText=terrenos.filter(t=>t.estado==='Disponible').length; 
            document.getElementById('kpi-vendidos').innerText=terrenos.filter(t=>t.estado==='Vendido').length; 

            // Filtro de Fechas para Recaudación
            const startStr = document.getElementById('filter-date-start').value;
            const endStr = document.getElementById('filter-date-end').value;
            const startDate = startStr ? new Date(startStr) : new Date(0); // Inicio de los tiempos si vacío
            const endDate = endStr ? new Date(endStr) : new Date(8640000000000000); // Fin de los tiempos
            
            // Ajustar endDate para incluir todo el día
            endDate.setHours(23,59,59,999);

            let rec = 0;
            vendas.forEach(v => {
                // Sumar Entrada si fecha_entrada está en rango (o si no tiene fecha asume hoy)
                let dataEntrada = v.fecha_entrada ? new Date(v.fecha_entrada) : new Date(v.data);
                if (dataEntrada >= startDate && dataEntrada <= endDate) {
                    let pg = v.entrada; 
                    if(v.moeda==='USD') pg *= 6.96;
                    rec += pg;
                }

                // Sumar Cuotas
                v.cuotas.forEach(c => { 
                    if(c.pago && c.data_pago) { 
                        let dataCuota = new Date(c.data_pago);
                        if(dataCuota >= startDate && dataCuota <= endDate) {
                            let val = c.valor_pago||c.valor; 
                            if(v.moeda==='USD') val *= (c.tc||6.96); 
                            rec += val;
                        }
                    } 
                });
            });
            document.getElementById('kpi-money').innerText = "Bs " + rec.toLocaleString('es-BO', {minimumFractionDigits: 2});
            
            const ctx1 = document.getElementById('chart-fin').getContext('2d'); if(window.ch1) window.ch1.destroy();
            window.ch1 = new Chart(ctx1, { type: 'doughnut', data: { labels: ['Disp','Vend'], datasets:[{data:[terrenos.filter(t=>t.estado==='Disponible').length, terrenos.filter(t=>t.estado==='Vendido').length], backgroundColor:['#27ae60','#7f8c8d']}] }, options: { maintainAspectRatio: false } });
        }
    </script>
</body>
</html>
