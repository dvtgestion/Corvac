<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inmobiliario - Versión Corregida</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- ESTILOS CSS --- */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #2980b9;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
            --light-bg: #f4f6f9;
            --white: #ffffff;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { background-color: var(--light-bg); color: #333; height: 100vh; overflow: hidden; }

        /* UTILIDADES */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 10px; }
        .text-right { text-align: right; }
        .text-bold { font-weight: bold; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: #fff; }
        .btn-secondary { background-color: #7f8c8d; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* PREVIEWS */
        .money-preview { font-size: 0.8rem; color: var(--success-color); margin-top: 2px; font-weight: 600; display: block; }
        
        /* CAJA DE CÁLCULO */
        .live-calc-box { background-color: #e8f6f3; border: 1px solid #a2d9ce; padding: 15px; border-radius: 6px; margin-top: 15px; text-align: center; }
        .live-calc-box h4 { color: var(--primary-color); margin-bottom: 5px; }
        .live-result { font-size: 1.5rem; color: var(--success-color); font-weight: bold; }

        /* GALERÍA */
        .gallery-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .gallery-item { position: relative; width: 80px; height: 80px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; background: #fff; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-delete {
            position: absolute; top: 0; right: 0; background: rgba(255, 0, 0, 0.8); color: white;
            width: 20px; height: 20px; text-align: center; font-size: 12px; cursor: pointer;
            line-height: 20px; border-bottom-left-radius: 4px; z-index: 10;
        }

        /* MINIATURAS EN TABLA (CSS de respaldo) */
        .thumb-preview { 
            width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; 
            cursor: pointer; transition: transform 0.2s; background-color: #fff;
        }
        .thumb-preview:hover { transform: scale(2.5); z-index: 100; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* IMAGEN EN DETALLES */
        .img-full { width: 100%; max-height: 300px; object-fit: contain; border-radius: 4px; border: 1px solid #eee; margin-bottom: 5px; background: #f9f9f9; }

        /* LAYOUT */
        #login-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
        .login-card { background: var(--white); padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        
        #dashboard-container { display: flex; height: 100vh; }
        aside { width: 260px; background-color: var(--primary-color); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-items { flex: 1; padding: 20px 0; overflow-y: auto; }
        .menu-btn { display: block; width: 100%; padding: 15px 20px; background: none; border: none; color: #ecf0f1; text-align: left; cursor: pointer; font-size: 1rem; }
        .menu-btn.active { background-color: var(--secondary-color); border-left: 4px solid var(--accent-color); }
        .menu-btn i { margin-right: 10px; width: 20px; }
        
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { background: var(--white); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #content-area { flex: 1; padding: 20px; overflow-y: auto; }
        
        .card { background: var(--white); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: var(--primary-color); }
        
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .status-disponible { background-color: #e8f8f5; color: #27ae60; border: 1px solid #27ae60; }
        .status-vendido { background-color: #eaeded; color: #7f8c8d; border: 1px solid #7f8c8d; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; }
        .stat-card h3 { font-size: 2rem; color: var(--accent-color); margin: 10px 0; }

        .charts-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .chart-box { flex: 1; min-width: 300px; background: white; padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: var(--border-radius); width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div class="text-center">
                <h2>Inmobiliaria</h2>
                <p>Gestión y Cobranza Avanzada</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="email" value="admin@empresa.com" readonly style="background:#eee;">
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="login-pass" placeholder="******" required>
                </div>
                <p id="login-error" class="error-msg" style="color:red; display:none;">Contraseña incorrecta.</p>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
            </form>
            <p class="text-center" style="margin-top:15px; font-size:0.8rem;">Contraseña demo: <b>123456</b></p>
        </div>
    </div>

    <div id="dashboard-container" class="hidden">
        <aside>
            <div class="sidebar-header">
                <h3>Panel de Control</h3>
            </div>
            <nav class="menu-items">
                <button class="menu-btn active" onclick="showSection('resumen')"><i class="fas fa-chart-line"></i> Resumen</button>
                <button class="menu-btn" onclick="showSection('registro')"><i class="fas fa-plus"></i> Registrar Terreno</button>
                <button class="menu-btn" onclick="showSection('listado')"><i class="fas fa-th-list"></i> Inventario</button>
                <button class="menu-btn" onclick="showSection('ventas')"><i class="fas fa-hand-holding-usd"></i> Cobranzas y Ventas</button>
            </nav>
        </aside>

        <main>
            <header>
                <h3 id="page-title">Resumen General</h3>
                <button onclick="logout()" class="btn btn-secondary">Salir</button>
            </header>

            <div id="content-area">
                
                <div id="sec-resumen" class="section-view">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <p>Terrenos Totales</p>
                            <h3 id="stat-total">0</h3>
                        </div>
                        <div class="stat-card">
                            <p>Disponibles</p>
                            <h3 id="stat-disponibles" style="color:var(--success-color)">0</h3>
                        </div>
                        <div class="stat-card">
                            <p>Total Recaudado (Ref. en Bs)</p>
                            <h3 id="stat-recaudado" style="color:var(--accent-color)">0</h3>
                            <small style="color:#777;">*Calculado con T.C. del día de pago</small>
                        </div>
                    </div>

                    <div class="charts-container">
                        <div class="chart-box">
                            <h4>Estado del Inventario</h4>
                            <canvas id="chartStatus"></canvas>
                        </div>
                        <div class="chart-box">
                            <h4>Finanzas Globales (Convertido a Bs)</h4>
                            <canvas id="chartFinanzas"></canvas>
                        </div>
                    </div>
                </div>

                <div id="sec-registro" class="section-view hidden">
                    <div class="card">
                        <h3>Registrar Nuevo Terreno</h3>
                        <form id="form-terreno">
                            <div class="flex gap-2" style="flex-wrap:wrap;">
                                <div class="form-group" style="flex:1">
                                    <label>Código *</label>
                                    <input type="text" id="t-codigo" required placeholder="Ej: L-01">
                                </div>
                                <div class="form-group" style="flex:2">
                                    <label>Nombre / Ubicación *</label>
                                    <input type="text" id="t-nombre" required placeholder="Ej: Lote Norte UV.5">
                                </div>
                            </div>
                            <div class="flex gap-2" style="flex-wrap:wrap;">
                                <div class="form-group" style="flex:1">
                                    <label>Superficie (m²)</label>
                                    <input type="number" id="t-superficie">
                                </div>
                                <div class="form-group" style="flex:1">
                                    <label>Moneda *</label>
                                    <select id="t-moneda">
                                        <option value="BOB">Bolivianos (Bs)</option>
                                        <option value="USD">Dólares ($us)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex:1">
                                    <label>Precio Base *</label>
                                    <input type="number" id="t-precio" required min="0" oninput="showPreview(this, 'preview-precio-t', document.getElementById('t-moneda').value)">
                                    <small id="preview-precio-t" class="money-preview">0,00</small>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label><i class="fas fa-camera"></i> Fotos del Terreno (Subir una o varias)</label>
                                <input type="file" id="t-foto" accept="image/*" multiple>
                                <small>Puedes seleccionar varias imágenes a la vez.</small>
                            </div>

                            <div class="form-group">
                                <label>Notas Adicionales</label>
                                <textarea id="t-notas" rows="3" placeholder="Detalles..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">Guardar Terreno</button>
                        </form>
                    </div>
                </div>

                <div id="sec-listado" class="section-view hidden">
                    <div class="card">
                        <div class="flex justify-between items-center" style="margin-bottom:15px;">
                            <h3>Inventario de Terrenos</h3>
                            <input type="text" id="search-land" placeholder="Buscar..." style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div class="table-responsive">
                            <table id="table-lands">
                                <thead>
                                    <tr>
                                        <th>Fotos</th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Precio</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                        <th>Habilitar</th>
                                        <th>Eliminar</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="sec-ventas" class="section-view hidden">
                    <div id="alerts-panel"></div>
                    <div class="card">
                        <div class="flex justify-between items-center" style="margin-bottom: 15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                            <div class="flex gap-2">
                                <button class="btn btn-primary" onclick="switchCobranzaView('resumen')">Cobranzas (Resumen)</button>
                                <button class="btn btn-secondary" onclick="switchCobranzaView('historial')">Historial & Edición</button>
                            </div>
                            <button class="btn btn-success" onclick="renderCobranzas()"><i class="fas fa-sync"></i></button>
                        </div>
                        
                        <div id="view-cobros-resumen">
                            <input type="text" id="search-deudor" placeholder="Buscar cliente..." 
                                   style="padding:8px; width:100%; max-width:300px; margin-bottom:10px; border:1px solid #ccc; border-radius:4px;"
                                   onkeyup="renderCobranzas()">
                            <div class="table-responsive">
                                <table id="table-cobros">
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Terreno</th>
                                            <th>Próxima Cuota</th>
                                            <th>Vencimiento</th>
                                            <th>Monto Cuota</th>
                                            <th>Cobrar / Amortizar</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="view-cobros-historial" class="hidden table-responsive">
                            <table id="table-sales-history">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Cliente</th>
                                        <th>Terreno</th>
                                        <th>Total</th>
                                        <th>Moneda</th>
                                        <th>Editar</th>
                                        <th>Eliminar</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="modal-venta" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Realizar Venta</h3>
                <button class="close-modal" onclick="closeModal('modal-venta')">&times;</button>
            </div>
            <form id="form-venta">
                <input type="hidden" id="v-land-id">
                <input type="hidden" id="v-land-moneda">
                
                <div style="background:#f0f0f0; padding:10px; margin-bottom:10px; border-radius:4px;">
                    Terreno: <b id="v-land-name"></b><br>
                    Base: <b id="v-land-price"></b>
                </div>
                
                <h4>Datos del Cliente</h4>
                <div class="flex gap-2">
                    <input type="text" id="v-cliente" class="form-group" style="width:100%;" placeholder="Nombre Completo *" required>
                    <input type="text" id="v-ci" class="form-group" style="width:100%;" placeholder="Carnet / ID">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-file-upload"></i> Documentos / Fotos Cliente (Múltiples)</label>
                    <input type="file" id="v-doc" accept="image/*" multiple>
                </div>

                <hr style="margin: 15px 0;">
                <h4>Condiciones Económicas (<span id="lbl-moneda"></span>)</h4>
                
                <div id="div-aviso-tc" class="form-group hidden" style="background: #fff3cd; padding: 10px; font-size:0.9rem;">
                    <i class="fas fa-info-circle"></i> Venta en Dólares. Se pedirá T.C. al cobrar.
                </div>

                <div class="flex gap-2">
                    <div style="flex:1" class="form-group">
                        <label>Precio Final</label>
                        <input type="number" id="v-precio-final" required oninput="calcLive()">
                    </div>
                    <div style="flex:1" class="form-group">
                        <label>Entrada (Inicial)</label>
                        <input type="number" id="v-entrada" value="0" oninput="calcLive()">
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <div style="flex:1" class="form-group">
                        <label>Nº Cuotas</label>
                        <input type="number" id="v-cuotas" value="12" min="1" oninput="calcLive()">
                    </div>
                    <div style="flex:1" class="form-group">
                        <label>1er Vencimiento</label>
                        <input type="date" id="v-fecha1" required>
                    </div>
                </div>

                <div class="live-calc-box">
                    <h4>Cuota Mensual</h4>
                    <div id="live-result-text" class="live-result">0,00</div>
                    <small id="live-detail-text">Calculando...</small>
                </div>
                
                <div style="text-align:right; margin-top:20px;">
                    <button type="submit" class="btn btn-primary">Confirmar Venta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-editar-terreno" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Terreno</h3>
                <button class="close-modal" onclick="closeModal('modal-editar-terreno')">&times;</button>
            </div>
            <form id="form-editar-terreno">
                <input type="hidden" id="e-t-id">
                <div class="form-group">
                    <label>Nombre / Ubicación</label>
                    <input type="text" id="e-t-nombre" required>
                </div>
                <div class="flex gap-2">
                    <div class="form-group" style="flex:1">
                        <label>Precio</label>
                        <input type="number" id="e-t-precio" required>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Superficie</label>
                        <input type="number" id="e-t-superficie">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="e-t-notas" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Galería de Imágenes Actual</label>
                    <div id="e-t-gallery" class="gallery-container"></div>
                </div>
                <div class="form-group">
                    <label>Agregar Nuevas Fotos</label>
                    <input type="file" id="e-t-foto-new" accept="image/*" multiple>
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="modal-editar-venta" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Datos Cliente</h3>
                <button class="close-modal" onclick="closeModal('modal-editar-venta')">&times;</button>
            </div>
            <form id="form-editar-venta">
                <input type="hidden" id="e-v-id">
                <div class="form-group">
                    <label>Nombre del Cliente</label>
                    <input type="text" id="e-v-cliente" required>
                </div>
                <div class="form-group">
                    <label>Carnet / ID</label>
                    <input type="text" id="e-v-ci">
                </div>
                
                <div class="form-group">
                    <label>Documentos Actuales</label>
                    <div id="e-v-gallery" class="gallery-container"></div>
                </div>
                <div class="form-group">
                    <label>Agregar Nuevos Documentos</label>
                    <input type="file" id="e-v-doc-new" accept="image/*" multiple>
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="modal-detalles" class="modal hidden">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h3>Detalles</h3>
                <button class="close-modal" onclick="closeModal('modal-detalles')">&times;</button>
            </div>
            <div id="detalles-contenido"></div>
        </div>
    </div>

    <div id="modal-cobro" class="modal hidden">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">
                <h3>Registrar Pago</h3>
                <button class="close-modal" onclick="closeModal('modal-cobro')">&times;</button>
            </div>
            <form id="form-cobro">
                <input type="hidden" id="c-sale-id">
                <input type="hidden" id="c-idx">
                
                <div class="text-center" style="margin-bottom:15px; background:#f0f0f0; padding:10px; border-radius:4px;">
                    <p>Cuota Correspondiente: <span id="c-num" class="text-bold"></span></p>
                    <p>Monto Original de Cuota:</p>
                    <h3 style="color:#555" id="c-monto-original"></h3>
                    <small id="c-moneda-ref"></small>
                </div>

                <div class="form-group">
                    <label style="color:var(--accent-color); font-weight:bold;">Monto a Pagar (Puede ser mayor para adelantar)</label>
                    <input type="number" id="c-monto-pagar" required step="0.01" style="font-size:1.2rem; font-weight:bold; color:var(--success-color);">
                    <small>Si paga más, el excedente se descontará de las siguientes cuotas.</small>
                </div>
                
                <div id="div-tc-cobro" class="form-group hidden" style="background:#e8f8f5; padding:10px; border-radius:4px;">
                    <label style="color:var(--success-color); font-weight:bold;">Tipo de Cambio del Día (Bs/USD) *</label>
                    <input type="number" step="0.01" id="c-tasa-dia" placeholder="Ej: 6.97">
                </div>

                <div class="form-group">
                    <label>Fecha de Recepción</label>
                    <input type="date" id="c-fecha" required style="width:100%;">
                </div>
                <button type="submit" class="btn btn-success" style="width:100%;">Confirmar Pago</button>
            </form>
        </div>
    </div>

    <script>
        // --- BASE DE DATOS ---
        const db = {
            terrenos: JSON.parse(localStorage.getItem('db_terrenos')) || [],
            ventas: JSON.parse(localStorage.getItem('db_ventas')) || []
        };

        function saveData() {
            try {
                localStorage.setItem('db_terrenos', JSON.stringify(db.terrenos));
                localStorage.setItem('db_ventas', JSON.stringify(db.ventas));
                updateDashboard();
            } catch (e) {
                alert("¡Almacenamiento lleno! Has subido muchas fotos.");
            }
        }

        const formatMoney = (amount, currency = 'BOB') => {
            return parseFloat(amount).toLocaleString('es-BO', { style: 'currency', currency: currency === 'USD' ? 'USD' : 'BOB' }).replace('US$', '$us');
        };

        // --- SISTEMA ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if(document.getElementById('login-pass').value === '123456') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-container').classList.remove('hidden');
                init();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        });

        function logout() { location.reload(); }

        function showSection(id) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            
            const menuMap = {'resumen':0, 'registro':1, 'listado':2, 'ventas':3};
            if(menuMap[id] !== undefined) document.querySelectorAll('.menu-btn')[menuMap[id]].classList.add('active');

            if(id === 'listado') renderLands();
            if(id === 'ventas') renderCobranzas();
            if(id === 'resumen') updateDashboard();
        }

        function init() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('v-fecha1').value = today;
            document.getElementById('c-fecha').value = today;
            updateDashboard();
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showPreview(input, elementId, currency) { 
            document.getElementById(elementId).innerText = formatMoney(parseFloat(input.value)||0, currency); 
        }

        function calcLive() {
            const precio = parseFloat(document.getElementById('v-precio-final').value) || 0;
            const entrada = parseFloat(document.getElementById('v-entrada').value) || 0;
            const cuotas = parseInt(document.getElementById('v-cuotas').value) || 1;
            const moneda = document.getElementById('v-land-moneda').value;
            let saldo = precio - entrada;
            let cuotaMensual = (saldo > 0 && cuotas > 0) ? (saldo / cuotas) : 0;
            document.getElementById('live-result-text').innerText = formatMoney(cuotaMensual, moneda);
            document.getElementById('live-detail-text').innerText = `Saldo: ${formatMoney(saldo, moneda)} en ${cuotas} cuotas.`;
        }

        function readImages(inputElement) {
            return new Promise((resolve) => {
                if (inputElement.files && inputElement.files.length > 0) {
                    const promises = Array.from(inputElement.files).map(file => {
                        return new Promise((res) => {
                            const reader = new FileReader();
                            reader.onload = (e) => res(e.target.result);
                            reader.readAsDataURL(file);
                        });
                    });
                    Promise.all(promises).then(images => resolve(images));
                } else { resolve([]); }
            });
        }

        // --- GALERÍA HELPER ---
        function renderGallery(containerId, images, onDelete) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if(!images || images.length === 0) return;
            
            images.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = 'gallery-item';
                div.innerHTML = `
                    <img src="${img}">
                    <div class="gallery-delete" onclick="${onDelete}(${idx})">X</div>
                `;
                container.appendChild(div);
            });
        }

        // --- LÓGICA TERRENOS ---
        document.getElementById('form-terreno').addEventListener('submit', async (e) => {
            e.preventDefault();
            const images = await readImages(document.getElementById('t-foto'));
            const newLand = {
                id: Date.now(),
                codigo: document.getElementById('t-codigo').value,
                nombre: document.getElementById('t-nombre').value,
                superficie: document.getElementById('t-superficie').value,
                moneda: document.getElementById('t-moneda').value, 
                precio: parseFloat(document.getElementById('t-precio').value),
                notas: document.getElementById('t-notas').value,
                galeria: images,
                habilitado: true,
                estado: 'Disponible'
            };
            db.terrenos.push(newLand);
            saveData();
            alert('Terreno registrado.');
            document.getElementById('form-terreno').reset();
            document.getElementById('preview-precio-t').innerText = "0,00";
        });

        function renderLands() {
            const tbody = document.querySelector('#table-lands tbody');
            tbody.innerHTML = '';
            const filtro = document.getElementById('search-land').value.toLowerCase();

            db.terrenos.forEach(land => {
                if(!land.codigo.toLowerCase().includes(filtro) && !land.nombre.toLowerCase().includes(filtro)) return;
                const tr = document.createElement('tr');
                
                let btnHabilitar = land.habilitado 
                    ? `<button class="btn btn-danger" style="padding:4px 8px; font-size:0.8rem;" onclick="toggleLand(${land.id})">Deshabilitar</button>` 
                    : `<button class="btn btn-success" style="padding:4px 8px; font-size:0.8rem;" onclick="toggleLand(${land.id})">Habilitar</button>`;
                
                let btnVender = (land.estado === 'Disponible' && land.habilitado) 
                    ? `<button class="btn btn-primary" style="padding:4px 8px;" onclick="openSaleModal(${land.id})">Vender</button>`
                    : `<span style="color:#ccc;">-</span>`;

                // CORRECCIÓN: Estilo INLINE para forzar tamaño pequeño en la tabla
                let imgHtml = (land.galeria && land.galeria.length > 0) 
                    ? `<img src="${land.galeria[0]}" class="thumb-preview" style="width:50px; height:50px; object-fit:cover;" onclick="verDetalles(${land.id})"><br><small>${land.galeria.length} fotos</small>` 
                    : `<div style="width:50px; height:50px; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:4px;"><i class="fas fa-image" style="color:#ccc;"></i></div>`;

                let btnEliminar = `<button class="btn btn-danger" style="padding:4px 8px;" onclick="deleteLand(${land.id})"><i class="fas fa-trash"></i></button>`;
                let btnEditar = `<button class="btn btn-warning" style="padding:4px 8px;" onclick="openEditLand(${land.id})"><i class="fas fa-edit"></i></button>`;

                tr.innerHTML = `
                    <td>${imgHtml}</td>
                    <td><strong>${land.codigo}</strong></td>
                    <td>${land.nombre}</td>
                    <td>${formatMoney(land.precio, land.moneda)}</td>
                    <td><span class="status-badge ${land.estado === 'Disponible' ? 'status-disponible' : 'status-vendido'}">${land.estado}</span></td>
                    <td>
                        <button class="btn btn-secondary" style="padding:4px;" onclick="verDetalles(${land.id})"><i class="fas fa-eye"></i></button>
                        ${btnEditar}
                        ${btnVender}
                    </td>
                    <td>${btnHabilitar}</td>
                    <td>${btnEliminar}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('search-land').addEventListener('input', renderLands);

        function toggleLand(id) {
            const land = db.terrenos.find(t => t.id === id);
            if(land) { land.habilitado = !land.habilitado; saveData(); renderLands(); }
        }
        function deleteLand(id) {
            const land = db.terrenos.find(t => t.id === id);
            if(land.estado === 'Vendido') { if(!confirm('Terreno VENDIDO. ¿Seguro?')) return; } 
            else { if(!confirm('¿Eliminar terreno?')) return; }
            db.terrenos = db.terrenos.filter(t => t.id !== id);
            saveData(); renderLands();
        }

        // --- EDICIÓN DE TERRENO Y FOTOS ---
        let currentEditLandId = null;
        function openEditLand(id) {
            currentEditLandId = id;
            const land = db.terrenos.find(t => t.id === id);
            document.getElementById('e-t-id').value = land.id;
            document.getElementById('e-t-nombre').value = land.nombre;
            document.getElementById('e-t-precio').value = land.precio;
            document.getElementById('e-t-superficie').value = land.superficie;
            document.getElementById('e-t-notas').value = land.notas;
            document.getElementById('e-t-foto-new').value = ''; 
            
            if(!land.galeria) land.galeria = [];
            renderGallery('e-t-gallery', land.galeria, 'deleteLandPhoto');
            
            document.getElementById('modal-editar-terreno').classList.remove('hidden');
        }

        function deleteLandPhoto(idx) {
            const land = db.terrenos.find(t => t.id === currentEditLandId);
            if(land) {
                land.galeria.splice(idx, 1);
                renderGallery('e-t-gallery', land.galeria, 'deleteLandPhoto');
            }
        }

        document.getElementById('form-editar-terreno').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('e-t-id').value);
            const land = db.terrenos.find(t => t.id === id);
            
            land.nombre = document.getElementById('e-t-nombre').value;
            land.precio = parseFloat(document.getElementById('e-t-precio').value);
            land.superficie = document.getElementById('e-t-superficie').value;
            land.notas = document.getElementById('e-t-notas').value;
            
            const newImgs = await readImages(document.getElementById('e-t-foto-new'));
            if(newImgs.length > 0) {
                if(!land.galeria) land.galeria = [];
                land.galeria = land.galeria.concat(newImgs);
            }

            saveData();
            closeModal('modal-editar-terreno');
            renderLands();
            alert('Terreno actualizado.');
        });

        function verDetalles(id) {
            let data = db.terrenos.find(t => t.id === id);
            let esTerreno = true;
            if(!data) { data = db.ventas.find(v => v.id === id); esTerreno = false; }

            const content = document.getElementById('detalles-contenido');
            let galeriaHtml = '';
            
            // CORRECCIÓN: Usar galería grid en detalles para evitar lista gigante
            if(data.galeria && data.galeria.length > 0) {
                galeriaHtml = '<div style="display:flex; flex-wrap:wrap; gap:10px;">';
                data.galeria.forEach(img => { 
                    galeriaHtml += `<img src="${img}" style="width:100px; height:100px; object-fit:cover; border:1px solid #ccc; cursor:pointer;" onclick="window.open(this.src)">`; 
                });
                galeriaHtml += '</div>';
            } else { galeriaHtml = '<p><i>Sin imágenes</i></p>'; }

            if(esTerreno) {
                content.innerHTML = `
                    <h4>${data.nombre} (${data.codigo})</h4>
                    <p>Precio: ${formatMoney(data.precio, data.moneda)}</p>
                    <p>Estado: ${data.estado}</p>
                    <p>Notas: ${data.notas || 'Sin notas.'}</p>
                    <hr><strong>Galería (Click para ver grande):</strong><br>${galeriaHtml}
                `;
            } else {
                content.innerHTML = `
                    <h4>Cliente: ${data.cliente}</h4>
                    <p>CI: ${data.ci}</p>
                    <p>Moneda Venta: ${data.moneda}</p>
                    <hr><strong>Documentos:</strong><br>${galeriaHtml}
                `;
            }
            document.getElementById('modal-detalles').classList.remove('hidden');
        }

        // --- LÓGICA VENTAS ---
        function openSaleModal(id) {
            const land = db.terrenos.find(t => t.id === id);
            document.getElementById('v-land-id').value = land.id;
            document.getElementById('v-land-name').innerText = land.nombre;
            const moneda = land.moneda || 'BOB';
            document.getElementById('v-land-moneda').value = moneda;
            document.getElementById('v-land-price').innerText = formatMoney(land.precio, moneda);
            document.getElementById('lbl-moneda').innerText = moneda;

            if(moneda === 'USD') document.getElementById('div-aviso-tc').classList.remove('hidden');
            else document.getElementById('div-aviso-tc').classList.add('hidden');

            document.getElementById('v-precio-final').value = land.precio;
            document.getElementById('v-entrada').value = 0;
            document.getElementById('v-cuotas').value = 12;
            document.getElementById('v-doc').value = '';
            calcLive();
            document.getElementById('modal-venta').classList.remove('hidden');
        }

        document.getElementById('form-venta').addEventListener('submit', async (e) => {
            e.preventDefault();
            const images = await readImages(document.getElementById('v-doc'));
            const landId = parseInt(document.getElementById('v-land-id').value);
            const moneda = document.getElementById('v-land-moneda').value;
            const precio = parseFloat(document.getElementById('v-precio-final').value);
            const entrada = parseFloat(document.getElementById('v-entrada').value);
            const nCuotas = parseInt(document.getElementById('v-cuotas').value);
            const fecha1 = new Date(document.getElementById('v-fecha1').value);
            
            const montoCuota = (precio - entrada) / nCuotas;
            const cuotas = [];
            for(let i=0; i<nCuotas; i++) {
                let f = new Date(fecha1);
                f.setMonth(f.getMonth() + i);
                cuotas.push({ n: i+1, vencimiento: f.toISOString().split('T')[0], monto: montoCuota, estado: 'Pendiente', fechaPago: null, tcPago: null });
            }

            const venta = {
                id: Date.now(),
                landId: landId,
                cliente: document.getElementById('v-cliente').value,
                ci: document.getElementById('v-ci').value,
                galeria: images, // Galeria comprador
                moneda: moneda,
                total: precio,
                entrada: entrada,
                cuotas: cuotas,
                fechaVenta: new Date().toISOString()
            };

            db.ventas.push(venta);
            const land = db.terrenos.find(t => t.id === landId);
            land.estado = 'Vendido';
            
            saveData();
            closeModal('modal-venta');
            alert('Venta registrada.');
            showSection('ventas');
        });

        // --- EDICIÓN DE VENTA/CLIENTE ---
        let currentEditSaleId = null;
        function openEditSale(id) {
            currentEditSaleId = id;
            const venta = db.ventas.find(v => v.id === id);
            document.getElementById('e-v-id').value = venta.id;
            document.getElementById('e-v-cliente').value = venta.cliente;
            document.getElementById('e-v-ci').value = venta.ci;
            document.getElementById('e-v-doc-new').value = '';
            
            if(!venta.galeria) venta.galeria = [];
            renderGallery('e-v-gallery', venta.galeria, 'deleteSalePhoto');

            document.getElementById('modal-editar-venta').classList.remove('hidden');
        }

        function deleteSalePhoto(idx) {
            const venta = db.ventas.find(v => v.id === currentEditSaleId);
            if(venta) {
                venta.galeria.splice(idx, 1);
                renderGallery('e-v-gallery', venta.galeria, 'deleteSalePhoto');
            }
        }

        document.getElementById('form-editar-venta').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('e-v-id').value);
            const venta = db.ventas.find(v => v.id === id);
            
            venta.cliente = document.getElementById('e-v-cliente').value;
            venta.ci = document.getElementById('e-v-ci').value;
            
            const newDocs = await readImages(document.getElementById('e-v-doc-new'));
            if(newDocs.length > 0) {
                if(!venta.galeria) venta.galeria = [];
                venta.galeria = venta.galeria.concat(newDocs);
            }

            saveData();
            closeModal('modal-editar-venta');
            renderCobranzas();
            alert('Datos del cliente actualizados.');
        });

        // --- LÓGICA COBRANZAS ---
        function switchCobranzaView(view) {
            document.getElementById('view-cobros-resumen').classList.add('hidden');
            document.getElementById('view-cobros-historial').classList.add('hidden');
            document.getElementById('view-cobros-' + view).classList.remove('hidden');
            renderCobranzas();
        }

        function renderCobranzas() {
            const tbody = document.querySelector('#table-cobros tbody');
            tbody.innerHTML = '';
            const searchName = document.getElementById('search-deudor').value.toLowerCase();
            const tbodyHist = document.querySelector('#table-sales-history tbody');
            tbodyHist.innerHTML = '';

            db.ventas.forEach(venta => {
                const land = db.terrenos.find(t => t.id === venta.landId);
                const nombreLand = land ? land.nombre : 'Eliminado';
                const moneda = venta.moneda || 'BOB';
                
                // Historial
                const trHist = document.createElement('tr');
                trHist.innerHTML = `
                    <td>${venta.id}</td>
                    <td>${venta.cliente}</td>
                    <td>${nombreLand}</td>
                    <td>${formatMoney(venta.total, moneda)}</td>
                    <td>${moneda}</td>
                    <td><button class="btn btn-warning" style="font-size:0.8rem; padding:4px 10px;" onclick="openEditSale(${venta.id})"><i class="fas fa-edit"></i> Editar</button></td>
                    <td><button class="btn btn-danger" style="font-size:0.8rem; padding:4px 10px;" onclick="deleteSale(${venta.id})"><i class="fas fa-trash"></i></button></td>
                `;
                tbodyHist.appendChild(trHist);

                // Resumen
                if(!venta.cliente.toLowerCase().includes(searchName)) return;
                
                const proxCuota = venta.cuotas.find(c => c.estado !== 'Pagada');
                const tr = document.createElement('tr');
                if(proxCuota) {
                    const hoy = new Date().toISOString().split('T')[0];
                    let color = '#333';
                    if(proxCuota.vencimiento < hoy) color = 'var(--danger-color)';

                    // Miniatura foto cliente
                    let iconDoc = (venta.galeria && venta.galeria.length > 0) 
                        ? `<i class="fas fa-images" style="color:blue; cursor:pointer;" onclick="verDetalles(${venta.id})"></i>` : '';

                    tr.innerHTML = `
                        <td><strong>${venta.cliente}</strong> ${iconDoc}</td>
                        <td>${nombreLand}</td>
                        <td>Cuota ${proxCuota.n} de ${venta.cuotas.length}</td>
                        <td style="color:${color}; font-weight:bold;">${proxCuota.vencimiento}</td>
                        <td>${formatMoney(proxCuota.monto, moneda)}</td>
                        <td><button class="btn btn-success" style="padding:4px 10px;" onclick="abrirCobro(${venta.id}, ${proxCuota.n})">Cobrar</button></td>
                    `;
                } else {
                    tr.innerHTML = `<td><strong>${venta.cliente}</strong></td><td>${nombreLand}</td><td colspan="3" class="text-center" style="color:green;">¡Pago Completado!</td><td>-</td>`;
                }
                tbody.appendChild(tr);
            });
        }

        function deleteSale(saleId) {
            if(!confirm('¿Eliminar venta? El terreno volverá a estar DISPONIBLE.')) return;
            const venta = db.ventas.find(v => v.id === saleId);
            if(venta) {
                const land = db.terrenos.find(t => t.id === venta.landId);
                if(land) land.estado = 'Disponible';
                db.ventas = db.ventas.filter(v => v.id !== saleId);
                saveData(); renderCobranzas();
            }
        }

        // --- COBRO INTELIGENTE (AMORTIZACIÓN) ---
        function abrirCobro(saleId, cuotaNum) {
            const venta = db.ventas.find(v => v.id === saleId);
            const cuotaIdx = venta.cuotas.findIndex(c => c.n === cuotaNum);
            const cuota = venta.cuotas[cuotaIdx];
            
            document.getElementById('c-sale-id').value = saleId;
            document.getElementById('c-idx').value = cuotaIdx;
            document.getElementById('c-num').innerText = cuota.n;
            
            // Mostrar monto original pero permitir edición
            const montoOriginal = cuota.monto.toFixed(2);
            document.getElementById('c-monto-original').innerText = formatMoney(cuota.monto, venta.moneda);
            document.getElementById('c-monto-pagar').value = montoOriginal; // Prellenar
            
            document.getElementById('c-moneda-ref').innerText = venta.moneda === 'USD' ? `(Moneda: ${venta.moneda})` : '';
            
            if(venta.moneda === 'USD') {
                document.getElementById('div-tc-cobro').classList.remove('hidden');
                document.getElementById('c-tasa-dia').required = true;
            } else {
                document.getElementById('div-tc-cobro').classList.add('hidden');
                document.getElementById('c-tasa-dia').required = false;
            }
            document.getElementById('modal-cobro').classList.remove('hidden');
        }

        document.getElementById('form-cobro').addEventListener('submit', (e) => {
            e.preventDefault();
            const saleId = parseInt(document.getElementById('c-sale-id').value);
            const idx = parseInt(document.getElementById('c-idx').value); // Índice de la cuota actual
            const fecha = document.getElementById('c-fecha').value;
            const pagoRealizado = parseFloat(document.getElementById('c-monto-pagar').value);
            const tc = parseFloat(document.getElementById('c-tasa-dia').value) || 1;

            const venta = db.ventas.find(v => v.id === saleId);
            
            // LÓGICA DE AMORTIZACIÓN (PAGO ADELANTADO)
            let dineroDisponible = pagoRealizado;
            let i = idx;

            // Recorrer cuotas hacia adelante mientras haya dinero
            while(dineroDisponible > 0.01 && i < venta.cuotas.length) {
                const cuotaActual = venta.cuotas[i];
                
                // Si la cuota ya estaba pagada, saltar (no debería pasar si empezamos en la pendiente)
                if(cuotaActual.estado === 'Pagada') {
                    i++;
                    continue;
                }

                if(dineroDisponible >= cuotaActual.monto) {
                    // Paga la cuota completa
                    dineroDisponible -= cuotaActual.monto;
                    cuotaActual.monto = cuotaActual.monto; // Se mantiene el registro del valor
                    cuotaActual.estado = 'Pagada';
                    cuotaActual.fechaPago = fecha;
                    cuotaActual.tcPago = (venta.moneda === 'USD') ? tc : null;
                } else {
                    // Pago parcial / Reducción de saldo
                    cuotaActual.monto -= dineroDisponible;
                    dineroDisponible = 0;
                    // No se marca como pagada, solo se reduce su deuda
                }
                i++;
            }

            saveData();
            closeModal('modal-cobro');
            renderCobranzas();
            alert('Pago registrado y amortización aplicada correctamente.');
        });

        // --- DASHBOARD ---
        let chartStatusInstance = null;
        let chartFinanzasInstance = null;

        function updateDashboard() {
            document.getElementById('stat-total').innerText = db.terrenos.length;
            document.getElementById('stat-disponibles').innerText = db.terrenos.filter(t => t.estado === 'Disponible').length;

            let totalRecibidoBs = 0;
            let totalPendienteBs = 0;

            db.ventas.forEach(v => {
                let factorEntrada = (v.moneda === 'USD') ? 6.96 : 1;
                totalRecibidoBs += (v.entrada * factorEntrada);

                v.cuotas.forEach(c => { 
                    if(c.estado === 'Pagada') {
                        let factor = (v.moneda === 'USD') ? (c.tcPago || 6.96) : 1; 
                        totalRecibidoBs += (c.monto * factor);
                    } else {
                        let factor = (v.moneda === 'USD') ? 6.96 : 1;
                        totalPendienteBs += (c.monto * factor);
                    }
                });
            });
            document.getElementById('stat-recaudado').innerText = formatMoney(totalRecibidoBs, 'BOB');

            // Alertas
            const container = document.getElementById('alerts-panel');
            container.innerHTML = '';
            let vencidas = 0;
            const hoy = new Date().toISOString().split('T')[0];
            db.ventas.forEach(v => {
                v.cuotas.forEach(c => { if(c.estado !== 'Pagada' && c.vencimiento < hoy) vencidas++; });
            });
            if(vencidas > 0) {
                container.innerHTML = `<div style="background:#fadbd8; color:#c0392b; padding:10px; margin-bottom:15px; border-radius:4px;"><i class="fas fa-exclamation-triangle"></i> Tienes <strong>${vencidas} cuotas vencidas</strong>.</div>`;
            }

            if(!document.getElementById('sec-resumen').classList.contains('hidden')) {
                const ctxStatus = document.getElementById('chartStatus').getContext('2d');
                const dataStatus = [
                    db.terrenos.filter(t => t.estado === 'Disponible').length,
                    db.terrenos.filter(t => t.estado === 'Vendido').length
                ];
                
                if(chartStatusInstance) chartStatusInstance.destroy();
                chartStatusInstance = new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: ['Disponible', 'Vendido'],
                        datasets: [{ data: dataStatus, backgroundColor: ['#27ae60', '#7f8c8d'] }]
                    }
                });

                const ctxFin = document.getElementById('chartFinanzas').getContext('2d');
                if(chartFinanzasInstance) chartFinanzasInstance.destroy();
                chartFinanzasInstance = new Chart(ctxFin, {
                    type: 'bar',
                    data: {
                        labels: ['Recaudado (Bs)', 'Por Cobrar (Bs)'],
                        datasets: [{
                            label: 'Bolivianos (Global)',
                            data: [totalRecibidoBs, totalPendienteBs],
                            backgroundColor: ['#2980b9', '#c0392b']
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }
        }
    </script>
</body>
</html>
