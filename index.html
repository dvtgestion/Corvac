<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inmobiliario - Corvacruz</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>

    <!-- NUEVO: PDF sin popups (descarga directa) -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.29/dist/jspdf.plugin.autotable.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #2980b9;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --light: #f4f6f9;
            --white: #ffffff;

            --bg1: #0f172a;
            --bg2: #111827;
            --glass: rgba(255,255,255,0.08);
            --glass2: rgba(255,255,255,0.14);
            --shadow: 0 18px 55px rgba(0,0,0,0.35);
            --shadowSoft: 0 8px 25px rgba(0,0,0,0.12);
            --ring: rgba(41,128,185,0.25);
            --muted: rgba(255,255,255,0.65);

            /* Safe-area (iOS) */
            --sat: env(safe-area-inset-top, 0px);
            --sab: env(safe-area-inset-bottom, 0px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        }

        html {
            height: 100%;
            height: -webkit-fill-available;
        }

        body {
            background-color: var(--light);
            color: #333;
            /* FIX iOS: 100vh bug */
            min-height: 100dvh;
            height: 100dvh;
            min-height: -webkit-fill-available;
            display: flex;
            flex-direction: column;
            overflow: hidden;

            /* safe area */
            padding-top: var(--sat);
            padding-bottom: var(--sab);
        }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .gap-2 { gap: 10px; }
        .w-100 { width: 100%; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .mobile-only { display: none; }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            color: #fff;
            transition: 0.18s ease;
            font-size: 0.92rem;
            letter-spacing: 0.2px;
            box-shadow: 0 10px 22px rgba(0,0,0,0.12);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover { transform: translateY(-1px); opacity: 0.95; }
        .btn:active { transform: translateY(0px); opacity: 0.92; }

        .btn-p { background: linear-gradient(135deg, #2f80ed, var(--accent)); }
        .btn-s { background: linear-gradient(135deg, #2ecc71, var(--success)); }
        .btn-d { background: linear-gradient(135deg, #e74c3c, var(--danger)); }
        .btn-w { background: linear-gradient(135deg, #f1c40f, var(--warning)); color: #2c3e50; }
        .btn-g { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .btn-sm { padding: 7px 12px; font-size: 0.82rem; border-radius: 9px; }

        #loader {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.88);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: var(--accent);
            backdrop-filter: blur(6px);
        }

        /* --- Pull To Refresh (iOS) --- */
        #ptr-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 0px;
            background: rgba(255,255,255,0.78);
            border-bottom: 1px solid rgba(15,23,42,0.08);
            z-index: 2600;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: height 0.12s ease;

            /* safe area */
            padding-top: var(--sat);
        }

        #ptr-indicator .ptr-box {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(15,23,42,0.04);
            border: 1px solid rgba(15,23,42,0.08);
            color: #0f172a;
            font-weight: 900;
            box-shadow: 0 10px 22px rgba(0,0,0,0.06);
        }

        #ptr-indicator .ptr-box i {
            color: var(--accent);
        }

        /* --- Login --- */
        #login-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background:
              radial-gradient(1000px 600px at 15% 10%, rgba(41,128,185,0.45), transparent 60%),
              radial-gradient(900px 550px at 90% 35%, rgba(39,174,96,0.25), transparent 55%),
              radial-gradient(800px 500px at 55% 95%, rgba(243,156,18,0.18), transparent 60%),
              linear-gradient(135deg, var(--bg1), var(--bg2));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 18px;

            /* safe area */
            padding-top: calc(18px + var(--sat));
            padding-bottom: calc(18px + var(--sab));
        }

        .login-box {
            width: 440px;
            max-width: 95vw;
            border-radius: 18px;
            padding: 28px 28px 24px 28px;
            background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
            border: 1px solid rgba(255,255,255,0.18);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .login-box:before {
            content: "";
            position: absolute;
            inset: -2px;
            background: radial-gradient(600px 240px at 20% 0%, rgba(255,255,255,0.20), transparent 60%);
            pointer-events: none;
        }

        .login-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .login-logo {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.18);
        }

        .login-logo i { color: rgba(255,255,255,0.92); font-size: 20px; }

        .login-title {
            font-size: 1.35rem;
            font-weight: 800;
            letter-spacing: 0.3px;
            line-height: 1.1;
        }

        .login-subtitle {
            color: var(--muted);
            margin-bottom: 18px;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .input-group { margin-bottom: 14px; text-align: left; }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 800;
            color: #475569;
            font-size: 0.92rem;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 11px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: 0.18s ease;
            background: #fff;
            box-shadow: 0 6px 18px rgba(0,0,0,0.04);
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: rgba(41,128,185,0.55);
            box-shadow: 0 0 0 4px var(--ring);
        }

        #login-screen .input-group label { color: rgba(255,255,255,0.82); }
        #login-screen .input-group input {
            border: 1px solid rgba(255,255,255,0.18);
            background: rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.95);
            box-shadow: none;
        }
        #login-screen .input-group input::placeholder { color: rgba(255,255,255,0.55); }
        #login-screen .input-group input:focus { box-shadow: 0 0 0 4px rgba(41,128,185,0.25); }

        .number-preview {
            font-size: 0.88rem;
            color: var(--success);
            font-weight: 800;
            margin-top: 6px;
            display: inline-block;
            background: #e8f8f5;
            padding: 3px 10px;
            border-radius: 999px;
            border: 1px solid #c3e6cb;
        }

        .kpi-row { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px; }
        .kpi-card { flex:1 1 220px; min-width: 220px; text-align:center; }

        .kpi-title { color:#64748b; font-weight:900; }

        .kpi-value {
            margin-top: 8px;
            color:#0f172a;
            font-weight: 950;
            font-size: clamp(1.55rem, 6vw, 2.4rem);
            line-height: 1.1;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #kpi-disp.kpi-value { color: var(--success); }
        #kpi-vendidos.kpi-value { color: #64748b; }

        #kpi-money.kpi-value {
            overflow: visible !important;
            text-overflow: clip !important;
            white-space: normal !important;
            word-break: break-word !important;
            overflow-wrap: anywhere !important;
            line-height: 1.15;
        }

        #app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            background: radial-gradient(1200px 600px at 20% 5%, rgba(41,128,185,0.12), transparent 65%),
                        radial-gradient(900px 500px at 85% 18%, rgba(39,174,96,0.10), transparent 55%),
                        linear-gradient(180deg, #f7fafc, #eef2f7);
            position: relative;
            min-height: 0;
        }

        #mobile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(2,6,23,0.55);
            z-index: 2050;
            backdrop-filter: blur(4px);
        }

        aside {
            width: 270px;
            background: linear-gradient(180deg, #0f172a, #111827);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 10px 0 35px rgba(0,0,0,0.16);
            border-right: 1px solid rgba(255,255,255,0.06);
            z-index: 2100;

            /* safe area */
            padding-top: var(--sat);
        }

        aside h3 {
            padding: 18px 18px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.05rem;
            font-weight: 900;
            letter-spacing: 0.2px;
        }

        .menu { padding: 10px; }

        .menu button {
            width: 100%;
            padding: 12px 14px;
            background: transparent;
            border: 1px solid transparent;
            color: rgba(255,255,255,0.78);
            text-align: left;
            cursor: pointer;
            font-size: 0.98rem;
            transition: 0.18s ease;
            border-radius: 12px;
            margin-bottom: 6px;
        }

        .menu button:hover {
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.95);
            border-color: rgba(255,255,255,0.10);
        }

        .menu button.active {
            background: linear-gradient(135deg, rgba(41,128,185,0.24), rgba(41,128,185,0.10));
            color: rgba(255,255,255,0.98);
            border-color: rgba(41,128,185,0.35);
            font-weight: 900;
            position: relative;
        }

        .menu button.active:before {
            content: "";
            position: absolute;
            left: 8px;
            top: 10px;
            bottom: 10px;
            width: 4px;
            border-radius: 999px;
            background: linear-gradient(180deg, #2f80ed, #2980b9);
        }

        .menu i {
            margin-right: 10px;
            width: 22px;
            text-align: center;
            opacity: 0.95;
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: transparent;
            min-width: 0;
            min-height: 0;
        }

        header {
            background: rgba(255,255,255,0.72);
            padding: calc(14px + var(--sat)) 18px 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadowSoft);
            border-bottom: 1px solid rgba(15,23,42,0.06);
            backdrop-filter: blur(10px);
            gap: 10px;
        }

        #page-title { font-weight: 950; letter-spacing: 0.2px; }

        /* IMPORTANTE: scroll interno con momentum en iOS */
        #content {
            flex: 1;
            padding: 18px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-width: 0;
            min-height: 0;

            /* evita corte inferior en iOS */
            padding-bottom: calc(18px + var(--sab));
        }

        .card {
            background: rgba(255,255,255,0.85);
            padding: 18px;
            border-radius: 16px;
            box-shadow: var(--shadowSoft);
            margin-bottom: 16px;
            border: 1px solid rgba(15,23,42,0.06);
            backdrop-filter: blur(10px);
            min-width: 0;
        }

        .table-wrap {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            overflow: hidden;
            border-radius: 14px;
            min-width: 760px;
        }

        th, td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid #eef2f7;
            vertical-align: middle;
            white-space: nowrap;
        }

        th {
            background: rgba(248,250,252,0.9);
            color: #0f172a;
            font-weight: 900;
            font-size: 0.92rem;
        }

        tr:hover { background: rgba(248,250,252,0.9); }

        .status-badge {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 900;
            letter-spacing: 0.2px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-disponible {
            background: #e8f8f5;
            color: #1f8a51;
            border: 1px solid rgba(39,174,96,0.45);
        }

        .status-vendido {
            background: #eef2f7;
            color: #64748b;
            border: 1px solid rgba(100,116,139,0.35);
        }

        /* NUEVO: Reservado */
        .status-reservado {
            background: rgba(243,156,18,0.18);
            color: #92400e;
            border: 1px solid rgba(243,156,18,0.32);
        }

        /* Alertas de cobranzas (top) */
        .alerts-wrap {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }

        .alert-bar {
            border-radius: 16px;
            padding: 12px 12px;
            border: 1px solid rgba(15,23,42,0.10);
            box-shadow: 0 10px 22px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .alert-bar .alert-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-weight: 950;
            color: #0f172a;
            flex-wrap: wrap;
        }

        .alert-bar .alert-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .alert-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 999px;
            font-weight: 900;
            font-size: 0.86rem;
            border: 1px solid rgba(15,23,42,0.12);
            background: rgba(255,255,255,0.70);
            color: #0f172a;
            cursor: pointer;
            transition: 0.15s ease;
        }

        .alert-pill:hover { transform: translateY(-1px); }

        .alert-red {
            background: rgba(192,57,43,0.12);
            border-color: rgba(192,57,43,0.22);
        }

        .alert-yellow {
            background: rgba(243,156,18,0.18);
            border-color: rgba(243,156,18,0.28);
        }

        /* Total deuda bar (filtro deudores) */
        .debt-total-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 12px;
            border-radius: 16px;
            margin-bottom: 12px;
            background: rgba(15,23,42,0.04);
            border: 1px solid rgba(15,23,42,0.10);
            box-shadow: 0 10px 22px rgba(0,0,0,0.06);
            flex-wrap: wrap;
        }

        .debt-total-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 220px;
        }

        .debt-total-left strong {
            font-weight: 950;
            color: #0f172a;
        }

        .debt-total-left small {
            color: #334155;
            font-weight: 800;
            opacity: 0.9;
        }

        .debt-total-right {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: flex-end;
        }

        .debt-total-value {
            font-weight: 950;
            color: var(--danger);
            font-size: 1.08rem;
        }

        .debt-overdue-value {
            font-weight: 950;
            color: #7f1d1d;
            font-size: 1.04rem;
        }

        /* Row colors for cobranzas table */
        .row-overdue { background: rgba(192,57,43,0.10) !important; }
        .row-near { background: rgba(243,156,18,0.14) !important; }

        .gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .img-preview-box {
            position: relative;
            width: 110px;
            height: 110px;
            border: 1px solid rgba(15,23,42,0.10);
            background: rgba(255,255,255,0.92);
            border-radius: 14px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            box-shadow: 0 10px 24px rgba(0,0,0,0.08);
        }

        .img-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .pdf-icon {
            font-size: 42px;
            color: var(--danger);
            margin-bottom: 6px;
        }

        .file-name {
            font-size: 10px;
            color: #475569;
            text-align: center;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            padding: 0 6px 6px 6px;
            font-weight: 800;
        }

        .btn-del-img {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(200,0,0,0.90);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 900;
            z-index: 10;
            border: 1px solid rgba(255,255,255,0.25);
        }

        .thumb-container {
            width: 62px;
            height: 62px;
            position: relative;
            cursor: pointer;
        }

        .thumb-small {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid rgba(15,23,42,0.10);
            background: #fff;
            box-shadow: 0 10px 22px rgba(0,0,0,0.08);
        }

        .thumb-pdf {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--danger);
            background: #fff0f0;
            border: 1px solid #ffcccc;
            border-radius: 12px;
            box-shadow: 0 10px 22px rgba(0,0,0,0.08);
        }

        .file-count {
            position: absolute;
            bottom: -6px;
            right: -6px;
            background: #0f172a;
            color: white;
            font-size: 10px;
            padding: 2px 7px;
            border-radius: 999px;
            font-weight: 900;
            border: 2px solid rgba(255,255,255,0.9);
        }

        .img-full {
            width: 100%;
            max-height: 460px;
            object-fit: contain;
            background: rgba(248,250,252,0.9);
            border: 1px solid rgba(15,23,42,0.06);
            margin-bottom: 12px;
            border-radius: 14px;
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
        }

        .doc-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px;
            background: rgba(255,255,255,0.92);
            border: 1px solid rgba(15,23,42,0.08);
            border-left: 6px solid var(--danger);
            margin-bottom: 10px;
            border-radius: 14px;
            color: #0f172a;
            text-decoration: none;
            font-weight: 900;
            transition: 0.18s ease;
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
            cursor: pointer;
        }

        .doc-link:hover {
            background: #fff5f5;
            transform: translateX(3px);
        }

        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(2,6,23,0.65);
            z-index: 2500;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 14px;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: rgba(255,255,255,0.92);
            padding: 18px;
            border-radius: 18px;
            width: 96%;
            max-width: 640px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            border: 1px solid rgba(15,23,42,0.10);
            backdrop-filter: blur(10px);
            min-width: 0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(15,23,42,0.08);
            padding-bottom: 10px;
            gap: 10px;
        }

        .close-modal {
            background: rgba(15,23,42,0.06);
            border: 1px solid rgba(15,23,42,0.08);
            font-size: 1.4rem;
            cursor: pointer;
            color: #0f172a;
            width: 38px;
            height: 38px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-modal:hover { background: rgba(15,23,42,0.10); }

        .chart-container {
            position: relative;
            height: 260px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .live-calc-box {
            background: rgba(224,242,241,0.95);
            padding: 10px 12px;
            border-radius: 14px;
            margin-top: 10px;
            text-align: center;
            border: 1px solid rgba(128,203,196,0.85);
            box-shadow: 0 10px 22px rgba(0,0,0,0.06);
        }

        .date-filters {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(255,255,255,0.78);
            padding: 10px 12px;
            border-radius: 14px;
            box-shadow: var(--shadowSoft);
            margin-bottom: 16px;
            border: 1px solid rgba(15,23,42,0.06);
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
        }

        .date-filters input {
            border: 1px solid rgba(15,23,42,0.14);
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(255,255,255,0.92);
        }

        .hint-box {
            background: rgba(41,128,185,0.08);
            border: 1px solid rgba(41,128,185,0.18);
            padding: 10px 12px;
            border-radius: 14px;
            color: #0f172a;
            font-weight: 800;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        .hint-box small { display:block; margin-top:4px; font-weight:700; color:#334155; opacity:0.85; }

        /* NUEVO: panel mini reportes (ya no se usa en pantalla, se mantiene por compatibilidad) */
        .reports-row {
            display:flex;
            gap:10px;
            flex-wrap:wrap;
            align-items:center;
            justify-content:flex-end;
            margin-left:auto;
        }

        /* NUEVO: visor interno de archivos (PDF/Imagen) con X y Descargar */
        .fileview-frame {
            width: 100%;
            height: 72vh;
            border: 0;
            border-radius: 14px;
            background: rgba(255,255,255,0.92);
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
        }
        .fileview-img {
            width: 100%;
            max-height: 72vh;
            object-fit: contain;
            border-radius: 14px;
            background: rgba(248,250,252,0.9);
            border: 1px solid rgba(15,23,42,0.06);
            box-shadow: 0 10px 26px rgba(0,0,0,0.06);
        }

        @media (max-width: 860px) {
            aside { width: 255px; }
            #content { padding: 14px; }
            .card { padding: 14px; }
            table { min-width: 720px; }
        }

        @media (max-width: 700px) {
            .mobile-only { display: inline-flex; }

            aside {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                transform: translateX(-105%);
                transition: transform 0.2s ease;
            }

            #app-container.mobile-menu-open aside {
                transform: translateX(0%);
            }

            header { padding: calc(12px + var(--sat)) 12px 12px 12px; }
            #content { padding: 12px; padding-bottom: calc(12px + var(--sab)); }

            table { min-width: 780px; }
            .modal-content { max-width: 96vw; }

            .kpi-card { flex: 1 1 48%; min-width: 160px; }

            .kpi-value {
                font-size: clamp(1.18rem, 7vw, 2.05rem);
                white-space: nowrap;
            }

            #kpi-money.kpi-value {
                font-size: clamp(1.05rem, 6.2vw, 1.7rem);
            }
        }

        @media (max-width: 420px) {
            .kpi-card { flex: 1 1 100%; min-width: 0; }

            .kpi-value {
                font-size: clamp(1.18rem, 8vw, 1.95rem);
            }

            #kpi-money.kpi-value {
                font-size: clamp(1.0rem, 7.2vw, 1.55rem);
            }
        }
    
        /* --- Badges / Moneda --- */
        .currency-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 700;
            background: #eef3ff;
            color: var(--primary);
            border: 1px solid rgba(44,62,80,0.18);
            vertical-align: middle;
        }

        /* Venta: selector de moneda y TC */
        #div-v-tc {
            border: 1px solid #ffe8a1;
            border-left: 5px solid var(--warning);
            border-radius: 6px;
        }

        /* Renegociación: bloque */
        .reneg-box {
            background: rgba(243,156,18,0.10);
            border: 1px solid rgba(243,156,18,0.22);
            border-left: 6px solid rgba(243,156,18,0.55);
            padding: 12px;
            border-radius: 14px;
            box-shadow: 0 10px 22px rgba(0,0,0,0.06);
            margin-bottom: 12px;
        }

    </style>
</head>
<body>

    <!-- Pull-to-refresh indicator -->
    <div id="ptr-indicator" aria-hidden="true">
        <div class="ptr-box">
            <i id="ptr-icon" class="fas fa-arrow-down"></i>
            <span id="ptr-text">Desliza hacia abajo para actualizar</span>
        </div>
    </div>

    <div id="loader" class="hidden">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top:15px; font-weight:900;">Cargando...</p>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <div class="login-brand">
                <div class="login-logo"><i class="fas fa-city"></i></div>
                <div>
                    <div class="login-title">Corvacruz Inmobiliaria</div>
                    <div class="login-subtitle">Sistema seguro & privado</div>
                </div>
            </div>

            <form id="form-login">
                <div class="input-group">
                    <label>Correo Electrónico</label>
                    <input type="email" id="email" required placeholder="tu@empresa.com">
                </div>
                <div class="input-group">
                    <label>Contraseña</label>
                    <input type="password" id="password" required placeholder="******">
                </div>
                <button type="submit" class="btn btn-p w-100"><i class="fas fa-right-to-bracket"></i> Ingresar</button>
                <p id="login-msg" style="color:#ffd5d5; margin-top:14px; font-weight:900;"></p>
            </form>

            <div style="margin-top:14px; color:rgba(255,255,255,0.68); font-weight:700; font-size:0.85rem;">
                <i class="fas fa-shield-halved"></i> Acceso restringido a usuarios autorizados
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="mobile-overlay" class="hidden" onclick="closeMobileMenu()"></div>

        <aside>
            <h3><i class="fas fa-city"></i> Corvacruz Panel</h3>
            <div class="menu">
                <button id="btn-resumen" onclick="nav('resumen')" class="active"><i class="fas fa-chart-pie"></i> Resumen</button>
                <button id="btn-registro" onclick="nav('registro')"><i class="fas fa-plus-circle"></i> Registrar Terreno</button>
                <button id="btn-listado" onclick="nav('listado')"><i class="fas fa-list"></i> Inventario</button>
                <button id="btn-ventas" onclick="nav('ventas')"><i class="fas fa-file-invoice-dollar"></i> Ventas</button>
            </div>
        </aside>

        <main>
            <header>
                <div class="flex items-center gap-2" style="min-width:0;">
                    <button class="btn btn-g btn-sm mobile-only" onclick="toggleMobileMenu()" title="Menú">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h3 id="page-title" style="color:#0f172a; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Resumen General</h3>
                </div>

                <div class="flex items-center" style="gap:12px; flex-wrap:wrap;">
                    <span id="user-email-display" style="font-weight:900; color:#334155;"></span>

                    <!-- ÚNICO botón visible de exportación en pantalla -->
                    <button onclick="openReportesModal()" class="btn btn-p btn-sm" title="Exportar reportes">
                        <i class="fas fa-file-export"></i> Reportes
                    </button>

                    <button onclick="logout()" class="btn btn-g btn-sm"><i class="fas fa-sign-out-alt"></i> Salir</button>
                </div>
            </header>

            <div id="content">

                <div id="view-resumen">
                    <div class="date-filters">
                        <label style="font-weight:900; color:#0f172a;"><i class="fas fa-calendar-alt"></i> Desde:</label>
                        <input type="date" id="filter-date-start" onchange="updateDashboard()">
                        <label style="font-weight:900; color:#0f172a;">Hasta:</label>
                        <input type="date" id="filter-date-end" onchange="updateDashboard()">
                        <span style="font-size:0.82rem; color:#334155; margin-left:8px; font-weight:800;">(Filtra lo recaudado)</span>
                    </div>

                    <div class="kpi-row">
                        <div class="card kpi-card">
                            <h4 class="kpi-title">Total Terrenos</h4>
                            <h1 id="kpi-total" class="kpi-value">0</h1>
                        </div>
                        <div class="card kpi-card">
                            <h4 class="kpi-title">Disponibles</h4>
                            <h1 id="kpi-disp" class="kpi-value">0</h1>
                        </div>
                        <div class="card kpi-card">
                            <h4 class="kpi-title">Reservados</h4>
                            <h1 id="kpi-reservados-mini" class="kpi-value" style="color:var(--warning);">0</h1>
                        </div>
                        <div class="card kpi-card">
                            <h4 class="kpi-title">Vendidos</h4>
                            <h1 id="kpi-vendidos" class="kpi-value">0</h1>
                        </div>
                        <div class="card kpi-card" style="border: 1px solid rgba(41,128,185,0.18);">
                            <h4 class="kpi-title" style="color:var(--accent); font-weight:950;">Recaudado (Ref. Bs)</h4>
                            <h1 id="kpi-money" class="kpi-value">0</h1>
                        </div>
                    </div>

                    <div class="card">
                        <div class="chart-container">
                            <canvas id="chart-fin"></canvas>
                        </div>
                    </div>
                </div>
                
                <div id="view-registro" class="hidden">
                    <div class="card">
                        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                            <h3 style="font-weight:950; color:#0f172a;">Registrar Nuevo Terreno</h3>
                            <span style="font-weight:900; color:#64748b; font-size:0.9rem;">
                                <i class="fas fa-paperclip"></i> Puedes añadir archivos uno por uno (se acumulan)
                            </span>
                        </div>

                        <form id="form-terreno" style="margin-top:16px;">
                            <div class="flex gap-2" style="flex-wrap:wrap;">
                                <div class="input-group w-100">
                                    <label>Código Interno</label>
                                    <input type="text" id="t-codigo" required>
                                </div>
                                <div class="input-group w-100">
                                    <label>Nombre / Ubicación</label>
                                    <input type="text" id="t-nome" required>
                                </div>
                            </div>

                            <div class="flex gap-2" style="flex-wrap:wrap;">
                                <div class="input-group w-100">
                                    <label>Superficie (m²)</label>
                                    <input type="number" id="t-area" oninput="window.showPreview(this, 'preview-t-area', 'm²')">
                                    <span id="preview-t-area" class="number-preview">0 m²</span>
                                </div>
                                <div class="input-group w-100">
                                    <label>Moneda</label>
                                    <select id="t-moneda" onchange="window.showPreview(document.getElementById('t-precio'), 'preview-precio-t', this.value)">
                                        <option value="BOB">Bolivianos (Bs)</option>
                                        <option value="USD">Dólar ($us)</option>
                                    </select>
                                </div>
                                <div class="input-group w-100">
                                    <label>Precio Base</label>
                                    <input type="number" id="t-precio" required min="0" step="0.01" oninput="window.showPreview(this, 'preview-precio-t', document.getElementById('t-moneda').value)">
                                    <span id="preview-precio-t" class="number-preview">0,00</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label><i class="fas fa-camera"></i> Fotos y Documentos (PDF)</label>
                                <input type="file" id="t-files" multiple accept="image/*,.pdf">
                                <div class="hint-box">
                                    Selecciona una foto, confirma. Luego selecciona el PDF, confirma.
                                    <small>Los archivos se acumulan abajo antes de guardar.</small>
                                </div>

                                <div class="flex gap-2" style="margin-top:10px; flex-wrap:wrap;">
                                    <button type="button" class="btn btn-g btn-sm" onclick="clearTerrenoFilePool()">
                                        <i class="fas fa-broom"></i> Limpiar archivos
                                    </button>
                                    <span id="t-files-count" style="font-weight:900; color:#334155; align-self:center;"></span>
                                </div>

                                <div id="t-files-pool" class="gallery"></div>
                            </div>

                            <div class="input-group">
                                <label>Notas Adicionales</label>
                                <textarea id="t-notas" rows="3"></textarea>
                            </div>

                            <button type="submit" class="btn btn-s w-100" style="font-size:1.05rem;">
                                <i class="fas fa-floppy-disk"></i> Guardar Terreno
                            </button>
                        </form>
                    </div>
                </div>
                
                                <div id="view-listado" class="hidden">
                    <div class="card">
                        <div class="flex justify-between items-center" style="margin-bottom:12px; flex-wrap:wrap; gap:10px;">
                            <h3 style="font-weight:950; color:#0f172a;">Inventario</h3>
                            <div class="flex gap-2" style="flex-wrap:wrap;">
                                <input type="text" id="search-land" placeholder="Buscar por nombre o código..."
                                       style="padding:11px 12px; width:320px; max-width:100%; border:1px solid rgba(15,23,42,0.14); border-radius:14px;"
                                       onkeyup="renderTerrenos()">
                            </div>
                        </div>

                        <div class="table-wrap">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Archivos</th>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Superficie</th>
                                        <th>Precio</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-terrenos"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-ventas" class="hidden">
                    <div class="card">
                        <div class="flex gap-2" style="margin-bottom:14px; flex-wrap:wrap;">
                            <button onclick="switchVendas('resumo')" class="btn btn-p">Cobranzas</button>
                            <button onclick="switchVendas('completos')" class="btn btn-s">Completados</button>
                            <button onclick="switchVendas('hist')" class="btn btn-g">Editar / Historial</button>

                            <button onclick="loadData()" class="btn btn-w" title="Recargar"><i class="fas fa-sync"></i></button>
                        </div>

                        <div id="tab-vendas-resumo">
                            <!-- ALERTAS TOP -->
                            <div id="ventas-alerts" class="alerts-wrap hidden"></div>

                            <!-- FILTRO + BUSCADOR -->
                            <div class="flex gap-2" style="flex-wrap:wrap; margin-bottom:12px;">
                                <input type="text" id="search-venda" placeholder="Buscar cliente..."
                                       style="flex:1; min-width:220px; padding:11px 12px; border:1px solid rgba(15,23,42,0.14); border-radius:14px;"
                                       onkeyup="renderVendas()">

                                <select id="filter-cobranzas" onchange="renderVendas()"
                                        style="padding:11px 12px; border:1px solid rgba(15,23,42,0.14); border-radius:14px; background:rgba(255,255,255,0.92); font-weight:900; color:#0f172a;">
                                    <option value="all">Todas</option>
                                    <option value="debts">Solo deudores</option>
                                </select>
                            </div>

                            <!-- TOTAL DEUDA (solo cuando filtro = deudores) -->
                            <div id="ventas-debt-total" class="debt-total-bar hidden">
                                <div class="debt-total-left">
                                    <strong><i class="fas fa-scale-balanced" style="color:var(--danger);"></i> Deudas (Ref. Bs)</strong>
                                    <small>Resumen rápido de lo pendiente</small>
                                </div>
                                <div class="debt-total-right">
                                    <span id="ventas-debt-total-value" class="debt-total-value">Total: Bs 0,00</span>
                                    <span id="ventas-debt-overdue-value" class="debt-overdue-value">Vencido: Bs 0,00</span>
                                </div>
                            </div>

                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Terreno</th>
                                            <th>Cuota</th>
                                            <th>Vencimiento</th>
                                            <th>Monto</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-cobrancas"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="tab-vendas-completos" class="hidden">
                            <h4 style="margin-bottom:10px; color:var(--success); font-weight:950;">Pagos Finalizados</h4>
                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Cliente</th>
                                            <th>Terreno</th>
                                            <th>Total Pagado</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-completos"></tbody>
                                </table>
                            </div>
                        </div>

                        <div id="tab-vendas-hist" class="hidden">
                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Cliente</th>
                                            <th>Terreno</th>
                                            <th>Total</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="lista-historico"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="modal-venda" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Realizar Venta</h3>
                <button class="close-modal" onclick="closeModal('modal-venda')">&times;</button>
            </div>
            <form id="form-venda">
                <input type="hidden" id="v-land-id">
                <p style="background:rgba(41,128,185,0.08); border:1px solid rgba(41,128,185,0.14); padding:12px; border-radius:14px; margin-bottom:12px; font-weight:900;">
                    Terreno: <strong id="v-land-info"></strong>
                </p>

                <!-- NUEVO: aviso si está reservado -->
                <div id="v-reserva-warning" class="hint-box hidden" style="background:rgba(243,156,18,0.14); border-color:rgba(243,156,18,0.28); margin-bottom:12px;">
                    <strong><i class="fas fa-bookmark"></i> Este terreno está reservado.</strong>
                    <small id="v-reserva-warning-text"></small>
                </div>

                <div class="flex gap-2" style="margin-bottom:10px; flex-wrap:wrap;">
                    <div class="input-group w-100" style="margin-bottom:0;">
                        <label>Precio Registrado (Base)</label>
                        <input type="text" id="v-precio-registrado" readonly>
                    </div>
                </div>

                <div class="flex gap-2" style="flex-wrap:wrap;">
                    <div class="input-group w-100"><label>Cliente</label><input type="text" id="v-cliente" required></div>
                    <div class="input-group w-100"><label>CI/Doc</label><input type="text" id="v-ci"></div>
                </div>

                <div class="input-group">
                    <label>Documentos (Fotos/PDF)</label>
                    <input type="file" id="v-files" multiple accept="image/*,.pdf">
                    <div class="hint-box">
                        Selecciona archivos uno por uno (imagen, luego PDF, etc.)
                        <small>Los archivos se acumulan abajo antes de confirmar la venta.</small>
                    </div>

                    <div class="flex gap-2" style="margin-top:10px; flex-wrap:wrap;">
                        <button type="button" class="btn btn-g btn-sm" onclick="clearVendaFilePool()">
                            <i class="fas fa-broom"></i> Limpiar archivos
                        </button>
                        <span id="v-files-count" style="font-weight:900; color:#334155; align-self:center;"></span>
                    </div>

                    <div id="v-files-pool" class="gallery"></div>
                </div>

                <hr style="margin:14px 0; border:0; border-top:1px solid rgba(15,23,42,0.08);">
                <!-- Moneda de Cobro -->
                <div class="flex gap-2" style="margin-bottom:10px; flex-wrap:wrap;">
                    <div class="input-group w-100">
                        <label><i class="fas fa-coins"></i> Moneda de Cobro</label>
                        <select id="v-pay-currency" onchange="onVendaCurrencyChange()">
                            <option value="BOB">Bolivianos (Bs)</option>
                            <option value="USD">Dólar ($us)</option>
                        </select>
                    </div>
                    <div id="div-v-tc" class="input-group w-100 hidden" style="background:#fff3cd; padding:10px; border-radius:6px; border:1px solid #ffe69c;">
                        <label><i class="fas fa-exchange-alt"></i> Tipo de Cambio (Bs/USD)</label>
                        <input type="number" id="v-tc" value="6.96" step="0.01" oninput="onVendaCurrencyChange(true)">
                    </div>
                </div>

                <div class="flex gap-2" style="flex-wrap:wrap;">
                    <div class="input-group w-100">
                        <label>Precio Final</label>
                        <input type="number" id="v-total" required step="0.01" oninput="window.calcLive(); window.showPreview(this, 'preview-v-total', document.getElementById('lbl-moneda-venda').innerText)">
                        <span id="preview-v-total" class="number-preview">0,00</span>
                    </div>
                    <div class="input-group w-100">
                        <label>Entrada</label>
                        <input type="number" id="v-entrada" value="0" step="0.01" oninput="window.calcLive(); window.showPreview(this, 'preview-v-entrada', document.getElementById('lbl-moneda-venda').innerText)">
                        <span id="preview-v-entrada" class="number-preview">0,00</span>
                    </div>
                </div>

                <div class="flex gap-2" style="flex-wrap:wrap;">
                    <div class="input-group w-100"><label>Nº Cuotas</label><input type="number" id="v-ncuotas" value="12" oninput="window.calcLive()"></div>
                    <div class="input-group w-100"><label>1er Vencimiento</label><input type="date" id="v-data1" required></div>
                </div>

                <div class="live-calc-box">
                    <h4 style="font-weight:950; color:#0f172a;">
                        Cuota Mensual: <span id="live-result-text">0,00</span> <span id="lbl-moneda-venda" style="font-size:0.85rem"></span>
                    </h4>
                </div>

                <div class="text-right" style="margin-top:16px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
                    <button type="button" onclick="closeModal('modal-venda')" class="btn btn-g">Cancelar</button>
                    <button type="submit" class="btn btn-p">Confirmar Venta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NUEVO: Modal Reservar -->
    <div id="modal-reserva" class="modal hidden">
        <div class="modal-content" style="max-width:520px;">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Registrar Reserva</h3>
                <button class="close-modal" onclick="closeModal('modal-reserva')">&times;</button>
            </div>
            <form id="form-reserva">
                <input type="hidden" id="r-land-id">

                <p style="background:rgba(243,156,18,0.14); border:1px solid rgba(243,156,18,0.28); padding:12px; border-radius:14px; margin-bottom:12px; font-weight:900;">
                    Terreno: <strong id="r-land-info"></strong>
                </p>

                <div class="input-group">
                    <label>Cliente (Reserva)</label>
                    <input type="text" id="r-cliente" required>
                </div>

                <div class="input-group">
                    <label>CI/Doc</label>
                    <input type="text" id="r-ci">
                </div>

                <div class="input-group">
                    <label>Vence la Reserva (opcional)</label>
                    <input type="date" id="r-vence">
                </div>

                <div class="input-group">
                    <label>Notas</label>
                    <textarea id="r-notas" rows="3"></textarea>
                </div>

                <div class="text-right" style="margin-top:12px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
                    <button type="button" onclick="closeModal('modal-reserva')" class="btn btn-g">Cancelar</button>
                    <button type="submit" class="btn btn-w"><i class="fas fa-bookmark"></i> Confirmar Reserva</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-pagar" class="modal hidden">
        <div class="modal-content" style="max-width:420px;">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Registrar Pago</h3>
                <button class="close-modal" onclick="closeModal('modal-pagar')">&times;</button>
            </div>
            <form id="form-pagar">
                <input type="hidden" id="p-venda-id">
                <input type="hidden" id="p-cuota-idx">

                <div style="text-align:center; margin:12px 0; background:rgba(39,174,96,0.08); border:1px solid rgba(39,174,96,0.18); padding:12px; border-radius:14px;">
                    <h2 id="p-valor-display" style="color:var(--success); font-weight:950;"></h2>
                    <small style="font-weight:800; color:#334155;">Valor Original de la Cuota</small>
                </div>

                <div class="input-group">
                    <label>Monto a Pagar (Amortizable)</label>
                    <input type="number" id="p-valor-real" step="0.01" required style="font-size:1.2rem; font-weight:950; color:#166534; text-align:center;"
                           oninput="window.showPreview(this, 'preview-p-valor', document.getElementById('p-valor-display').innerText.substring(0,3))">
                    <span id="preview-p-valor" class="number-preview" style="width:100%; text-align:center; margin-top:8px;">0,00</span>
                </div>

                <div id="div-tc" class="input-group hidden" style="background:#fff3cd; padding:10px; border-radius:14px; border:1px solid rgba(243,156,18,0.35);">
                    <label>T.C. Día (Bs/USD)</label>
                    <input type="number" id="p-tc" value="6.96" step="0.01">
                </div>

                <div class="input-group">
                    <label>Fecha Pago</label>
                    <input type="date" id="p-data" required>
                </div>

                <button type="submit" class="btn btn-s w-100"><i class="fas fa-check"></i> Confirmar Recepción</button>
            </form>
        </div>
    </div>

    <!-- NUEVO: Modal Renegociación -->
    <div id="modal-reneg" class="modal hidden">
        <div class="modal-content" style="max-width:560px;">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Renegociación de deuda</h3>
                <button class="close-modal" onclick="closeModal('modal-reneg')">&times;</button>
            </div>

            <form id="form-reneg">
                <input type="hidden" id="ren-venda-id">

                <div class="reneg-box">
                    <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
                        <div style="font-weight:950; color:#0f172a;">
                            <i class="fas fa-arrows-rotate" style="color:var(--warning)"></i>
                            Venta: <span id="ren-info"></span>
                        </div>
                        <div style="font-weight:900; color:#334155;">
                            Moneda: <span id="ren-moneda" class="currency-badge">-</span>
                        </div>
                    </div>

                    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
                        <div>
                            <div style="font-weight:900; color:#334155;">Saldo pendiente actual</div>
                            <div id="ren-saldo-actual" style="font-weight:950; color:var(--danger); font-size:1.15rem;">-</div>
                        </div>
                        <div>
                            <div style="font-weight:900; color:#334155;">Cuotas pendientes</div>
                            <div id="ren-cant-actual" style="font-weight:950; color:#0f172a; font-size:1.05rem;">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Nuevo saldo pendiente (mismo tipo de moneda de la venta)</label>
                    <input type="number" id="ren-nuevo-saldo" step="0.01" required oninput="renCalcPreview()">
                </div>

                <div class="flex gap-2" style="flex-wrap:wrap;">
                    <div class="input-group w-100">
                        <label>Nuevas cuotas</label>
                        <input type="number" id="ren-ncuotas" min="1" value="12" required oninput="renCalcPreview()">
                    </div>
                    <div class="input-group w-100">
                        <label>1er vencimiento (nuevo plan)</label>
                        <input type="date" id="ren-fecha1" required oninput="renCalcPreview()">
                    </div>
                </div>

                <div class="live-calc-box" style="background:rgba(41,128,185,0.08); border-color:rgba(41,128,185,0.18);">
                    <h4 style="font-weight:950; color:#0f172a;">
                        Nueva cuota estimada: <span id="ren-cuota-preview">0,00</span> <span id="ren-moneda2" style="font-size:0.85rem"></span>
                    </h4>
                </div>

                <div class="input-group" style="margin-top:12px;">
                    <label>Motivo / Notas de renegociación (opcional)</label>
                    <textarea id="ren-notas" rows="3" placeholder="Ej: Se reprograma por atraso, nuevo acuerdo con cliente..."></textarea>
                </div>

                <div class="text-right" style="margin-top:12px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
                    <button type="button" onclick="closeModal('modal-reneg')" class="btn btn-g">Cancelar</button>
                    <button type="submit" class="btn btn-w"><i class="fas fa-arrows-rotate"></i> Aplicar renegociación</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-edit" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Editar / Detalles</h3>
                <button class="close-modal" onclick="closeModal('modal-edit')">&times;</button>
            </div>
            <form id="form-edit">
                <input type="hidden" id="e-id"><input type="hidden" id="e-type">

                <div class="input-group"><label>Nombre / Cliente</label><input type="text" id="e-nome"></div>
                <div class="input-group"><label>Valor / Precio <span id="e-moneda-badge" class="currency-badge">-</span></label><input type="number" id="e-valor" step="0.01"></div>
                <div class="input-group"><label>Notas / Observaciones</label><textarea id="e-notas" rows="3"></textarea></div>

                <label style="font-weight:950; color:#0f172a;"><strong>Archivos (Fotos/PDF):</strong></label>
                <div id="e-gallery" class="gallery"></div>

                <div class="input-group" style="margin-top:14px;">
                    <label><i class="fas fa-plus"></i> Agregar archivos</label>
                    <input type="file" id="e-new-files" multiple accept="image/*,.pdf">
                    <div class="hint-box">
                        Selecciona una foto, confirma. Luego selecciona un PDF, confirma.
                        <small>Ahora también se acumula aquí (no se pierde lo anterior).</small>
                    </div>

                    <div class="flex gap-2" style="margin-top:10px; flex-wrap:wrap;">
                        <button type="button" class="btn btn-g btn-sm" onclick="clearEditFilePool()">
                            <i class="fas fa-broom"></i> Limpiar archivos nuevos
                        </button>
                        <span id="e-files-count" style="font-weight:900; color:#334155; align-self:center;"></span>
                    </div>

                    <div id="e-files-pool" class="gallery"></div>
                </div>

                <div class="text-right" style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
                    <button type="button" onclick="closeModal('modal-edit')" class="btn btn-g">Cerrar</button>
                    <button type="submit" class="btn btn-p">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-detalles" class="modal hidden">
        <div class="modal-content" style="max-width:760px;">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Detalles Completos</h3>
                <button class="close-modal" onclick="closeModal('modal-detalles')">&times;</button>
            </div>
            <div id="detalles-contenido"></div>
        </div>
    </div>

    <!-- Modal Reportes -->
    <div id="modal-reportes" class="modal hidden">
        <div class="modal-content" style="max-width:720px;">
            <div class="modal-header">
                <h3 style="font-weight:950; color:#0f172a;">Reportes y Exportación</h3>
                <button class="close-modal" onclick="closeModal('modal-reportes')">&times;</button>
            </div>

            <div class="hint-box" style="margin-bottom:12px;">
                Los reportes se descargan directamente (sin ventanas emergentes).
                <small>Si antes te salió “El navegador bloqueó la ventana emergente”, esta versión evita popups.</small>
            </div>

            <div class="card" style="margin-bottom:12px;">
                <h4 style="font-weight:950; color:#0f172a; margin-bottom:10px;"><i class="fas fa-calendar-alt"></i> Período (Recaudación)</h4>
                <div class="flex gap-2" style="flex-wrap:wrap;">
                    <div class="input-group w-100" style="margin-bottom:0;">
                        <label>Desde</label>
                        <input type="date" id="rep-start">
                    </div>
                    <div class="input-group w-100" style="margin-bottom:0;">
                        <label>Hasta</label>
                        <input type="date" id="rep-end">
                    </div>
                </div>
                <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-g" onclick="exportReporteGeneralPDF()"><i class="fas fa-file-pdf"></i> Reporte General (PDF)</button>
                    <button class="btn btn-g" onclick="exportReporteRecaudacionCSV()"><i class="fas fa-file-csv"></i> Recaudación (CSV)</button>
                </div>
            </div>

            <div class="card" style="margin-bottom:12px;">
                <h4 style="font-weight:950; color:#0f172a; margin-bottom:10px;"><i class="fas fa-warehouse"></i> Inventario</h4>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-g" onclick="exportInventarioPDF()"><i class="fas fa-file-pdf"></i> Inventario (PDF)</button>
                    <button class="btn btn-g" onclick="exportInventarioCSV()"><i class="fas fa-file-csv"></i> Inventario (CSV)</button>
                </div>
            </div>

            <div class="card">
                <h4 style="font-weight:950; color:#0f172a; margin-bottom:10px;"><i class="fas fa-file-invoice-dollar"></i> Ventas</h4>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-g" onclick="exportVentasPDF()"><i class="fas fa-file-pdf"></i> Ventas (PDF)</button>
                    <button class="btn btn-g" onclick="exportVentasCSV()"><i class="fas fa-file-csv"></i> Ventas (CSV)</button>
                </div>
            </div>
        </div>
    </div>

    
  <!-- Modal Reporte de Pagos por Cliente -->
    <div id="modal-reporte-pagos" class="modal hidden">
    <div class="modal-content" style="max-width: 980px;">
      <div class="modal-header">
        <h3 id="reporte-pagos-title" style="font-weight:950; color:#0f172a;">Reporte de pagos</h3>
        <button class="close-modal" onclick="closeModal('modal-reporte-pagos')">&times;</button>
      </div>
      
      <div class="hint-box" id="reporte-pagos-subtitle" style="margin-bottom:12px;"></div>
      
      <div style="max-height: 60vh; overflow-y: auto;">
          <div id="reporte-pagos-content"></div>
      </div>

      <div class="text-right" style="margin-top:14px; display:flex; justify-content:flex-end;">
        <button class="btn btn-g" onclick="closeModal('modal-reporte-pagos')">Cerrar</button>
      </div>
    </div>
  </div>


<!-- NUEVO: Visor interno de PDF/Imagen (con Descargar + X) -->
    <div id="modal-fileview" class="modal hidden">
        <div class="modal-content" style="max-width:980px;">
            <div class="modal-header">
                <h3 id="fileview-title" style="font-weight:950; color:#0f172a; margin:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Vista previa</h3>
                <div class="flex items-center gap-2">
                    <button id="btn-fileview-download" class="btn btn-p btn-sm" onclick="downloadCurrentFile()">
                        <i class="fas fa-download"></i> Descargar
                    </button>
                    <button class="close-modal" onclick="closeFileViewer()">&times;</button>
                </div>
            </div>
            <div id="fileview-body"></div>
        </div>
    </div>

    <script>
        const { Client, Account, Databases, Storage, ID, Query, Permission, Role } = Appwrite;
        const client = new Client();

        const PROJECT_ID = '693b19f6002a7ae91448';
        client.setEndpoint('https://nyc.cloud.appwrite.io/v1').setProject(PROJECT_ID);

        const account = new Account(client);
        const db = new Databases(client);
        const storage = new Storage(client);

        const DB_ID = 'db_main';
        const COL_TERRENOS = 'col_terrenos';
        const COL_VENDAS = 'col_vendas';
        const BUCKET_ID = 'bucket_fotos';

        let terrenos = [], vendas = [], user = null;

        let terrenoFilePool = [];
        let terrenoPoolObjectUrls = new Map();

        let vendaFilePool = [];
        let vendaPoolObjectUrls = new Map();

        let editFilePool = [];
        let editPoolObjectUrls = new Map();
        let editPoolSetupDone = false;

        /* Config: alerta de "perto de vencimiento" */
        const ALERT_DAYS = 7;

        /* NUEVO: formatos consistentes (2 decimales) */
        const NF2 = new Intl.NumberFormat('es-BO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const NF0 = new Intl.NumberFormat('es-BO');

        function fmtMoney(moneda, val) {
            const m = safeCurrency(moneda);
            const n = parseFloat(val);
            return `${m} ${NF2.format(isFinite(n) ? n : 0)}`;
        }
        function fmtBs(val) {
            const n = parseFloat(val);
            return `Bs ${NF2.format(isFinite(n) ? n : 0)}`;
        }
        
                function fileKey(f) {
            try { return `${f.name || ''}|${f.size || 0}|${f.lastModified || 0}`; }
            catch (_) { return String(Math.random()); }
        }

        function safeRevokeObjectURL(url) {
            try { if (url) URL.revokeObjectURL(url); } catch (_) {}
        }

        function isPoolPdf(file) {
            const name = String(file?.name || '').toLowerCase();
            const type = String(file?.type || '').toLowerCase();
            return type === 'application/pdf' || name.endsWith('.pdf');
        }

        function isPoolImage(file) {
            const type = String(file?.type || '').toLowerCase();
            if (type.startsWith('image/')) return true;
            const name = String(file?.name || '').toLowerCase();
            return name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.png') || name.endsWith('.webp') || name.endsWith('.gif') || name.endsWith('.heic') || name.endsWith('.heif') || name.endsWith('.bmp') || name.endsWith('.svg');
        }

        function isMobile() {
            try { return window.matchMedia && window.matchMedia('(max-width: 700px)').matches; }
            catch (_) { return false; }
        }

        window.toggleMobileMenu = () => {
            const app = document.getElementById('app-container');
            const ov = document.getElementById('mobile-overlay');
            if (!app || !ov) return;

            const open = !app.classList.contains('mobile-menu-open');
            app.classList.toggle('mobile-menu-open', open);
            ov.classList.toggle('hidden', !open);
        };

        window.closeMobileMenu = () => {
            const app = document.getElementById('app-container');
            const ov = document.getElementById('mobile-overlay');
            if (!app || !ov) return;
            app.classList.remove('mobile-menu-open');
            ov.classList.add('hidden');
        };

        /* ------------------------------
           Pull-to-refresh custom (iOS)
        ------------------------------ */
        let ptrStartY = 0;
        let ptrPulling = false;
        let ptrTriggered = false;
        let ptrLocked = false;

        function setPtrUI(heightPx, state) {
            const ind = document.getElementById('ptr-indicator');
            const txt = document.getElementById('ptr-text');
            const icon = document.getElementById('ptr-icon');
            if (!ind || !txt || !icon) return;

            ind.style.height = `${Math.max(0, heightPx)}px`;

            if (state === 'pull') {
                txt.innerText = 'Desliza hacia abajo para actualizar';
                icon.className = 'fas fa-arrow-down';
            } else if (state === 'release') {
                txt.innerText = 'Suelta para actualizar';
                icon.className = 'fas fa-arrow-up';
            } else if (state === 'loading') {
                txt.innerText = 'Actualizando...';
                icon.className = 'fas fa-spinner fa-spin';
            } else {
                txt.innerText = 'Desliza hacia abajo para actualizar';
                icon.className = 'fas fa-arrow-down';
            }
        }

        async function triggerPtrRefresh() {
            if (ptrLocked) return;
            ptrLocked = true;
            setPtrUI(70, 'loading');

            try {
                await loadData();
            } finally {
                setTimeout(() => {
                    setPtrUI(0, 'pull');
                    ptrLocked = false;
                }, 250);
            }
        }

        function setupPullToRefresh() {
            const content = document.getElementById('content');
            if (!content) return;

            const THRESHOLD = 85;
            const MAX_PULL = 140;

            content.addEventListener('touchstart', (e) => {
                if (!e.touches || e.touches.length !== 1) return;
                if (ptrLocked) return;
                if (content.scrollTop > 0) return;

                ptrStartY = e.touches[0].clientY;
                ptrPulling = true;
                ptrTriggered = false;
            }, { passive: true });

            content.addEventListener('touchmove', (e) => {
                if (!ptrPulling) return;
                if (ptrLocked) return;
                if (!e.touches || e.touches.length !== 1) return;

                const currentY = e.touches[0].clientY;
                let delta = currentY - ptrStartY;

                if (delta <= 0) {
                    setPtrUI(0, 'pull');
                    return;
                }

                if (content.scrollTop > 0) {
                    ptrPulling = false;
                    setPtrUI(0, 'pull');
                    return;
                }

                e.preventDefault();

                delta = Math.min(delta, MAX_PULL);
                const height = Math.min(70, (delta / MAX_PULL) * 70);

                if (delta >= THRESHOLD) {
                    setPtrUI(height, 'release');
                    ptrTriggered = true;
                } else {
                    setPtrUI(height, 'pull');
                    ptrTriggered = false;
                }
            }, { passive: false });

            content.addEventListener('touchend', () => {
                if (!ptrPulling) return;
                ptrPulling = false;

                if (ptrTriggered) {
                    triggerPtrRefresh();
                } else {
                    setPtrUI(0, 'pull');
                }
            }, { passive: true });
        }

        /* =========================================================
           NUEVO: VISOR INTERNO DE ARCHIVOS (PDF/IMAGEN)
           - evita window.open (popups)
           - incluye Descargar + X
        ========================================================= */
        let _fileviewState = {
            url: '',
            downloadUrl: '',
            name: '',
            isPdf: false,
            objectUrl: null
        };

        function _cleanupFileViewerMedia() {
            try {
                const body = document.getElementById('fileview-body');
                if (body) body.innerHTML = '';
            } catch (_) {}

            try {
                if (_fileviewState.objectUrl) {
                    safeRevokeObjectURL(_fileviewState.objectUrl);
                    _fileviewState.objectUrl = null;
                }
            } catch (_) {}

            _fileviewState.url = '';
            _fileviewState.downloadUrl = '';
            _fileviewState.name = '';
            _fileviewState.isPdf = false;
        }

        window.closeFileViewer = () => {
            _cleanupFileViewerMedia();
            const modal = document.getElementById('modal-fileview');
            if (modal) modal.classList.add('hidden');
        };

        function _toStr(v) { return String(v || ''); }

        function forceDownload(url, filename) {
            try {
                const u = _toStr(url);
                if (!u) { alert('No hay archivo para descargar.'); return; }

                const a = document.createElement('a');
                a.href = u;
                a.download = filename ? String(filename) : 'archivo';
                a.rel = 'noopener noreferrer';
                document.body.appendChild(a);
                a.click();
                a.remove();
            } catch (e) {
                alert('No se pudo iniciar la descarga.\n' + (e?.message || e));
            }
        }

        window.downloadCurrentFile = () => {
            const url = _fileviewState.downloadUrl || _fileviewState.url;
            const name = _fileviewState.name || 'archivo';
            forceDownload(url, name);
        };

        window.openFileViewer = (url, name, isPdf, downloadUrl) => {
            try {
                // cerrar y limpiar anterior (si había)
                _cleanupFileViewerMedia();

                const u = _toStr(url);
                if (!u) return;

                _fileviewState.url = u;
                _fileviewState.downloadUrl = _toStr(downloadUrl) || u;
                _fileviewState.name = _toStr(name) || 'Archivo';
                _fileviewState.isPdf = !!isPdf;

                const title = document.getElementById('fileview-title');
                if (title) title.innerText = _fileviewState.name;

                const body = document.getElementById('fileview-body');
                if (!body) return;

                if (_fileviewState.isPdf) {
                    body.innerHTML = `<iframe class="fileview-frame" src="${u}"></iframe>`;
                } else {
                    body.innerHTML = `<img class="fileview-img" src="${u}" alt="${_fileviewState.name}">`;
                }

                const modal = document.getElementById('modal-fileview');
                if (modal) modal.classList.remove('hidden');
            } catch (e) {
                console.error('openFileViewer error', e);
                alert('No se pudo abrir el archivo.\n' + (e?.message || e));
            }
        };

        function openLocalFileViewer(file) {
            try {
                if (!file) return;
                // limpiar anterior
                _cleanupFileViewerMedia();

                const url = URL.createObjectURL(file);
                _fileviewState.objectUrl = url;

                const name = file?.name || 'Archivo';
                const pdf = isPoolPdf(file);
                window.openFileViewer(url, name, pdf, url);
            } catch (e) {
                console.error('openLocalFileViewer', e);
            }
        }

        /* ========================================================= */

        function renderTerrenoFilePool() {
            const box = document.getElementById('t-files-pool');
            const counter = document.getElementById('t-files-count');
            if (!box || !counter) return;

            box.innerHTML = '';
            counter.innerText = terrenoFilePool.length ? `${terrenoFilePool.length} archivo(s) seleccionados` : '';

            terrenoFilePool.forEach((f, idx) => {
                const key = fileKey(f);
                const isPdf = isPoolPdf(f);
                const name = f?.name || 'Archivo';

                let content = '';
                if (isPdf) {
                    content = `
                        <div style="cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; height:100%; padding-top:6px;"
                             onclick="previewPoolFile(${idx})">
                            <i class="fas fa-file-pdf pdf-icon"></i>
                            <div class="file-name" title="${name}">${name}</div>
                        </div>
                    `;
                } else {
                    let url = terrenoPoolObjectUrls.get(key);
                    if (!url && isPoolImage(f)) {
                        try { url = URL.createObjectURL(f); terrenoPoolObjectUrls.set(key, url); }
                        catch (_) { url = ''; }
                    }
                    content = `
                        <img src="${url || ''}" alt="${name}" onclick="previewPoolFile(${idx})"
                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px;text-align:center;font-weight:900;color:#64748b;&quot;>Imagen no previsualizable</div>';">
                        <div class="file-name" title="${name}">${name}</div>
                    `;
                }

                box.innerHTML += `
                    <div class="img-preview-box" title="${name}">
                        ${content}
                        <div class="btn-del-img" onclick="event.stopPropagation(); removePoolFile(${idx})">X</div>
                    </div>
                `;
            });
        }

        window.previewPoolFile = (idx) => {
            const f = terrenoFilePool[idx];
            if (!f) return;
            openLocalFileViewer(f);
        };

        window.removePoolFile = (idx) => {
            const f = terrenoFilePool[idx];
            if (!f) return;
            const key = fileKey(f);
            const u = terrenoPoolObjectUrls.get(key);
            if (u) { safeRevokeObjectURL(u); terrenoPoolObjectUrls.delete(key); }
            terrenoFilePool.splice(idx, 1);
            renderTerrenoFilePool();
        };

        window.clearTerrenoFilePool = () => {
            try { for (const u of terrenoPoolObjectUrls.values()) safeRevokeObjectURL(u); } catch (_) {}
            terrenoPoolObjectUrls.clear();
            terrenoFilePool = [];
            renderTerrenoFilePool();
        };

        function setupTerrenoPoolInput() {
            const input = document.getElementById('t-files');
            if (!input) return;

            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;

                const existing = new Set(terrenoFilePool.map(fileKey));
                files.forEach(f => {
                    const k = fileKey(f);
                    if (!existing.has(k)) { terrenoFilePool.push(f); existing.add(k); }
                });

                try { input.value = ''; } catch (_) {}
                renderTerrenoFilePool();
            });

            renderTerrenoFilePool();
        }

        function renderVendaFilePool() {
            const box = document.getElementById('v-files-pool');
            const counter = document.getElementById('v-files-count');
            if (!box || !counter) return;

            box.innerHTML = '';
            counter.innerText = vendaFilePool.length ? `${vendaFilePool.length} archivo(s) seleccionados` : '';

            vendaFilePool.forEach((f, idx) => {
                const key = fileKey(f);
                const isPdf = isPoolPdf(f);
                const name = f?.name || 'Archivo';

                let content = '';
                if (isPdf) {
                    content = `
                        <div style="cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; height:100%; padding-top:6px;"
                             onclick="previewVendaPoolFile(${idx})">
                            <i class="fas fa-file-pdf pdf-icon"></i>
                            <div class="file-name" title="${name}">${name}</div>
                        </div>
                    `;
                } else {
                    let url = vendaPoolObjectUrls.get(key);
                    if (!url && isPoolImage(f)) {
                        try { url = URL.createObjectURL(f); vendaPoolObjectUrls.set(key, url); }
                        catch (_) { url = ''; }
                    }
                    content = `
                        <img src="${url || ''}" alt="${name}" onclick="previewVendaPoolFile(${idx})"
                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px;text-align:center;font-weight:900;color:#64748b;&quot;>Imagen no previsualizable</div>';">
                        <div class="file-name" title="${name}">${name}</div>
                    `;
                }

                box.innerHTML += `
                    <div class="img-preview-box" title="${name}">
                        ${content}
                        <div class="btn-del-img" onclick="event.stopPropagation(); removeVendaPoolFile(${idx})">X</div>
                    </div>
                `;
            });
        }

        window.previewVendaPoolFile = (idx) => {
            const f = vendaFilePool[idx];
            if (!f) return;
            openLocalFileViewer(f);
        };

        window.removeVendaPoolFile = (idx) => {
            const f = vendaFilePool[idx];
            if (!f) return;
            const key = fileKey(f);
            const u = vendaPoolObjectUrls.get(key);
            if (u) { safeRevokeObjectURL(u); vendaPoolObjectUrls.delete(key); }
            vendaFilePool.splice(idx, 1);
            renderVendaFilePool();
        };

        window.clearVendaFilePool = () => {
            try { for (const u of vendaPoolObjectUrls.values()) safeRevokeObjectURL(u); } catch (_) {}
            vendaPoolObjectUrls.clear();
            vendaFilePool = [];
            renderVendaFilePool();

            const input = document.getElementById('v-files');
            try { if (input) input.value = ''; } catch (_) {}
        };

        function setupVendaPoolInput() {
            const input = document.getElementById('v-files');
            if (!input) return;

            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;

                const existing = new Set(vendaFilePool.map(fileKey));
                files.forEach(f => {
                    const k = fileKey(f);
                    if (!existing.has(k)) { vendaFilePool.push(f); existing.add(k); }
                });

                try { input.value = ''; } catch (_) {}
                renderVendaFilePool();
            });

            renderVendaFilePool();
        }

        function renderEditFilePool() {
            const box = document.getElementById('e-files-pool');
            const counter = document.getElementById('e-files-count');
            if (!box || !counter) return;

            box.innerHTML = '';
            counter.innerText = editFilePool.length ? `${editFilePool.length} archivo(s) nuevos seleccionados` : '';

            editFilePool.forEach((f, idx) => {
                const key = fileKey(f);
                const isPdf = isPoolPdf(f);
                const name = f?.name || 'Archivo';

                let content = '';
                if (isPdf) {
                    content = `
                        <div style="cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; height:100%; padding-top:6px;"
                             onclick="previewEditPoolFile(${idx})">
                            <i class="fas fa-file-pdf pdf-icon"></i>
                            <div class="file-name" title="${name}">${name}</div>
                        </div>
                    `;
                } else {
                    let url = editPoolObjectUrls.get(key);
                    if (!url && isPoolImage(f)) {
                        try { url = URL.createObjectURL(f); editPoolObjectUrls.set(key, url); }
                        catch (_) { url = ''; }
                    }
                    content = `
                        <img src="${url || ''}" alt="${name}" onclick="previewEditPoolFile(${idx})"
                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px;text-align:center;font-weight:900;color:#64748b;&quot;>Imagen no previsualizable</div>';">
                        <div class="file-name" title="${name}">${name}</div>
                    `;
                }

                box.innerHTML += `
                    <div class="img-preview-box" title="${name}">
                        ${content}
                        <div class="btn-del-img" onclick="event.stopPropagation(); removeEditPoolFile(${idx})">X</div>
                    </div>
                `;
            });
        }

        window.previewEditPoolFile = (idx) => {
            const f = editFilePool[idx];
            if (!f) return;
            openLocalFileViewer(f);
        };

        window.removeEditPoolFile = (idx) => {
            const f = editFilePool[idx];
            if (!f) return;
            const key = fileKey(f);
            const u = editPoolObjectUrls.get(key);
            if (u) { safeRevokeObjectURL(u); editPoolObjectUrls.delete(key); }
            editFilePool.splice(idx, 1);
            renderEditFilePool();
        };

        window.clearEditFilePool = () => {
            try { for (const u of editPoolObjectUrls.values()) safeRevokeObjectURL(u); } catch (_) {}
            editPoolObjectUrls.clear();
            editFilePool = [];
            renderEditFilePool();

            const input = document.getElementById('e-new-files');
            try { if (input) input.value = ''; } catch (_) {}
        };

        function setupEditPoolInput() {
            if (editPoolSetupDone) return;
            const input = document.getElementById('e-new-files');
            if (!input) return;

            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                if (!files.length) return;

                const existing = new Set(editFilePool.map(fileKey));
                files.forEach(f => {
                    const k = fileKey(f);
                    if (!existing.has(k)) { editFilePool.push(f); existing.add(k); }
                });

                try { input.value = ''; } catch (_) {}
                renderEditFilePool();
            });

            editPoolSetupDone = true;
            renderEditFilePool();
        }

        function extractFileIdFromUrl(u) {
            const s = String(u || '');
            const m = s.match(/\/files\/([^\/]+)\//i);
            return m ? m[1] : null;
        }

        function getExt(name) {
            const s = String(name || '').toLowerCase().trim();
            const i = s.lastIndexOf('.');
            if (i === -1) return '';
            return s.slice(i + 1);
        }

        function isPdfByNameOrUrl(v) {
            const s = String(v || '').toLowerCase();
            return s.endsWith('.pdf') || s.includes('application/pdf');
        }

        function isImageByNameOrMime(file) {
            if (!file) return false;
            const name = (typeof file === 'string') ? file : (file.name || file.filename || '');
            const mime = (typeof file === 'object' && file) ? (file.mime || file.type || '') : '';
            const ext = getExt(name);
            if (mime && String(mime).toLowerCase().startsWith('image/')) return true;
            if (['jpg','jpeg','png','webp','gif','bmp','svg','heic','heif'].includes(ext)) return true;
            return false;
        }

        function normalizeFotos(fotos) {
            if (!fotos) return [];
            const arr = Array.isArray(fotos) ? fotos : [fotos];

            return arr
                .map((f) => {
                    if (typeof f === 'string') {
                        const id = extractFileIdFromUrl(f);
                        const name = 'Archivo';
                        return {
                            id: id || null,
                            url: String(f || ''),
                            name,
                            mime: '',
                            ext: getExt(f),
                            isPdf: isPdfByNameOrUrl(f),
                            createdAt: null
                        };
                    }

                    if (typeof f === 'object' && f) {
                        const rawUrl = (typeof f.url === 'string')
                            ? f.url
                            : (f.url && f.url.href ? f.url.href : (f.url ? String(f.url) : ''));

                        const id = f.id || f.fileId || extractFileIdFromUrl(rawUrl) || null;
                        const name = f.name || f.filename || 'Archivo';
                        const mime = f.mime || f.type || '';
                        const ext = f.ext || getExt(name) || getExt(rawUrl);

                        const isPdf = (typeof f.isPdf === 'boolean')
                            ? f.isPdf
                            : (String(mime).toLowerCase() === 'application/pdf' || ext === 'pdf' || isPdfByNameOrUrl(name) || isPdfByNameOrUrl(rawUrl));

                        return {
                            ...f,
                            id,
                            url: String(rawUrl || ''),
                            name,
                            mime: String(mime || ''),
                            ext: String(ext || ''),
                            isPdf,
                            createdAt: f.createdAt || f.created_at || null
                        };
                    }

                    return null;
                })
                .filter(Boolean);
        }

        function getFileUrl(file) {
            if (!file) return '';
            const f = (typeof file === 'string') ? { url: file } : file;

            const id = f.id || f.fileId;
            if (id) {
                const view = storage.getFileView(BUCKET_ID, id);
                const url = (typeof view === 'string') ? view : (view && view.href ? view.href : String(view));
                return String(url || '');
            }

            const u = (typeof f.url === 'string') ? f.url : (f.url && f.url.href ? f.url.href : (f.url ? String(f.url) : ''));
            return String(u || '');
        }

        function getFileDownloadUrl(file) {
            if (!file) return '';
            const f = (typeof file === 'string') ? { url: file } : file;

            const id = f.id || f.fileId;
            if (id) {
                const dl = storage.getFileDownload(BUCKET_ID, id);
                const url = (typeof dl === 'string') ? dl : (dl && dl.href ? dl.href : String(dl));
                return String(url || '');
            }
            return getFileUrl(file);
        }

        function getFileName(file) {
            if (!file) return 'Archivo';
            if (typeof file === 'string') return 'Archivo';
            return file.name || file.filename || 'Archivo';
        }

        function isPdfFile(file) {
            if (!file) return false;
            if (typeof file === 'string') return isPdfByNameOrUrl(file);
            if (typeof file.isPdf === 'boolean') return file.isPdf;
            const mime = (file.mime || file.type || '');
            const name = (file.name || file.filename || '');
            const ext = file.ext || getExt(name);
            if (String(mime).toLowerCase() === 'application/pdf') return true;
            if (String(ext).toLowerCase() === 'pdf') return true;
            return isPdfByNameOrUrl(name) || isPdfByNameOrUrl(file.url);
        }

        // Reemplazo: sin window.open (evita popups)
        window.openFile = (url, name = 'Archivo') => {
            const u = String(url || '');
            if (!u) return;
            const pdf = isPdfByNameOrUrl(u);
            window.openFileViewer(u, name, pdf, u);
        };

        function safeCurrency(code){
            const c = String(code || '').toUpperCase();
            if (c === 'USD' || c === 'BOB') return c;
            return 'BOB';
        }

        function getTcRefBsPerUsd(v) {
            const tc = parseFloat(v?.tc_venta);
            if (isFinite(tc) && tc > 0) return tc;
            return 6.96;
        }

        function getPermissions() {
            if (!user) return [];
            return [
                Permission.read(Role.user(user.$id)),
                Permission.update(Role.user(user.$id)),
                Permission.delete(Role.user(user.$id))
            ];
        }

        async function checkSession() {
            try {
                user = await account.get();
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-email-display').innerText = user.email;
                initDateFilters();
                setupTerrenoPoolInput();
                setupVendaPoolInput();
                setupEditPoolInput();
                setupPullToRefresh();
                loadData();
            } catch (e) {
                console.log("Login necesario");
            }
        }
        checkSession();

        function initDateFilters() {
            const date = new Date();
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filter-date-start').value = firstDay;
            document.getElementById('filter-date-end').value = today;

            const rs = document.getElementById('rep-start');
            const re = document.getElementById('rep-end');
            if (rs) rs.value = firstDay;
            if (re) re.value = today;
        }

        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await account.createEmailPasswordSession(email, pass);
                checkSession();
            } catch (error) {
                if (error.message && error.message.includes('session is active')) { checkSession(); return; }
                try {
                    await account.create(ID.unique(), email, pass);
                    await account.createEmailPasswordSession(email, pass);
                    checkSession();
                } catch (ce) {
                    document.getElementById('login-msg').innerText = "Error: " + (error.message || String(error));
                }
            }
        });

        window.logout = async () => { await account.deleteSession('current'); location.reload(); };

        async function loadData() {
            document.getElementById('loader').classList.remove('hidden');
            try {
                const tRes = await db.listDocuments(DB_ID, COL_TERRENOS, [Query.limit(100)]);
                terrenos = tRes.documents.map(d => {
                    const parsed = JSON.parse(d.dados);
                    parsed.fotos = normalizeFotos(parsed.fotos);
                    return { $id: d.$id, ...parsed };
                });

                const vRes = await db.listDocuments(DB_ID, COL_VENDAS, [Query.limit(100)]);
                vendas = vRes.documents.map(d => {
                    const parsed = JSON.parse(d.dados);
                    parsed.fotos = normalizeFotos(parsed.fotos);
                    return { $id: d.$id, ...parsed };
                });

                renderTerrenos();
                renderVendas();
                updateDashboard();
            } catch (e) {
                console.error(e);
            }
            document.getElementById('loader').classList.add('hidden');
        }

        async function uploadFiles(source) {
            let fileList = [];

            if (Array.isArray(source)) fileList = source;
            else if (source && source.files) fileList = Array.from(source.files || []);

            if (!fileList.length) return [];

            let filesData = [];
            for (let i = 0; i < fileList.length; i++) {
                try {
                    const file = fileList[i];
                    const res = await storage.createFile(BUCKET_ID, ID.unique(), file, getPermissions());

                    const isPdf = (file.type === 'application/pdf') || String(file.name || '').toLowerCase().endsWith('.pdf');
                    filesData.push({
                        id: res.$id,
                        name: file.name,
                        mime: file.type || '',
                        ext: getExt(file.name),
                        size: file.size || 0,
                        isPdf: isPdf,
                        createdAt: new Date().toISOString()
                    });
                } catch (e) {
                    console.error("Upload error", e);
                    const msg =
                        (e && e.message) ? e.message :
                        (typeof e === "string") ? e :
                        JSON.stringify(e);
                    alert("Error subiendo archivo.\n\n" + msg);
                }
            }

            try { if (source && source.value !== undefined) source.value = ''; } catch (_) {}
            return filesData;
        }

        document.getElementById('form-terreno').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');

            const uploaded = await uploadFiles(terrenoFilePool);

            const data = {
                codigo: document.getElementById('t-codigo').value,
                nome: document.getElementById('t-nome').value,
                area: parseFloat(document.getElementById('t-area').value),
                moneda: document.getElementById('t-moneda').value,
                precio: parseFloat(document.getElementById('t-precio').value),
                notas: document.getElementById('t-notas').value,
                fotos: normalizeFotos(uploaded),
                estado: 'Disponible',
                habilitado: true,
                reserva: null
            };

            await db.createDocument(DB_ID, COL_TERRENOS, ID.unique(), { dados: JSON.stringify(data) }, getPermissions());

            document.getElementById('form-terreno').reset();
            clearTerrenoFilePool();

            nav('listado');
            loadData();
        });

        function renderTerrenos() {
            const b = document.getElementById('lista-terrenos');
            b.innerHTML = '';
            const f = document.getElementById('search-land').value.toLowerCase();

            terrenos.forEach(t => {
                if (!t.nome.toLowerCase().includes(f) && !t.codigo.toLowerCase().includes(f)) return;

                const files = normalizeFotos(t.fotos);
                const fileCount = files.length;

                const images = files.filter(x => !isPdfFile(x) && isImageByNameOrMime(x));
                const cover = images[0] || files.find(x => !isPdfFile(x)) || files[0] || null;

                let thumbInner = `<div style="width:62px;height:62px;background:rgba(15,23,42,0.06);border-radius:12px;border:1px dashed rgba(15,23,42,0.14);"></div>`;
                if (cover) {
                    const url = getFileUrl(cover);
                    const pdf = isPdfFile(cover);
                    if (pdf) {
                        thumbInner = `<div class="thumb-pdf"><i class="fas fa-file-pdf"></i></div>`;
                    } else {
                        thumbInner = `<img src="${url}" class="thumb-small" onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=&quot;thumb-pdf&quot;><i class=&quot;fas fa-image&quot;></i></div>';">`;
                    }
                }

                const badge = (fileCount > 1) ? `<span class="file-count">+${fileCount}</span>` : '';
                const imgHtml = `<div class="thumb-container" onclick="verDetalles('${t.$id}', 'land')">${thumbInner}${badge}</div>`;

                let estadoHtml = '';
                if (t.estado === 'Disponible') estadoHtml = `<span class="status-badge status-disponible"><i class="fas fa-check"></i> Disponible</span>`;
                else if (t.estado === 'Reservado') estadoHtml = `<span class="status-badge status-reservado"><i class="fas fa-bookmark"></i> Reservado</span>`;
                else estadoHtml = `<span class="status-badge status-vendido"><i class="fas fa-lock"></i> Vendido</span>`;

                let acciones = '';
                if (t.estado === 'Disponible') {
                    acciones = `
                        <button type="button" class="btn btn-w btn-sm" onclick="event.stopPropagation(); openReserva('${t.$id}')"><i class="fas fa-bookmark"></i></button>
                        <button type="button" class="btn btn-p btn-sm" onclick="event.stopPropagation(); openVenda('${t.$id}')"><i class="fas fa-handshake"></i></button>
                    `;
                } else if (t.estado === 'Reservado') {
                    acciones = `
                        <button type="button" class="btn btn-p btn-sm" onclick="event.stopPropagation(); openVenda('${t.$id}')"><i class="fas fa-handshake"></i></button>
                        <button type="button" class="btn btn-g btn-sm" onclick="event.stopPropagation(); cancelarReserva('${t.$id}')"><i class="fas fa-unlock"></i></button>
                    `;
                } else {
                    acciones = `<span class="status-badge status-vendido"><i class="fas fa-lock"></i> Vendido</span>`;
                }

                b.innerHTML += `<tr>
                    <td>${imgHtml}</td>
                    <td><strong>${t.codigo}</strong></td>
                    <td>${t.nome}</td>
                    <td>${NF0.format(t.area)} m²</td>
                    <td>${t.moneda} ${NF2.format(t.precio)}</td>
                    <td>${estadoHtml}</td>
                    <td style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-g btn-sm" onclick="event.stopPropagation(); openEdit('${t.$id}', 'land')"><i class="fas fa-edit"></i></button>
                        ${acciones}
                        <button class="btn btn-d btn-sm" onclick="event.stopPropagation(); deleteItem('${t.$id}', 'land')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        // ------------------------------
        // RESERVAS
        // ------------------------------
        function openReserva(id) {
            const t = terrenos.find(x => x.$id === id);
            if (!t) return;

            document.getElementById('r-land-id').value = id;
            document.getElementById('r-land-info').innerText = `${t.codigo} - ${t.nome}`;
            document.getElementById('r-cliente').value = (t.reserva && t.reserva.cliente) ? t.reserva.cliente : '';
            document.getElementById('r-ci').value = (t.reserva && t.reserva.ci) ? t.reserva.ci : '';
            document.getElementById('r-vence').value = (t.reserva && t.reserva.vence) ? t.reserva.vence : '';
            document.getElementById('r-notas').value = (t.reserva && t.reserva.notas) ? t.reserva.notas : '';

            document.getElementById('modal-reserva').classList.remove('hidden');
        }
        window.openReserva = openReserva;

        window.cancelarReserva = async (id) => {
            const t = terrenos.find(x => x.$id === id);
            if (!t) return;
            if (!confirm("¿Cancelar la reserva y dejar el terreno como Disponible?")) return;

            document.getElementById('loader').classList.remove('hidden');
            try {
                t.estado = 'Disponible';
                t.reserva = null;
                t.fotos = normalizeFotos(t.fotos);
                await db.updateDocument(DB_ID, COL_TERRENOS, id, { dados: JSON.stringify(t) });
                loadData();
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        };

        document.getElementById('form-reserva').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('r-land-id').value;
            const t = terrenos.find(x => x.$id === id);
            if (!t) return;

            document.getElementById('loader').classList.remove('hidden');
            try {
                t.estado = 'Reservado';
                t.reserva = {
                    cliente: document.getElementById('r-cliente').value,
                    ci: document.getElementById('r-ci').value,
                    fecha: new Date().toISOString().split('T')[0],
                    vence: document.getElementById('r-vence').value || null,
                    notas: document.getElementById('r-notas').value || ""
                };
                t.fotos = normalizeFotos(t.fotos);
                await db.updateDocument(DB_ID, COL_TERRENOS, id, { dados: JSON.stringify(t) });

                closeModal('modal-reserva');
                loadData();
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        });

        // ------------------------------
        // VENTAS: Moneda + TC bidireccional (BOB ⇄ USD)
        // ------------------------------
        window._vendaLandMoneda = 'BOB';
        window._vendaBaseTotal = 0;     // SIEMPRE en moneda del terreno
        window._vendaBaseEntrada = 0;   // SIEMPRE en moneda del terreno
        window._vendaLastPayCurrency = 'BOB';

        function convertBetweenCurrencies(amount, fromCur, toCur, tcBsPerUsd) {
            const v = parseFloat(amount);
            if (!isFinite(v)) return 0;
            const tc = parseFloat(tcBsPerUsd);
            const t = (isFinite(tc) && tc > 0) ? tc : 6.96;

            if (fromCur === toCur) return v;

            // tc = Bs por 1 USD
            if (fromCur === 'USD' && toCur === 'BOB') return v * t;
            if (fromCur === 'BOB' && toCur === 'USD') return v / t;

            return v;
        }

        window.onVendaCurrencyChange = (forceRecalc = false) => {
            try {
                const sel = document.getElementById('v-pay-currency');
                const divTc = document.getElementById('div-v-tc');
                const inputTc = document.getElementById('v-tc');

                const landMoneda = safeCurrency(window._vendaLandMoneda);
                const newPayMoneda = safeCurrency(sel ? sel.value : landMoneda);

                let tc = parseFloat(inputTc ? inputTc.value : '6.96');
                if (!isFinite(tc) || tc <= 0) tc = 6.96;

                const showTc = (landMoneda !== newPayMoneda) && (
                    (landMoneda === 'USD' && newPayMoneda === 'BOB') ||
                    (landMoneda === 'BOB' && newPayMoneda === 'USD')
                );

                if (divTc) divTc.classList.toggle('hidden', !showTc);

                const totalEl = document.getElementById('v-total');
                const entEl = document.getElementById('v-entrada');
                if (!totalEl || !entEl) return;

                // Si NO es recalculo forzado (TC), y el usuario cambió moneda, primero guardamos base en moneda del terreno
                if (!forceRecalc && window._vendaLastPayCurrency && window._vendaLastPayCurrency !== newPayMoneda) {
                    const curT = parseFloat(totalEl.value) || 0;
                    const curE = parseFloat(entEl.value) || 0;

                    // Convertir lo que estaba en moneda anterior (pay) a moneda del terreno (base)
                    window._vendaBaseTotal = convertBetweenCurrencies(curT, window._vendaLastPayCurrency, landMoneda, tc);
                    window._vendaBaseEntrada = convertBetweenCurrencies(curE, window._vendaLastPayCurrency, landMoneda, tc);
                }

                // Ahora mostramos en la moneda seleccionada desde la base
                totalEl.value = (convertBetweenCurrencies(window._vendaBaseTotal || 0, landMoneda, newPayMoneda, tc)).toFixed(2);
                entEl.value = (convertBetweenCurrencies(window._vendaBaseEntrada || 0, landMoneda, newPayMoneda, tc)).toFixed(2);

                window._vendaLastPayCurrency = newPayMoneda;

                const lbl = document.getElementById('lbl-moneda-venda');
                if (lbl) lbl.innerText = newPayMoneda;

                window.calcLive();
                window.showPreview(document.getElementById('v-total'), 'preview-v-total', newPayMoneda);
                window.showPreview(document.getElementById('v-entrada'), 'preview-v-entrada', newPayMoneda);
            } catch (err) {
                console.error('onVendaCurrencyChange error', err);
            }
        };

        function openVenda(id) {
            try {
                const t = terrenos.find(x => x.$id === id);
                if (!t) { alert('Terreno no encontrado.'); return; }

                const landMoneda = safeCurrency(t.moneda || 'BOB');

                window._vendaLandMoneda = landMoneda;
                window._vendaBaseTotal = Number(t.precio) || 0;
                window._vendaBaseEntrada = 0;
                window._vendaLastPayCurrency = landMoneda;

                document.getElementById('v-land-id').value = id;
                document.getElementById('v-land-info').innerText = `${t.codigo} - ${t.nome}`;

                const warnBox = document.getElementById('v-reserva-warning');
                const warnTxt = document.getElementById('v-reserva-warning-text');
                if (t.estado === 'Reservado' && t.reserva) {
                    warnBox.classList.remove('hidden');
                    const vence = t.reserva.vence ? ` • Vence: ${t.reserva.vence}` : '';
                    warnTxt.innerText = `Cliente: ${t.reserva.cliente || '-'}${vence}`;
                } else {
                    warnBox.classList.add('hidden');
                    warnTxt.innerText = '';
                }

                const regEl = document.getElementById('v-precio-registrado');
                if (regEl) {
                    const symReg = (t.moneda === 'USD') ? '$us' : 'Bs';
                    const valReg = (typeof t.precio === 'number' && !isNaN(t.precio)) ? t.precio : (parseFloat(t.precio) || 0);
                    regEl.value = `${symReg} ${NF2.format(valReg)} (${t.moneda})`;
                }

                const sel = document.getElementById('v-pay-currency');
                if (sel) {
                    sel.disabled = false;
                    sel.innerHTML = `
                        <option value="BOB">Bolivianos (Bs)</option>
                        <option value="USD">Dólar ($us)</option>
                    `;
                    sel.value = landMoneda;
                }

                document.getElementById('v-total').value = (window._vendaBaseTotal || 0).toFixed(2);
                document.getElementById('v-entrada').value = (window._vendaBaseEntrada || 0).toFixed(2);
                document.getElementById('v-data1').value = new Date().toISOString().split('T')[0];

                try { clearVendaFilePool(); } catch (_) {}
                try { renderVendaFilePool(); } catch (_) {}

                document.getElementById('modal-venda').classList.remove('hidden');

                window.onVendaCurrencyChange(true);
            } catch (err) {
                console.error('openVenda error', err);
                alert('Error abriendo venta: ' + (err && err.message ? err.message : err));
            }
        }
        window.openVenda = openVenda;

        document.getElementById('form-venda').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');

            const tId = document.getElementById('v-land-id').value;
            const terreno = terrenos.find(x => x.$id === tId);

            const landMoneda = terreno ? safeCurrency(terreno.moneda || 'BOB') : 'BOB';
            const sel = document.getElementById('v-pay-currency');
            const payMoneda = sel ? safeCurrency(sel.value || landMoneda) : landMoneda;

            let tcVenta = null;
            if (landMoneda !== payMoneda) {
                const tcEl = document.getElementById('v-tc');
                const tc = tcEl ? parseFloat(tcEl.value) : NaN;
                tcVenta = (!isNaN(tc) && tc > 0) ? tc : null;
            }

            const uploaded = await uploadFiles(vendaFilePool);

            const total = parseFloat(document.getElementById('v-total').value);
            const ent = parseFloat(document.getElementById('v-entrada').value);
            const qtd = parseInt(document.getElementById('v-ncuotas').value);
            const data1 = new Date(document.getElementById('v-data1').value);
            const today = new Date().toISOString().split('T')[0];

            let cuotas = [];
            for (let i = 0; i < qtd; i++) {
                let dt = new Date(data1);
                dt.setMonth(dt.getMonth() + i);
                cuotas.push({ n: i + 1, valor: (total - ent) / qtd, venc: dt.toISOString().split('T')[0], pago: false });
            }

            const venda = {
                cliente: document.getElementById('v-cliente').value,
                ci: document.getElementById('v-ci').value,
                fotos: normalizeFotos(uploaded),
                landId: tId,
                landNome: terreno.nome,
                moneda: payMoneda,

                land_moneda: landMoneda,
                moneda_original: terreno ? (terreno.moneda || null) : null,
                precio_original: terreno ? (terreno.precio || null) : null,

                tc_venta: tcVenta,

                total: total,
                total_ref_usd: (landMoneda === 'USD' && payMoneda === 'BOB' && tcVenta) ? (total / tcVenta) : null,
                total_ref_bob: (landMoneda === 'BOB' && payMoneda === 'USD' && tcVenta) ? (total * tcVenta) : null,

                entrada: ent,
                fecha_entrada: today,
                cuotas: cuotas,
                data: new Date().toISOString(),
                notas: "",
                renegociaciones: []
            };

            await db.createDocument(DB_ID, COL_VENDAS, ID.unique(), { dados: JSON.stringify(venda) }, getPermissions());

            terreno.estado = 'Vendido';
            terreno.reserva = null;
            terreno.fotos = normalizeFotos(terreno.fotos);
            await db.updateDocument(DB_ID, COL_TERRENOS, tId, { dados: JSON.stringify(terreno) });

            clearVendaFilePool();
            closeModal('modal-venda');
            loadData();
        });

        /* Helpers para alertas */
        function parseDateYMD(ymd) {
            const s = String(ymd || '');
            const parts = s.split('-');
            if (parts.length !== 3) return null;
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10) - 1;
            const d = parseInt(parts[2], 10);
            const dt = new Date(y, m, d);
            if (isNaN(dt.getTime())) return null;
            dt.setHours(0,0,0,0);
            return dt;
        }

        function daysDiffFromToday(ymd) {
            const dt = parseDateYMD(ymd);
            if (!dt) return null;
            const today = new Date();
            today.setHours(0,0,0,0);
            const diff = dt.getTime() - today.getTime();
            return Math.floor(diff / 86400000);
        }

        function getRemainingDebtRefBs(v) {
            let rem = 0;
            try {
                (v.cuotas || []).forEach(c => {
                    if (!c.pago) rem += (parseFloat(c.valor) || 0);
                });
            } catch (_) {}
            if (String(v.moneda || '').toUpperCase() === 'USD') rem *= getTcRefBsPerUsd(v);
            return rem;
        }

        function getOverdueDebtRefBs(v) {
            let rem = 0;
            try {
                (v.cuotas || []).forEach(c => {
                    if (c.pago) return;
                    const dd = daysDiffFromToday(c.venc);
                    if (dd !== null && dd <= 0) rem += (parseFloat(c.valor) || 0);
                });
            } catch (_) {}
            if (String(v.moneda || '').toUpperCase() === 'USD') rem *= getTcRefBsPerUsd(v);
            return rem;
        }

        function getPendingCuotasSorted(v) {
            const pending = (v.cuotas || []).filter(c => !c.pago);
            pending.sort((a, b) => {
                const ad = parseDateYMD(a.venc);
                const bd = parseDateYMD(b.venc);
                if (ad && bd) return ad.getTime() - bd.getTime();
                if (ad && !bd) return -1;
                if (!ad && bd) return 1;
                return (parseInt(a.n || 0) - parseInt(b.n || 0));
            });
            return pending;
        }

        function buildCobranzasListFiltered() {
            const f = document.getElementById('search-venda').value.toLowerCase();
            const mode = (document.getElementById('filter-cobranzas')?.value || 'all');

            let list = [];
            vendas.forEach(v => {
                if (!v.cliente.toLowerCase().includes(f)) return;

                const pendingSorted = getPendingCuotasSorted(v);
                const pendente = pendingSorted[0];
                if (!pendente) return;

                const dd = daysDiffFromToday(pendente.venc);

                const isOverdue = (dd !== null && dd <= 0);
                const isNear = (dd !== null && dd > 0 && dd <= ALERT_DAYS);

                const item = {
                    v,
                    pendente,
                    days: dd,
                    overdue: isOverdue,
                    near: isNear
                };

                list.push(item);
            });

            if (mode === 'debts') {
                list = list.filter(x => x.overdue);
            }

            list.sort((a, b) => {
                const aRank = a.overdue ? 0 : (a.near ? 1 : 2);
                const bRank = b.overdue ? 0 : (b.near ? 1 : 2);
                if (aRank !== bRank) return aRank - bRank;

                const ad = parseDateYMD(a.pendente.venc);
                const bd = parseDateYMD(b.pendente.venc);
                if (ad && bd) return ad.getTime() - bd.getTime();
                return 0;
            });

            return list;
        }

        function renderDebtTotalIfNeeded(cobranzasList) {
            const mode = (document.getElementById('filter-cobranzas')?.value || 'all');
            const bar = document.getElementById('ventas-debt-total');
            const valTotal = document.getElementById('ventas-debt-total-value');
            const valOverdue = document.getElementById('ventas-debt-overdue-value');
            if (!bar || !valTotal || !valOverdue) return;

            if (mode !== 'debts') {
                bar.classList.add('hidden');
                valTotal.innerText = 'Total: Bs 0,00';
                valOverdue.innerText = 'Vencido: Bs 0,00';
                return;
            }

            let totalRef = 0;
            let overdueRef = 0;

            cobranzasList.forEach(x => {
                totalRef += getRemainingDebtRefBs(x.v);
                overdueRef += getOverdueDebtRefBs(x.v);
            });

            valTotal.innerText = 'Total: ' + fmtBs(totalRef);
            valOverdue.innerText = 'Vencido: ' + fmtBs(overdueRef);

            bar.classList.remove('hidden');
        }

        function renderVentasAlerts(cobranzasList) {
            const wrap = document.getElementById('ventas-alerts');
            if (!wrap) return;

            const overdueList = cobranzasList.filter(x => x.overdue);
            const nearList = cobranzasList.filter(x => x.near);

            if (!overdueList.length && !nearList.length) {
                wrap.classList.add('hidden');
                wrap.innerHTML = '';
                return;
            }

            wrap.classList.remove('hidden');
            wrap.innerHTML = '';

            if (overdueList.length) {
                let itemsHtml = '';
                overdueList.slice(0, 12).forEach(x => {
                    const monto = fmtMoney(x.v.moneda, x.pendente.valor);
                    const tag = (x.days === 0) ? '(vence hoy)' : '(vencida)';
                    itemsHtml += `
                        <div class="alert-pill" onclick="openPagar('${x.v.$id}', ${x.pendente.n})" title="Cobrar ahora">
                            <i class="fas fa-triangle-exclamation" style="color:var(--danger)"></i>
                            <span>${x.v.cliente} • ${x.v.landNome} • ${x.pendente.venc} • ${monto}</span>
                            <span style="opacity:0.75;">${tag}</span>
                        </div>
                    `;
                });

                wrap.innerHTML += `
                    <div class="alert-bar alert-red">
                        <div class="alert-title">
                            <span><i class="fas fa-circle-exclamation" style="color:var(--danger)"></i> Cobranza vencida: <strong>${overdueList.length}</strong></span>
                        </div>
                        <div class="alert-items">${itemsHtml}</div>
                        ${overdueList.length > 12 ? `<div style="font-weight:900; color:#334155;">Mostrando 12 de ${overdueList.length}…</div>` : ``}
                    </div>
                `;
            }

            if (nearList.length) {
                let itemsHtml = '';
                nearList.slice(0, 12).forEach(x => {
                    const monto = fmtMoney(x.v.moneda, x.pendente.valor);
                    const ddTxt = `${x.days} día(s)`;
                    itemsHtml += `
                        <div class="alert-pill" onclick="openPagar('${x.v.$id}', ${x.pendente.n})" title="Cobrar / revisar">
                            <i class="fas fa-bell" style="color:var(--warning)"></i>
                            <span>${x.v.cliente} • ${x.v.landNome} • ${x.pendente.venc} • ${monto}</span>
                            <span style="opacity:0.75;">(${ddTxt})</span>
                        </div>
                    `;
                });

                wrap.innerHTML += `
                    <div class="alert-bar alert-yellow">
                        <div class="alert-title">
                            <span><i class="fas fa-bell" style="color:var(--warning)"></i> Próximas a vencer: <strong>${nearList.length}</strong></span>
                        </div>
                        <div class="alert-items">${itemsHtml}</div>
                        ${nearList.length > 12 ? `<div style="font-weight:900; color:#334155;">Mostrando 12 de ${nearList.length}…</div>` : ``}
                    </div>
                `;
            }
        }

        function renderVendas() {
            const l1 = document.getElementById('lista-cobrancas');
            const l2 = document.getElementById('lista-historico');
            const l3 = document.getElementById('lista-completos');
            l1.innerHTML = ''; l2.innerHTML = ''; l3.innerHTML = '';

            const f = document.getElementById('search-venda').value.toLowerCase();

            vendas.forEach(v => {
                if (!v.cliente.toLowerCase().includes(f)) return;

                const hasDebt = (v.cuotas || []).some(c => !c.pago);

                l2.innerHTML += `<tr>
                    <td>${v.$id.substring(0,5)}</td>
                    <td>${v.cliente}</td>
                    <td>${v.landNome}</td>
                    <td>${fmtMoney(v.moneda, v.total)}</td>
                    <td style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-w btn-sm" onclick="event.stopPropagation(); openEdit('${v.$id}', 'sale')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-g btn-sm" onclick="event.stopPropagation(); verDetalles('${v.$id}', 'sale')" title="Ver detalles"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-w btn-sm" onclick="event.stopPropagation(); window.openReportePagosCliente('${v.$id}')" title="Reporte de pagos"><i class="fas fa-file-invoice-dollar"></i></button>
                        ${hasDebt ? `<button class="btn btn-w btn-sm" onclick="event.stopPropagation(); openRenegociar('${v.$id}')" title="Renegociar deuda"><i class="fas fa-arrows-rotate"></i></button>` : ``}
                        <button class="btn btn-d btn-sm" onclick="event.stopPropagation(); deleteItem('${v.$id}', 'sale')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;

                let pendente = getPendingCuotasSorted(v)[0];
                if (!pendente) {
                    l3.innerHTML += `<tr>
                        <td>${v.cliente}</td>
                        <td>${v.landNome}</td>
                        <td style="color:var(--success);font-weight:950">${fmtMoney(v.moneda, v.total)}</td>
                        <td><span class="status-badge status-disponible"><i class="fas fa-check"></i> PAGADO</span></td>
                        <td><button class="btn btn-g btn-sm" onclick="event.stopPropagation(); verDetalles('${v.$id}', 'sale')">Ver</button></td>
                    </tr>`;
                }
            });

            const cobranzasList = buildCobranzasListFiltered();
            renderDebtTotalIfNeeded(cobranzasList);
            renderVentasAlerts(cobranzasList);

            cobranzasList.forEach(item => {
                const v = item.v;
                const pendente = item.pendente;

                const cor = item.overdue ? 'red' : '#0f172a';
                const rowClass = item.overdue ? 'row-overdue' : (item.near ? 'row-near' : '');

                let labelExtra = '';
                if (item.overdue) {
                    const txt = (item.days === 0) ? 'VENCE HOY' : 'VENCIDA';
                    labelExtra = `<span class="status-badge" style="background:rgba(192,57,43,0.12); border:1px solid rgba(192,57,43,0.22); color:#7f1d1d;"><i class="fas fa-circle-exclamation"></i> ${txt}</span>`;
                } else if (item.near) {
                    labelExtra = `<span class="status-badge" style="background:rgba(243,156,18,0.18); border:1px solid rgba(243,156,18,0.28); color:#92400e;"><i class="fas fa-bell"></i> PRONTO</span>`;
                }

                l1.innerHTML += `<tr class="${rowClass}">
                    <td><strong>${v.cliente}</strong></td>
                    <td>${v.landNome}</td>
                    <td>${pendente.n}/${v.cuotas.length} ${labelExtra}</td>
                    <td style="color:${cor};font-weight:950">${pendente.venc}</td>
                    <td>${fmtMoney(v.moneda, pendente.valor)}</td>
                    <td style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-s btn-sm" onclick="openPagar('${v.$id}', ${pendente.n})">Cobrar</button>
                        <button class="btn btn-w btn-sm" onclick="openRenegociar('${v.$id}')" title="Renegociar deuda"><i class="fas fa-arrows-rotate"></i></button>
                    </td>
                </tr>`;
            });
        }

        window.openPagar = (vId, n) => {
            const v = vendas.find(x => x.$id === vId);
            const c = v.cuotas.find(x => x.n === n);
            document.getElementById('p-venda-id').value = vId;
            document.getElementById('p-cuota-idx').value = v.cuotas.indexOf(c);
            document.getElementById('p-valor-display').innerText = fmtMoney(v.moneda, c.valor);
            document.getElementById('p-valor-real').value = (parseFloat(c.valor) || 0).toFixed(2);
            document.getElementById('p-data').value = new Date().toISOString().split('T')[0];

            const isUsd = (v.moneda === 'USD');
            document.getElementById('div-tc').classList.toggle('hidden', !isUsd);
            if (isUsd) {
                document.getElementById('p-tc').value = (getTcRefBsPerUsd(v)).toFixed(2);
            }

            window.showPreview(document.getElementById('p-valor-real'), 'preview-p-valor', v.moneda);
            document.getElementById('modal-pagar').classList.remove('hidden');
        };

        // ===== Registrar Pago (CORREGIDO) =====
        document.getElementById('form-pagar').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 1. Obter IDs corretos dos inputs ocultos
            const vId = document.getElementById('p-venda-id').value;
            const idx = parseInt(document.getElementById('p-cuota-idx').value);

            if (!vId) return;

            // 2. Encontrar a venda
            const v = vendas.find(x => x.$id === vId);
            if (!v) { alert('Venta no encontrada'); return; }

            // 3. Obter valores do formulário (IDs corretos)
            const inputValor = document.getElementById('p-valor-real');
            const inputData = document.getElementById('p-data');
            const inputTc = document.getElementById('p-tc');
            
            const valorPago = parseFloat(inputValor.value);
            const dataPago = inputData.value; // YYYY-MM-DD
            
            // Verifica se TC está visível/preenchido
            let tcVal = null;
            if (!document.getElementById('div-tc').classList.contains('hidden')) {
                tcVal = parseFloat(inputTc.value);
            }

            if (!valorPago || valorPago <= 0) {
                alert('Por favor, ingrese un monto válido.');
                return;
            }

            document.getElementById('loader').classList.remove('hidden');

            try {
                // 4. Atualizar a parcela (Cuota)
                if (v.cuotas && v.cuotas[idx]) {
                    const c = v.cuotas[idx];
                    
                    c.pago = true;
                    c.valor_pago = valorPago; 
                    c.data_pago = dataPago;   
                    c.tc = tcVal;             

                    // Histórico de pagamentos
                    if (!c.pagos) c.pagos = [];
                    c.pagos.push({
                        fecha: new Date().toISOString(),
                        monto: valorPago,
                        tc: tcVal,
                        tipo: 'pago',
                        nota: 'Pago registrado manualmente',
                        antes: c.valor,
                        despues: 0
                    });
                }

                // 5. Salvar no banco de dados
                await db.updateDocument(DB_ID, COL_VENDAS, vId, { dados: JSON.stringify(v) });

                // 6. Limpeza e Reload
                closeModal('modal-pagar');
                document.getElementById('form-pagar').reset();
                alert('Pago registrado con éxito!');
                loadData(); 

            } catch (err) {
                console.error(err);
                alert('Error al guardar el pago: ' + err.message);
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        });

        // ------------------------------
        // RENEGOCIACIÓN (igual que tu lógica)
        // ------------------------------
        function round2(n) {
            const x = parseFloat(n);
            if (!isFinite(x)) return 0;
            return Math.round(x * 100) / 100;
        }

        function sumPaidCuotas(v) {
            let s = 0;
            (v.cuotas || []).forEach(c => {
                if (!c.pago) return;
                const val = (c.valor_pago !== undefined && c.valor_pago !== null) ? (parseFloat(c.valor_pago) || 0) : (parseFloat(c.valor) || 0);
                s += val;
            });
            return s;
        }

        function sumPendingCuotas(v) {
            let s = 0;
            (v.cuotas || []).forEach(c => {
                if (c.pago) return;
                s += (parseFloat(c.valor) || 0);
            });
            return s;
        }

        window.openRenegociar = (vId) => {
            const v = vendas.find(x => x.$id === vId);
            if (!v) return;

            const pending = getPendingCuotasSorted(v);
            if (!pending.length) {
                alert('Esta venta no tiene deuda pendiente.');
                return;
            }

            const saldo = sumPendingCuotas(v);
            const moneda = safeCurrency(v.moneda);

            document.getElementById('ren-venda-id').value = vId;
            document.getElementById('ren-info').innerText = `${v.cliente} • ${v.landNome}`;
            document.getElementById('ren-moneda').innerText = moneda;
            document.getElementById('ren-moneda2').innerText = moneda;

            document.getElementById('ren-saldo-actual').innerText = `${moneda} ${NF2.format(saldo)}`;
            document.getElementById('ren-cant-actual').innerText = `${pending.length}`;

            document.getElementById('ren-nuevo-saldo').value = round2(saldo).toFixed(2);
            document.getElementById('ren-ncuotas').value = Math.max(1, pending.length);

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('ren-fecha1').value = today;
            document.getElementById('ren-notas').value = '';

            renCalcPreview();

            document.getElementById('modal-reneg').classList.remove('hidden');
        };

        window.renCalcPreview = () => {
            try {
                const vId = document.getElementById('ren-venda-id').value;
                const v = vendas.find(x => x.$id === vId);
                if (!v) return;

                const moneda = safeCurrency(v.moneda);
                const nuevoSaldo = parseFloat(document.getElementById('ren-nuevo-saldo').value) || 0;
                const ncuotas = parseInt(document.getElementById('ren-ncuotas').value) || 1;
                const cuota = (ncuotas > 0) ? (nuevoSaldo / ncuotas) : nuevoSaldo;

                document.getElementById('ren-cuota-preview').innerText =
                    new Intl.NumberFormat('es-BO', { style: 'currency', currency: moneda }).format(cuota);
            } catch (e) {
                console.error('renCalcPreview', e);
            }
        };

        document.getElementById('form-reneg').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');

            const vId = document.getElementById('ren-venda-id').value;
            const v = vendas.find(x => x.$id === vId);
            if (!v) { document.getElementById('loader').classList.add('hidden'); return; }

            const nuevoSaldo = round2(parseFloat(document.getElementById('ren-nuevo-saldo').value) || 0);
            const ncuotas = Math.max(1, parseInt(document.getElementById('ren-ncuotas').value) || 1);
            const fecha1 = document.getElementById('ren-fecha1').value;
            const notas = document.getElementById('ren-notas').value || '';

            const moneda = safeCurrency(v.moneda);
            const today = new Date().toISOString().split('T')[0];

            const cuotasOld = Array.isArray(v.cuotas) ? v.cuotas : [];
            const paid = cuotasOld.filter(c => c.pago);
            const unpaid = cuotasOld.filter(c => !c.pago);
            const saldoAnterior = sumPendingCuotas(v);

            const baseDate = new Date(fecha1);
            let newCuotas = [];
            const maxN = cuotasOld.reduce((m, c) => Math.max(m, parseInt(c.n || 0) || 0), 0);

            for (let i = 0; i < ncuotas; i++) {
                const dt = new Date(baseDate);
                dt.setMonth(dt.getMonth() + i);
                newCuotas.push({
                    n: maxN + i + 1,
                    valor: round2(nuevoSaldo / ncuotas),
                    venc: dt.toISOString().split('T')[0],
                    pago: false,
                    renegociada: true
                });
            }

            const sumNew = newCuotas.reduce((s, c) => s + (parseFloat(c.valor) || 0), 0);
            const diff = round2(nuevoSaldo - sumNew);
            if (Math.abs(diff) >= 0.01 && newCuotas.length) {
                newCuotas[newCuotas.length - 1].valor = round2((parseFloat(newCuotas[newCuotas.length - 1].valor) || 0) + diff);
            }

            if (!Array.isArray(v.renegociaciones)) v.renegociaciones = [];
            v.renegociaciones.push({
                fecha: today,
                moneda: moneda,
                saldo_anterior: round2(saldoAnterior),
                cuotas_anterior: unpaid,
                nuevo_saldo: round2(nuevoSaldo),
                nuevas_cuotas: ncuotas,
                nuevo_vencimiento1: fecha1,
                notas: notas
            });

            v.cuotas = [...paid, ...newCuotas];

            v.cuotas.sort((a, b) => {
                const ad = parseDateYMD(a.venc);
                const bd = parseDateYMD(b.venc);
                if (ad && bd) return ad.getTime() - bd.getTime();
                if (ad && !bd) return -1;
                if (!ad && bd) return 1;
                return (parseInt(a.n || 0) - parseInt(b.n || 0));
            });

            const entrada = parseFloat(v.entrada) || 0;
            const paidSum = sumPaidCuotas(v);

            if (v.total_original === undefined || v.total_original === null) {
                v.total_original = v.total;
            }

            v.total = round2(entrada + paidSum + nuevoSaldo);

            const txtNote = `\n[Renegociación ${today}] Nuevo saldo: ${moneda} ${nuevoSaldo.toFixed(2)} • Cuotas: ${ncuotas} • 1er venc: ${fecha1}${notas ? ' • ' + notas : ''}`;
            v.notas = (v.notas || '') + txtNote;

            try {
                await db.updateDocument(DB_ID, COL_VENDAS, vId, { dados: JSON.stringify(v) });
                closeModal('modal-reneg');
                loadData();
            } finally {
                document.getElementById('loader').classList.add('hidden');
            }
        });

        window.openEdit = (id, type) => {
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            d.fotos = normalizeFotos(d.fotos);

            clearEditFilePool();

            document.getElementById('e-id').value = id;
            document.getElementById('e-type').value = type;
            document.getElementById('e-nome').value = (type === 'land') ? d.nome : d.cliente;
            document.getElementById('e-valor').value = (type === 'land') ? (parseFloat(d.precio)||0).toFixed(2) : (parseFloat(d.total)||0).toFixed(2);

            const monedaBadge = document.getElementById('e-moneda-badge');
            if (monedaBadge) {
                const mRaw = (type === 'land')
                    ? (d.moneda || 'BOB')
                    : (d.moneda || d.moneda_pago || d.moneda_base || 'BOB');
                monedaBadge.innerText = safeCurrency(mRaw);
            }
            document.getElementById('e-notas').value = (d.notas || '');

            const g = document.getElementById('e-gallery');
            g.innerHTML = '';

            d.fotos.forEach((u, i) => {
                const url = getFileUrl(u);
                const dlUrl = getFileDownloadUrl(u);
                const pdf = isPdfFile(u);
                const name = getFileName(u);

                let content = '';
                if (pdf) {
                    content = `
                        <div style="text-decoration:none; color:inherit; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; padding-top:6px; cursor:pointer;"
                             onclick='openFileViewer(${JSON.stringify(url)}, ${JSON.stringify(name)}, true, ${JSON.stringify(dlUrl)})'>
                            <i class="fas fa-file-pdf pdf-icon"></i>
                            <div class="file-name" title="${name}">${name}</div>
                        </div>
                    `;
                } else {
                    content = `
                        <img src="${url}" style="width:100%;height:100%;object-fit:cover;cursor:pointer;"
                             onclick='openFileViewer(${JSON.stringify(url)}, ${JSON.stringify(name)}, false, ${JSON.stringify(dlUrl)})'
                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;padding:10px;text-align:center;font-weight:900;color:#64748b;&quot;>Imagen no previsualizable</div>';">
                        <div class="file-name" title="${name}">${name}</div>
                    `;
                }

                g.innerHTML += `<div class="img-preview-box">
                    ${content}
                    <div class="btn-del-img" onclick="event.stopPropagation(); remFoto('${id}', '${type}', ${i})">X</div>
                </div>`;
            });

            renderEditFilePool();
            document.getElementById('modal-edit').classList.remove('hidden');
        };

        window.remFoto = async (id, type, i) => {
            if (!confirm("¿Borrar archivo?")) return;
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            d.fotos = normalizeFotos(d.fotos);
            d.fotos.splice(i, 1);
            await db.updateDocument(DB_ID, (type === 'land' ? COL_TERRENOS : COL_VENDAS), id, { dados: JSON.stringify(d) });
            closeModal('modal-edit');
            loadData();
        };

        document.getElementById('form-edit').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            const id = document.getElementById('e-id').value, type = document.getElementById('e-type').value;
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);

            d.fotos = normalizeFotos(d.fotos);

            const uploaded = await uploadFiles(editFilePool);
            d.fotos = [...d.fotos, ...normalizeFotos(uploaded)];

            d.notas = document.getElementById('e-notas').value;

            if (type === 'land') {
                d.nome = document.getElementById('e-nome').value;
                d.precio = parseFloat(document.getElementById('e-valor').value);
            } else {
                d.cliente = document.getElementById('e-nome').value;
                const newTotal = parseFloat(document.getElementById('e-valor').value);
                if (!isNaN(newTotal)) d.total = newTotal;
            }

            await db.updateDocument(DB_ID, (type === 'land' ? COL_TERRENOS : COL_VENDAS), id, { dados: JSON.stringify(d) });

            clearEditFilePool();
            closeModal('modal-edit');
            loadData();
        });

        window.deleteItem = async (id, type) => {
            if (!confirm("¿Eliminar?")) return;
            document.getElementById('loader').classList.remove('hidden');

            if (type === 'sale') {
                const v = vendas.find(x => x.$id === id);
                const t = terrenos.find(x => x.$id === v.landId);
                if (t) {
                    t.estado = 'Disponible';
                    t.reserva = null;
                    t.fotos = normalizeFotos(t.fotos);
                    await db.updateDocument(DB_ID, COL_TERRENOS, t.$id, { dados: JSON.stringify(t) });
                }
            }

            await db.deleteDocument(DB_ID, (type === 'land' ? COL_TERRENOS : COL_VENDAS), id);
            loadData();
        };

        window.verDetalles = (id, type) => {
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            d.fotos = normalizeFotos(d.fotos);

            let mediaHtml = '';
            d.fotos.forEach(u => {
                const url = getFileUrl(u);
                const dlUrl = getFileDownloadUrl(u);
                const pdf = isPdfFile(u);
                const name = getFileName(u);

                if (pdf) {
                    mediaHtml += `<div class="doc-link"
                        onclick='openFileViewer(${JSON.stringify(url)}, ${JSON.stringify(name)}, true, ${JSON.stringify(dlUrl)})'>
                        <i class="fas fa-file-pdf" style="color:var(--danger);font-size:1.2rem;"></i>
                        <span>${name}</span>
                    </div>`;
                } else {
                    mediaHtml += `<div style="display:block; cursor:pointer;"
                        onclick='openFileViewer(${JSON.stringify(url)}, ${JSON.stringify(name)}, false, ${JSON.stringify(dlUrl)})'>
                        <img src="${url}" class="img-full">
                    </div>`;
                }
            });

            const c = document.getElementById('detalles-contenido');

            if (type === 'land') {
                let reservaHtml = '';
                if (d.estado === 'Reservado' && d.reserva) {
                    const vence = d.reserva.vence ? ` • Vence: ${d.reserva.vence}` : '';
                    reservaHtml = `<p style="font-weight:900; color:#92400e; margin-top:6px;">
                        <strong>Reserva:</strong> ${d.reserva.cliente || '-'}${vence}
                    </p>`;
                }

                c.innerHTML = `<h2 style="font-weight:950; color:#0f172a; margin-bottom:8px;">${d.nome}</h2>
                   <p style="font-weight:900; color:#334155;"><strong>Precio:</strong> ${fmtMoney(d.moneda, d.precio)}</p>
                   <p style="font-weight:900; color:#334155;"><strong>Superficie:</strong> ${NF0.format(d.area)} m²</p>
                   <p style="font-weight:900; color:#334155;"><strong>Estado:</strong> ${d.estado}</p>
                   ${reservaHtml}
                   <p style="color:#334155; margin-top:6px;">${d.notas || ''}</p>
                   <hr style="margin:12px 0; border:0; border-top:1px solid rgba(15,23,42,0.08);">${mediaHtml}`;
            } else {
                /* FIX: Detalles de comprador (ventas) ahora muestra montos formateados con separadores */
                const moneda = safeCurrency(d.moneda);
                const entrada = parseFloat(d.entrada) || 0;
                const pagadoCuotas = sumPaidCuotas(d);
                const pagadoTotal = entrada + pagadoCuotas;
                const pendiente = sumPendingCuotas(d);

                let totalRefBs = parseFloat(d.total) || 0;
                if (moneda === 'USD') totalRefBs = totalRefBs * getTcRefBsPerUsd(d);

                const tcInfo = (moneda === 'USD')
                    ? `<p style="font-weight:900; color:#334155;"><strong>Tipo de Cambio (Ref):</strong> Bs ${NF2.format(getTcRefBsPerUsd(d))} / USD</p>`
                    : '';

                const notasHtml = (d.notas && String(d.notas).trim())
                    ? `<p style="color:#334155; margin-top:6px;"><strong>Notas:</strong> ${d.notas}</p>`
                    : '';

                c.innerHTML = `<h2 style="font-weight:950; color:#0f172a; margin-bottom:8px;">${d.cliente}</h2>
                   <p style="font-weight:900; color:#334155;"><strong>CI:</strong> ${d.ci || ''}</p>
                   <p style="font-weight:900; color:#334155;"><strong>Terreno:</strong> ${d.landNome || ''}</p>
                   <p style="font-weight:900; color:#334155;"><strong>Total Venta:</strong> ${fmtMoney(moneda, d.total)}</p>
                   <p style="font-weight:900; color:#334155;"><strong>Entrada:</strong> ${fmtMoney(moneda, entrada)}</p>
                   <p style="font-weight:900; color:#334155;"><strong>Pagado:</strong> ${fmtMoney(moneda, pagadoTotal)}</p>
                   <p style="font-weight:900; color:#334155;"><strong>Pendiente:</strong> ${fmtMoney(moneda, pendiente)}</p>
                   <p style="font-weight:900; color:#334155;"><strong>Total (Ref. Bs):</strong> ${fmtBs(totalRefBs)}</p>
                   ${tcInfo}
                   ${notasHtml}
                   <hr style="margin:12px 0; border:0; border-top:1px solid rgba(15,23,42,0.08);">${mediaHtml}`;
            }

            document.getElementById('modal-detalles').classList.remove('hidden');
        };

             // ===== Reporte de Pagos (CORREGIDO) =====

        // Função auxiliar para evitar erro de texto vazio
        function safeStr(str) { return str || ''; }

        const _fmtDateTime = (iso) => {
          if (!iso) return '';
          try {
            const d = new Date(iso);
            if (isNaN(d.getTime())) return iso;
            return d.toLocaleString('es-BO', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
          } catch { return iso; }
        };

        const _tipoPagoLabel = (tipo) => {
          const map = {
            pago: 'Pago',
            pago_parcial: 'Pago parcial',
            amortizacion: 'Amortización',
            pago_legacy: 'Pago (registro anterior)',
            saldo_favor: 'Saldo a favor'
          };
          return map[tipo] || tipo || '';
        };

        const _entriesPagoDeVenta = (v) => {
          const entries = [];
          // Busca o nome do terreno na lista global usando landId
          const t = (window.terrenos || []).find(x => x.$id === v.landId);
          const terrenoNom = t ? t.nome : (v.landNome || '—');

          const cuotas = Array.isArray(v.cuotas) ? v.cuotas : [];
          
          cuotas.forEach((c, idx) => {
            const n = (c.n || (idx + 1));
            
            // Caso 1: Pagamentos detalhados (novo sistema)
            if (Array.isArray(c.pagos) && c.pagos.length) {
              c.pagos.forEach(p => {
                entries.push({
                  fecha: p.fecha || p.ts || '',
                  monto: Number(p.monto || 0),
                  tc: (p.tc ?? ''),
                  tipo: p.tipo || '',
                  nota: p.nota || '',
                  cuota: n,
                  terreno: terrenoNom
                });
              });
            } 
            // Caso 2: Pagamento legado (sistema antigo)
            else if (c.pago) {
              entries.push({
                fecha: c.data_pago || v.data || '',
                monto: Number(c.valor_pago || c.valor || 0),
                tc: (c.tc ?? ''),
                tipo: 'pago_legacy',
                nota: 'Pago registrado',
                cuota: n,
                terreno: terrenoNom
              });
            }
          });

          // Saldo a favor
          if (Array.isArray(v.saldo_favor_hist) && v.saldo_favor_hist.length) {
            v.saldo_favor_hist.forEach(s => {
              entries.push({
                fecha: s.fecha || '',
                monto: Number(s.monto || 0),
                tc: (s.tc ?? ''),
                tipo: 'saldo_favor',
                nota: s.nota || '',
                cuota: '—',
                terreno: terrenoNom
              });
            });
          }
          return entries;
        };

        window.openReportePagosCliente = (saleId) => {
          const v0 = (window.vendas || []).find(x => x.$id === saleId);
          if (!v0) { alert('Venta no encontrada'); return; }

          const cliente = (v0.cliente || '').trim();
          const ventasCliente = (window.vendas || []).filter(v => (v.cliente || '').trim().toLowerCase() === cliente.toLowerCase());

          let entries = [];
          ventasCliente.forEach(v => { entries = entries.concat(_entriesPagoDeVenta(v)); });

          // Ordenar: mais recente primeiro
          entries.sort((a, b) => {
            const da = a.fecha ? new Date(a.fecha).getTime() : 0;
            const db = b.fecha ? new Date(b.fecha).getTime() : 0;
            return db - da;
          });

          const title = document.getElementById('reporte-pagos-title');
          const subtitle = document.getElementById('reporte-pagos-subtitle');
          const content = document.getElementById('reporte-pagos-content');

          title.textContent = `Historial: ${cliente || 'Cliente'}`;
          subtitle.innerHTML = `
            <div><b>Cliente:</b> ${safeStr(cliente || '—')}</div>
            <div><b>Registros:</b> ${entries.length}</div>
          `;

          if (!entries.length) {
            content.innerHTML = `<div class="hint-box">No hay pagos registrados.</div>`;
            document.getElementById('modal-reporte-pagos').classList.remove('hidden');
            return;
          }

          const total = entries.reduce((s, e) => s + (Number(e.monto) || 0), 0);

          let html = `
            <div style="margin-bottom:12px;">
               <span class="status-badge status-disponible" style="font-size:1rem;">Total Pagado: Bs ${NF2.format(total)}</span>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Terreno</th>
                    <th>Cuota</th>
                    <th>Tipo</th>
                    <th>Monto</th>
                    <th>Nota</th>
                  </tr>
                </thead>
                <tbody>
          `;

          entries.forEach(e => {
            html += `
              <tr>
                <td>${safeStr(_fmtDateTime(e.fecha))}</td>
                <td>${safeStr(e.terreno)}</td>
                <td>${safeStr(String(e.cuota))}</td>
                <td>${safeStr(_tipoPagoLabel(e.tipo))}</td>
                <td style="font-weight:900; color:var(--success);">Bs ${NF2.format(Number(e.monto) || 0)}</td>
                <td style="font-size:0.85rem; color:#64748b;">${safeStr(e.nota)}</td>
              </tr>
            `;
          });

          html += `</tbody></table></div>`;
          content.innerHTML = html;
          document.getElementById('modal-reporte-pagos').classList.remove('hidden');
        };


        window.nav = (v) => {
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-' + v).classList.remove('hidden');
            document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + v).classList.add('active');

            const titles = { resumen: "Resumen General", registro: "Registrar Terreno", listado: "Inventario", ventas: "Ventas" };
            document.getElementById('page-title').innerText = titles[v] || "Panel";

            if (v === 'listado') renderTerrenos();
            if (v === 'ventas') renderVendas();
            if (isMobile()) closeMobileMenu();
        };

        window.switchVendas = (t) => {
            document.getElementById('tab-vendas-resumo').classList.add('hidden');
            document.getElementById('tab-vendas-hist').classList.add('hidden');
            document.getElementById('tab-vendas-completos').classList.add('hidden');
            document.getElementById('tab-vendas-' + t).classList.remove('hidden');
        };

        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            if (id === 'modal-edit') clearEditFilePool();
        };

        window.showPreview = (i, id, type) => {
            let val = parseFloat(i.value);
            if (isNaN(val)) val = 0;
            let res = '';
            if (type === 'm²') res = NF2.format(val) + ' m²';
            else res = new Intl.NumberFormat('es-BO', { style: 'currency', currency: (type === 'Ref' || type.length > 3) ? 'BOB' : type }).format(val);
            if (type === 'Ref') res = res.replace('Bs', '');
            document.getElementById(id).innerText = res;
        };

        window.calcLive = () => {
            const p = parseFloat(document.getElementById('v-total').value) || 0,
                  e = parseFloat(document.getElementById('v-entrada').value) || 0,
                  c = parseInt(document.getElementById('v-ncuotas').value) || 1;
            const m = document.getElementById('lbl-moneda-venda').innerText || 'BOB';
            document.getElementById('live-result-text').innerText =
                new Intl.NumberFormat('es-BO', { style: 'currency', currency: m }).format((p - e) / c);
        };

        function updateDashboard() {
            const total = terrenos.length;
            const disp = terrenos.filter(t => t.estado === 'Disponible').length;
            const reserv = terrenos.filter(t => t.estado === 'Reservado').length;
            const vend = terrenos.filter(t => t.estado === 'Vendido').length;

            document.getElementById('kpi-total').innerText = total;
            document.getElementById('kpi-disp').innerText = disp;
            document.getElementById('kpi-vendidos').innerText = vend;
            document.getElementById('kpi-reservados-mini').innerText = reserv;

            const s = document.getElementById('filter-date-start').value,
                  e = document.getElementById('filter-date-end').value;

            const start = s ? new Date(s) : new Date(0),
                  end = e ? new Date(e) : new Date(8640000000000000);
            end.setHours(23, 59, 59, 999);

            let rec = 0;
            vendas.forEach(v => {
                let dEnt = v.fecha_entrada ? new Date(v.fecha_entrada) : new Date(v.data);
                if (dEnt >= start && dEnt <= end) {
                    let pg = v.entrada;
                    if (v.moneda === 'USD') pg *= getTcRefBsPerUsd(v);
                    rec += pg;
                }
                (v.cuotas || []).forEach(c => {
                    if (c.pago && c.data_pago) {
                        let dC = new Date(c.data_pago);
                        if (dC >= start && dC <= end) {
                            let val = c.valor_pago || c.valor;
                            if (v.moneda === 'USD') val *= (c.tc || getTcRefBsPerUsd(v));
                            rec += val;
                        }
                    }
                });
            });

            document.getElementById('kpi-money').innerText = fmtBs(rec);

            const ctx1 = document.getElementById('chart-fin').getContext('2d');
            if (window.ch1) window.ch1.destroy();
            window.ch1 = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Disponible', 'Reservado', 'Vendido'],
                    datasets: [{
                        data: [disp, reserv, vend],
                        backgroundColor: ['#27ae60', '#f39c12', '#7f8c8d']
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        /* =========================================================
           REPORTES (PDF/CSV) SIN POPUPS (descarga directa)
        ========================================================= */
        function getReportPeriod() {
            const rs = document.getElementById('rep-start')?.value || document.getElementById('filter-date-start')?.value || '';
            const re = document.getElementById('rep-end')?.value || document.getElementById('filter-date-end')?.value || '';
            return { rs, re };
        }

        window.openReportesModal = () => {
            const { rs, re } = getReportPeriod();
            const rsEl = document.getElementById('rep-start');
            const reEl = document.getElementById('rep-end');
            if (rsEl && rs) rsEl.value = rs;
            if (reEl && re) reEl.value = re;
            document.getElementById('modal-reportes').classList.remove('hidden');
        };

        function downloadTextFile(filename, content, mime='text/plain;charset=utf-8') {
            try {
                const blob = new Blob([content], { type: mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 800);
            } catch (e) {
                alert('No se pudo descargar el archivo.\n' + (e?.message || e));
            }
        }

        function ymdToday() {
            return new Date().toISOString().split('T')[0];
        }

        function recaudacionRefBsEnPeriodo(startYmd, endYmd) {
            const start = startYmd ? new Date(startYmd) : new Date(0);
            const end = endYmd ? new Date(endYmd) : new Date(8640000000000000);
            end.setHours(23,59,59,999);

            let rec = 0;
            vendas.forEach(v => {
                let dEnt = v.fecha_entrada ? new Date(v.fecha_entrada) : new Date(v.data);
                if (dEnt >= start && dEnt <= end) {
                    let pg = parseFloat(v.entrada)||0;
                    if (safeCurrency(v.moneda) === 'USD') pg *= getTcRefBsPerUsd(v);
                    rec += pg;
                }
                (v.cuotas || []).forEach(c => {
                    if (c.pago && c.data_pago) {
                        let dC = new Date(c.data_pago);
                        if (dC >= start && dC <= end) {
                            let val = (c.valor_pago !== undefined && c.valor_pago !== null) ? (parseFloat(c.valor_pago)||0) : (parseFloat(c.valor)||0);
                            if (safeCurrency(v.moneda) === 'USD') val *= (parseFloat(c.tc)||getTcRefBsPerUsd(v));
                            rec += val;
                        }
                    }
                });
            });
            return rec;
        }

        function ventaStats(v) {
            const moneda = safeCurrency(v.moneda);
            const entrada = parseFloat(v.entrada)||0;
            const pagadoCuotas = sumPaidCuotas(v);
            const pagado = entrada + pagadoCuotas;
            const pendiente = sumPendingCuotas(v);

            let totalRefBs = (parseFloat(v.total)||0);
            let pagadoRefBs = pagado;
            let pendienteRefBs = pendiente;
            if (moneda === 'USD') {
                const tc = getTcRefBsPerUsd(v);
                totalRefBs *= tc;
                pagadoRefBs *= tc;
                pendienteRefBs *= tc;
            }

            return { moneda, entrada, pagadoCuotas, pagado, pendiente, totalRefBs, pagadoRefBs, pendienteRefBs };
        }

        window.exportReporteRecaudacionCSV = () => {
            const { rs, re } = getReportPeriod();
            const rec = recaudacionRefBsEnPeriodo(rs, re);
            const lines = [];
            lines.push('PeriodoDesde,PeriodoHasta,RecaudacionRefBs');
            lines.push(`${rs||''},${re||''},${NF2.format(rec)}`);
            downloadTextFile(`recaudacion_${rs||'inicio'}_a_${re||'hoy'}.csv`, lines.join('\n'), 'text/csv;charset=utf-8');
        };

        window.exportInventarioCSV = () => {
            const lines = [];
            lines.push('Codigo,Nombre,Superficie_m2,Moneda,Precio,Estado,ReservadoCliente,ReservadoVence');
            terrenos.forEach(t => {
                const rcli = (t.reserva && t.reserva.cliente) ? String(t.reserva.cliente).replace(/,/g,' ') : '';
                const rv = (t.reserva && t.reserva.vence) ? t.reserva.vence : '';
                lines.push([
                    (t.codigo||'').replace(/,/g,' '),
                    (t.nome||'').replace(/,/g,' '),
                    (isFinite(parseFloat(t.area)) ? parseFloat(t.area) : ''),
                    safeCurrency(t.moneda),
                    (isFinite(parseFloat(t.precio)) ? parseFloat(t.precio).toFixed(2) : ''),
                    (t.estado||''),
                    rcli,
                    rv
                ].join(','));
            });
            downloadTextFile(`inventario_${ymdToday()}.csv`, lines.join('\n'), 'text/csv;charset=utf-8');
        };

        window.exportVentasCSV = () => {
            const lines = [];
            lines.push('Cliente,CI,Terreno,Moneda,Total,Entrada,Pagado,Pendiente,TotalRefBs,PendienteRefBs,TC_Ref');
            vendas.forEach(v => {
                const st = ventaStats(v);
                lines.push([
                    (v.cliente||'').replace(/,/g,' '),
                    (v.ci||'').replace(/,/g,' '),
                    (v.landNome||'').replace(/,/g,' '),
                    st.moneda,
                    (parseFloat(v.total)||0).toFixed(2),
                    st.entrada.toFixed(2),
                    st.pagado.toFixed(2),
                    st.pendiente.toFixed(2),
                    st.totalRefBs.toFixed(2),
                    st.pendienteRefBs.toFixed(2),
                    (st.moneda==='USD' ? getTcRefBsPerUsd(v).toFixed(2) : '')
                ].join(','));
            });
            downloadTextFile(`ventas_${ymdToday()}.csv`, lines.join('\n'), 'text/csv;charset=utf-8');
        };

        function pdfDoc() {
            const { jsPDF } = window.jspdf || {};
            if (!jsPDF) throw new Error('jsPDF no se cargó. Revisa la conexión o el CDN.');
            return new jsPDF({ unit: 'pt', format: 'a4' });
        }

        function addPdfHeader(doc, title) {
            doc.setFontSize(16);
            doc.text(String(title || 'Reporte'), 40, 40);
            doc.setFontSize(10);
            doc.text(`Generado: ${new Date().toLocaleString('es-BO')}`, 40, 58);
            doc.line(40, 68, 555, 68);
        }

        window.exportInventarioPDF = () => {
            try {
                const doc = pdfDoc();
                addPdfHeader(doc, 'Inventario de Terrenos (Corvacruz)');

                const body = terrenos.map(t => ([
                    t.codigo || '',
                    t.nome || '',
                    `${NF0.format(t.area||0)}`,
                    safeCurrency(t.moneda),
                    `${NF2.format(parseFloat(t.precio)||0)}`,
                    t.estado || ''
                ]));

                doc.autoTable({
                    startY: 85,
                    head: [['Código','Nombre','m²','Moneda','Precio','Estado']],
                    body,
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [15, 23, 42] },
                    margin: { left: 40, right: 40 }
                });

                doc.save(`inventario_${ymdToday()}.pdf`);
            } catch (e) {
                alert('No se pudo generar el PDF.\n' + (e?.message || e));
            }
        };

        window.exportVentasPDF = () => {
            try {
                const doc = pdfDoc();
                addPdfHeader(doc, 'Reporte de Ventas (Corvacruz)');

                const body = vendas.map(v => {
                    const st = ventaStats(v);
                    return [
                        v.cliente || '',
                        v.landNome || '',
                        st.moneda,
                        NF2.format(parseFloat(v.total)||0),
                        NF2.format(st.pagado),
                        NF2.format(st.pendiente),
                        NF2.format(st.totalRefBs)
                    ];
                });

                doc.autoTable({
                    startY: 85,
                    head: [['Cliente','Terreno','Moneda','Total','Pagado','Pendiente','Total Ref. Bs']],
                    body,
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [15, 23, 42] },
                    margin: { left: 40, right: 40 }
                });

                doc.save(`ventas_${ymdToday()}.pdf`);
            } catch (e) {
                alert('No se pudo generar el PDF.\n' + (e?.message || e));
            }
        };

        window.exportReporteGeneralPDF = () => {
            try {
                const { rs, re } = getReportPeriod();
                const doc = pdfDoc();
                addPdfHeader(doc, 'Reporte General (Corvacruz)');

                const total = terrenos.length;
                const disp = terrenos.filter(t => t.estado === 'Disponible').length;
                const reserv = terrenos.filter(t => t.estado === 'Reservado').length;
                const vend = terrenos.filter(t => t.estado === 'Vendido').length;

                const rec = recaudacionRefBsEnPeriodo(rs, re);

                doc.setFontSize(11);
                doc.text(`Período recaudación: ${rs || '-'} a ${re || '-'}`, 40, 90);
                doc.text(`Terrenos: Total ${total} | Disponibles ${disp} | Reservados ${reserv} | Vendidos ${vend}`, 40, 110);
                doc.text(`Recaudado (Ref. Bs): ${NF2.format(rec)}`, 40, 130);

                const resumenVentas = vendas.map(v => {
                    const st = ventaStats(v);
                    return [
                        v.cliente || '',
                        v.landNome || '',
                        st.moneda,
                        NF2.format(parseFloat(v.total)||0),
                        NF2.format(st.pagado),
                        NF2.format(st.pendiente),
                        NF2.format(st.pendienteRefBs)
                    ];
                });

                doc.autoTable({
                    startY: 150,
                    head: [['Cliente','Terreno','Moneda','Total','Pagado','Pendiente','Pendiente Ref. Bs']],
                    body: resumenVentas,
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [41, 128, 185] },
                    margin: { left: 40, right: 40 }
                });

                doc.save(`reporte_general_${ymdToday()}.pdf`);
            } catch (e) {
                alert('No se pudo generar el PDF.\n' + (e?.message || e));
            }
        };

        window.exportReporteGeneralPDF = window.exportReporteGeneralPDF; // asegurar

        /* ========================================================= */

        window.switchVendas = window.switchVendas; // keep

        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
            if (id === 'modal-edit') clearEditFilePool();
        };

    </script>
</body>
</html>