<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inmobiliario - Corvac (Seguro & Completo)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- 1. VARIÁVEIS DE CORES & GERAL --- */
        :root {
            --primary: #2c3e50;    /* Azul Escuro (Menu) */
            --secondary: #34495e;  /* Azul Petróleo (Menu Hover) */
            --accent: #2980b9;     /* Azul Destaque (Botões Principais) */
            --success: #27ae60;    /* Verde (Sucesso/Dinheiro) */
            --warning: #f39c12;    /* Laranja (Edição/Atenção) */
            --danger: #c0392b;     /* Vermelho (Excluir/Erro) */
            --light: #f4f6f9;      /* Fundo da Página */
            --white: #ffffff;      /* Branco Puro */
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--light);
            color: #333;
            height: 100vh; /* Tela Cheia */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- 2. UTILITÁRIOS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .gap-2 { gap: 10px; }
        .w-100 { width: 100%; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* --- 3. BOTÕES --- */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #fff;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-p { background-color: var(--accent); }
        .btn-s { background-color: var(--success); }
        .btn-d { background-color: var(--danger); }
        .btn-w { background-color: var(--warning); }
        .btn-g { background-color: #7f8c8d; }

        /* --- 4. TELA DE LOGIN --- */
        #login-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            width: 400px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }

        /* --- 5. FORMULÁRIOS --- */
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        .input-group input:focus { border-color: var(--accent); outline: none; }

        /* --- 6. LAYOUT PRINCIPAL --- */
        #app-container { display: flex; flex: 1; overflow: hidden; }

        /* Menu Lateral */
        aside {
            width: 260px;
            background-color: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        aside h3 { padding: 25px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px; }
        .menu button {
            width: 100%;
            padding: 15px 25px;
            background: none;
            border: none;
            color: #bdc3c7;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }
        .menu button:hover, .menu button.active {
            background-color: var(--secondary);
            color: white;
            border-left: 5px solid var(--accent);
            padding-left: 20px; /* Efeito visual */
        }
        .menu i { margin-right: 15px; width: 20px; text-align: center; }

        /* Área Principal */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--light); }
        header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        #content { flex: 1; padding: 30px; overflow-y: auto; }

        /* Cards & Tabelas */
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: var(--primary); font-weight: bold; }
        tr:hover { background-color: #f1f2f6; }

        /* Galeria e Fotos */
        .thumb-small {
            width: 60px; height: 60px; object-fit: cover;
            border-radius: 6px; border: 1px solid #ddd;
            cursor: pointer; background: #fff;
            transition: transform 0.2s;
        }
        .thumb-small:hover { transform: scale(3.0); z-index: 100; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        .gallery { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .img-preview-box { position: relative; width: 100px; height: 100px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .img-preview-box img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        .btn-del-img {
            position: absolute; top: 0; right: 0;
            background: rgba(255, 0, 0, 0.8); color: white;
            width: 25px; height: 25px;
            text-align: center; line-height: 25px;
            cursor: pointer; font-weight: bold;
        }
        .img-full { width: 100%; max-height: 500px; object-fit: contain; margin-bottom: 20px; border: 1px solid #eee; }

        /* Loader & Modais */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; font-weight: bold; color: var(--accent);
        }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2500;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 12px;
            width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;
        }
        .close-modal { background: none; border: none; font-size: 2rem; cursor: pointer; line-height: 1; color: #999; }
        
        .live-calc-box { background: #e8f6f3; padding: 15px; border-radius: 6px; margin-top: 15px; text-align: center; border: 1px solid #a2d9ce; }
        .live-result { font-size: 1.5rem; font-weight: bold; color: var(--success); }
        
        /* CORREÇÃO DO GRÁFICO */
        .chart-container { position: relative; height: 250px; width: 100%; display:flex; justify-content:center; }
    </style>
</head>
<body>

    <div id="loader" class="hidden">
        <i class="fas fa-spinner fa-spin fa-4x"></i>
        <p style="margin-top:15px; font-size:1.2rem;">Procesando datos...</p>
    </div>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:10px;">Sistema Inmobiliario</h2>
            <p style="color:#666; margin-bottom:25px;">Acceso Seguro Multi-Empresa</p>
            <form id="form-login">
                <div class="input-group">
                    <label>Correo Electrónico</label>
                    <input type="email" id="email" required placeholder="tu@empresa.com">
                </div>
                <div class="input-group">
                    <label>Contraseña</label>
                    <input type="password" id="password" required placeholder="******">
                </div>
                <button type="submit" class="btn btn-p w-100">Ingresar al Sistema</button>
                <p id="login-msg" style="color:var(--danger); margin-top:15px; font-weight:bold;"></p>
                <p style="margin-top:20px; font-size:0.9rem; color:#888;">
                    <i class="fas fa-info-circle"></i> Si no tienes cuenta, el sistema creará una automáticamente al ingresar.
                </p>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <aside>
            <h3><i class="fas fa-building"></i> Corvac Panel</h3>
            <div class="menu">
                <button id="btn-resumen" onclick="nav('resumen')" class="active"><i class="fas fa-chart-pie"></i> Resumen General</button>
                <button id="btn-registro" onclick="nav('registro')"><i class="fas fa-plus-circle"></i> Registrar Terreno</button>
                <button id="btn-listado" onclick="nav('listado')"><i class="fas fa-list"></i> Inventario Completo</button>
                <button id="btn-ventas" onclick="nav('ventas')"><i class="fas fa-file-invoice-dollar"></i> Ventas y Cobranzas</button>
            </div>
        </aside>
        
        <main>
            <header>
                <h2 id="page-title" style="color:var(--primary)">Resumen General</h2>
                <div class="flex" style="align-items:center; gap:15px;">
                    <span id="user-email-display" style="font-weight:bold; color:#555;"></span>
                    <button onclick="logout()" class="btn btn-g"><i class="fas fa-sign-out-alt"></i> Salir</button>
                </div>
            </header>
            
            <div id="content">
                
                <div id="view-resumen">
                    <div class="flex gap-2" style="margin-bottom:30px; flex-wrap:wrap;">
                        <div class="card" style="flex:1; text-align:center; min-width:250px;">
                            <h3>Total Terrenos</h3>
                            <h1 id="kpi-total" style="font-size:3rem; margin:10px 0;">0</h1>
                        </div>
                        <div class="card" style="flex:1; text-align:center; min-width:250px;">
                            <h3>Disponibles</h3>
                            <h1 id="kpi-disp" style="font-size:3rem; margin:10px 0; color:var(--success)">0</h1>
                        </div>
                        <div class="card" style="flex:1; text-align:center; min-width:250px;">
                            <h3>Recaudado (Ref. Bs)</h3>
                            <h1 id="kpi-money" style="font-size:2.5rem; margin:10px 0; color:var(--accent)">0</h1>
                        </div>
                    </div>
                    <div class="card">
                        <div class="chart-container">
                            <canvas id="chart-fin"></canvas>
                        </div>
                    </div>
                </div>

                <div id="view-registro" class="hidden">
                    <div class="card">
                        <h3 style="margin-bottom:20px;">Registrar Nuevo Terreno</h3>
                        <form id="form-terreno">
                            <div class="flex gap-2">
                                <div class="input-group w-100">
                                    <label>Código Interno</label>
                                    <input type="text" id="t-codigo" required placeholder="Ej: L-104">
                                </div>
                                <div class="input-group w-100">
                                    <label>Nombre / Ubicación</label>
                                    <input type="text" id="t-nome" required placeholder="Ej: Lote Esquina Norte">
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <div class="input-group w-100">
                                    <label>Superficie (m²)</label>
                                    <input type="number" id="t-area">
                                </div>
                                <div class="input-group w-100">
                                    <label>Moneda</label>
                                    <select id="t-moeda" onchange="window.showPreview(document.getElementById('t-precio'), 'preview-precio-t', this.value)">
                                        <option value="BOB">Bolivianos (Bs)</option>
                                        <option value="USD">Dólar ($us)</option>
                                    </select>
                                </div>
                                <div class="input-group w-100">
                                    <label>Precio Base</label>
                                    <input type="number" id="t-precio" required min="0" oninput="window.showPreview(this, 'preview-precio-t', document.getElementById('t-moeda').value)">
                                    <small id="preview-precio-t" style="color:green; font-weight:bold;">0,00</small>
                                </div>
                            </div>
                            <div class="input-group">
                                <label><i class="fas fa-camera"></i> Fotos del Terreno</label>
                                <input type="file" id="t-files" multiple accept="image/*">
                            </div>
                            <div class="input-group">
                                <label>Notas Adicionales</label>
                                <textarea id="t-notas" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-s w-100" style="font-size:1.1rem;">Guardar Terreno (Privado)</button>
                        </form>
                    </div>
                </div>

                <div id="view-listado" class="hidden">
                    <div class="card">
                        <div class="flex justify-between" style="margin-bottom:15px; align-items:center;">
                            <h3>Inventario de Propiedades</h3>
                            <input type="text" id="search-land" placeholder="Buscar por nombre o código..." style="padding:10px; width:300px; border:1px solid #ddd; border-radius:4px;" onkeyup="renderTerrenos()">
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Imagen</th>
                                    <th>Código</th>
                                    <th>Nombre</th>
                                    <th>Precio</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="lista-terrenos">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="view-ventas" class="hidden">
                    <div class="card">
                        <div class="flex gap-2" style="margin-bottom:20px;">
                            <button onclick="switchVendas('resumo')" class="btn btn-p"><i class="fas fa-file-invoice-dollar"></i> Cobranzas (Resumen)</button>
                            <button onclick="switchVendas('hist')" class="btn btn-g"><i class="fas fa-history"></i> Historial / Editar</button>
                            <button onclick="loadData()" class="btn btn-w" title="Recargar"><i class="fas fa-sync"></i> Actualizar</button>
                        </div>

                        <div id="tab-vendas-resumo">
                            <input type="text" id="search-venda" placeholder="Buscar cliente..." style="width:100%; padding:12px; margin-bottom:15px; border:1px solid #ddd;" onkeyup="renderVendas()">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        <th>Terreno</th>
                                        <th>Cuota</th>
                                        <th>Vencimiento</th>
                                        <th>Monto</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-cobrancas"></tbody>
                            </table>
                        </div>

                        <div id="tab-vendas-hist" class="hidden">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID Venta</th>
                                        <th>Cliente</th>
                                        <th>Terreno</th>
                                        <th>Total Venta</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-historico"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="modal-venda" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-handshake"></i> Realizar Venta</h3>
                <button class="close-modal" onclick="closeModal('modal-venda')">&times;</button>
            </div>
            <form id="form-venda">
                <input type="hidden" id="v-land-id">
                <div style="background:#eef; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #ccd;">
                    Terreno Seleccionado: <strong id="v-land-info" style="font-size:1.1rem; color:var(--primary);"></strong>
                </div>
                
                <div class="flex gap-2">
                    <div class="input-group w-100"><label>Nombre Cliente</label><input type="text" id="v-cliente" required></div>
                    <div class="input-group w-100"><label>CI / Documento</label><input type="text" id="v-ci"></div>
                </div>
                
                <div class="input-group">
                    <label>Documentos / Fotos del Cliente</label>
                    <input type="file" id="v-files" multiple accept="image/*">
                </div>
                
                <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                
                <div class="flex gap-2">
                    <div class="input-group w-100"><label>Precio Final Negociado</label><input type="number" id="v-total" required oninput="window.calcLive()"></div>
                    <div class="input-group w-100"><label>Entrada (Pago Inicial)</label><input type="number" id="v-entrada" value="0" oninput="window.calcLive()"></div>
                </div>
                
                <div class="flex gap-2">
                    <div class="input-group w-100"><label>Nº Cuotas</label><input type="number" id="v-ncuotas" value="12" oninput="window.calcLive()"></div>
                    <div class="input-group w-100"><label>Fecha 1er Vencimiento</label><input type="date" id="v-data1" required></div>
                </div>
                
                <div class="live-calc-box">
                    <h4>Cuota Mensual Estimada</h4>
                    <div id="live-result-text" class="live-result">0,00</div>
                </div>

                <div class="text-right" style="margin-top:20px;">
                    <button type="button" onclick="closeModal('modal-venda')" class="btn btn-g">Cancelar</button>
                    <button type="submit" class="btn btn-p">Confirmar Venta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-pagar" class="modal hidden">
        <div class="modal-content" style="max-width:450px;">
            <div class="modal-header">
                <h3><i class="fas fa-money-bill-wave"></i> Registrar Pago</h3>
                <button class="close-modal" onclick="closeModal('modal-pagar')">&times;</button>
            </div>
            <form id="form-pagar">
                <input type="hidden" id="p-venda-id">
                <input type="hidden" id="p-cuota-idx">
                
                <div style="text-align:center; margin:20px 0; background:#f9f9f9; padding:20px; border-radius:8px;">
                    <h2 id="p-valor-display" style="color:var(--success); font-size:2rem;"></h2>
                    <small style="color:#666; font-weight:bold;">Valor Original de la Cuota</small>
                </div>

                <div class="input-group">
                    <label>Monto a Pagar Ahora (Amortizable)</label>
                    <input type="number" id="p-valor-real" step="0.01" required style="font-size:1.4rem; font-weight:bold; color:green; text-align:center;">
                    <small style="color:#666; display:block; margin-top:5px;">Si el cliente paga más, el saldo reduce las siguientes cuotas automáticamente.</small>
                </div>

                <div id="div-tc" class="input-group hidden" style="background:#fff3cd; padding:15px; border-radius:6px; border:1px solid #ffeeba;">
                    <label>Tipo de Cambio del Día (Bs/USD)</label>
                    <input type="number" id="p-tc" value="6.96" step="0.01" style="font-weight:bold;">
                </div>

                <div class="input-group">
                    <label>Fecha del Pago</label>
                    <input type="date" id="p-data" required>
                </div>
                
                <button type="submit" class="btn btn-s w-100" style="margin-top:10px;">Confirmar Recepción</button>
            </form>
        </div>
    </div>

    <div id="modal-edit" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar / Detalles</h3>
                <button class="close-modal" onclick="closeModal('modal-edit')">&times;</button>
            </div>
            <form id="form-edit">
                <input type="hidden" id="e-id">
                <input type="hidden" id="e-type">
                
                <div class="input-group"><label>Nombre / Cliente</label><input type="text" id="e-nome"></div>
                <div class="input-group"><label>Valor / Precio</label><input type="number" id="e-valor"></div>
                <div class="input-group"><label>Notas / Observaciones</label><textarea id="e-notas" rows="4"></textarea></div>
                
                <label style="font-weight:bold;">Galeria de Imágenes (Click para ver, X para borrar):</label>
                <div id="e-gallery" class="gallery"></div>
                
                <div class="input-group" style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                    <label><i class="fas fa-plus"></i> Agregar nuevas fotos</label>
                    <input type="file" id="e-new-files" multiple accept="image/*">
                </div>

                <div class="text-right" style="margin-top:20px;">
                    <button type="button" onclick="closeModal('modal-edit')" class="btn btn-g">Cerrar</button>
                    <button type="submit" class="btn btn-p">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-detalles" class="modal hidden">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header">
                <h3>Detalles Completos</h3>
                <button class="close-modal" onclick="closeModal('modal-detalles')">&times;</button>
            </div>
            <div id="detalles-contenido"></div>
        </div>
    </div>

    <script>
        // --- 1. INICIALIZAÇÃO DO APPWRITE ---
        const { Client, Account, Databases, Storage, ID, Query, Permission, Role } = Appwrite;
        const client = new Client();

        // SEUS DADOS DE CONEXÃO (CORRIGIDOS PARA NYC)
        const PROJECT_ID = '693b19f6002a7ae91448'; 
        client
            .setEndpoint('https://nyc.cloud.appwrite.io/v1') // Endpoint Correto
            .setProject(PROJECT_ID);

        const account = new Account(client);
        const db = new Databases(client);
        const storage = new Storage(client);

        // IDs DO BANCO DE DADOS
        const DB_ID = 'db_main';
        const COL_TERRENOS = 'col_terrenos';
        const COL_VENDAS = 'col_vendas';
        const BUCKET_ID = 'bucket_fotos';

        // Variáveis Globais
        let terrenos = [], vendas = [], user = null;

        // --- 2. SISTEMA DE SEGURANÇA (PERMISSÕES) ---
        // Esta função gera o "cadeado" para cada item criado.
        // Garante que só o dono possa Ler (read), Editar (update) e Apagar (delete).
        function getPermissions() {
            if (!user) return [];
            return [
                Permission.read(Role.user(user.$id)),
                Permission.update(Role.user(user.$id)),
                Permission.delete(Role.user(user.$id))
            ];
        }

        // --- 3. AUTENTICAÇÃO ---
        async function checkSession() {
            try {
                // Tenta pegar o usuário atual
                user = await account.get();
                // Se conseguir, mostra o painel
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-email-display').innerText = user.email;
                loadData();
            } catch (e) {
                // Se falhar, fica na tela de login
                console.log("Aguardando login...");
            }
        }
        checkSession(); // Roda ao abrir a página

        document.getElementById('form-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            document.getElementById('login-msg').innerText = "Conectando...";
            
            try {
                // Tenta logar (Versão nova do comando)
                await account.createEmailPasswordSession(email, pass);
                checkSession();
            } catch (error) {
                // Se der erro (provavelmente usuário não existe), tenta criar
                try {
                    await account.create(ID.unique(), email, pass);
                    await account.createEmailPasswordSession(email, pass);
                    checkSession();
                } catch (createErr) {
                    document.getElementById('login-msg').innerText = "Error: " + error.message;
                }
            }
        });

        window.logout = async () => {
            await account.deleteSession('current');
            location.reload();
        }

        // --- 4. CARREGAMENTO DE DADOS ---
        async function loadData() {
            document.getElementById('loader').classList.remove('hidden');
            try {
                // O Appwrite filtra automaticamente pelo usuário logado
                const tRes = await db.listDocuments(DB_ID, COL_TERRENOS, [Query.limit(100)]);
                terrenos = tRes.documents.map(d => ({ $id: d.$id, ...JSON.parse(d.dados) }));
                
                const vRes = await db.listDocuments(DB_ID, COL_VENDAS, [Query.limit(100)]);
                vendas = vRes.documents.map(d => ({ $id: d.$id, ...JSON.parse(d.dados) }));

                renderTerrenos();
                renderVendas();
                updateDashboard();
            } catch (e) {
                console.error(e);
                alert("Error cargando datos. Asegúrate de tener la columna 'dados' creada.");
            }
            document.getElementById('loader').classList.add('hidden');
        }

        // --- CORREÇÃO 3: FUNÇÃO DE UPLOAD E LINK SEGURO ---
        async function uploadFiles(filesInput) {
            if (!filesInput.files.length) return [];
            let urls = [];
            for (let i = 0; i < filesInput.files.length; i++) {
                try {
                    // Upload com permissões de segurança
                    const res = await storage.createFile(BUCKET_ID, ID.unique(), filesInput.files[i], getPermissions());
                    
                    // AQUI ESTÁ A CORREÇÃO DO LINK 404:
                    // Usamos a função do SDK para gerar o link correto automaticamente
                    const fileUrl = storage.getFileView(BUCKET_ID, res.$id);
                    urls.push(fileUrl); 
                    
                } catch (e) {
                    console.error("Erro no upload", e);
                }
            }
            return urls;
        }

        // --- 5. LÓGICA: TERRENOS ---
        document.getElementById('form-terreno').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            
            const urls = await uploadFiles(document.getElementById('t-files'));
            
            const data = {
                codigo: document.getElementById('t-codigo').value,
                nome: document.getElementById('t-nome').value,
                area: document.getElementById('t-area').value,
                moeda: document.getElementById('t-moeda').value,
                preco: parseFloat(document.getElementById('t-precio').value),
                notas: document.getElementById('t-notas').value,
                fotos: urls,
                estado: 'Disponible',
                habilitado: true
            };

            // Salva com permissões de segurança
            await db.createDocument(DB_ID, COL_TERRENOS, ID.unique(), { dados: JSON.stringify(data) }, getPermissions());
            
            document.getElementById('form-terreno').reset();
            nav('listado');
            loadData();
        });

        function renderTerrenos() {
            const tbody = document.getElementById('lista-terrenos');
            tbody.innerHTML = '';
            const filtro = document.getElementById('search-land').value.toLowerCase();

            terrenos.forEach(t => {
                if (!t.nome.toLowerCase().includes(filtro) && !t.codigo.toLowerCase().includes(filtro)) return;

                let imgHtml = t.fotos && t.fotos.length ? `<img src="${t.fotos[0]}" class="thumb-small" onclick="verDetalles('${t.$id}', 'land')">` : '<div style="width:50px;height:50px;background:#eee;border-radius:4px;"></div>';
                
                let btnVender = (t.estado === 'Disponible' && t.habilitado) ? 
                    `<button class="btn btn-p" style="padding:5px 10px;" onclick="openVenda('${t.$id}')">Vender</button>` : 
                    `<span class="status-badge status-vendido">Vendido</span>`;

                tbody.innerHTML += `
                <tr>
                    <td>${imgHtml}</td>
                    <td><strong>${t.codigo}</strong></td>
                    <td>${t.nome}</td>
                    <td>${t.moeda} ${new Intl.NumberFormat('es-BO').format(t.precio)}</td>
                    <td><span class="status-badge ${t.estado==='Disponible'?'status-disponible':'status-vendido'}">${t.estado}</span></td>
                    <td>
                        <button class="btn btn-g" title="Editar" onclick="openEdit('${t.$id}', 'land')"><i class="fas fa-edit"></i></button>
                        ${btnVender}
                        <button class="btn btn-d" title="Eliminar" onclick="deleteItem('${t.$id}', 'land')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            });
        }

        // --- 6. LÓGICA: VENDAS ---
        window.openVenda = (id) => {
            const t = terrenos.find(x => x.$id === id);
            document.getElementById('v-land-id').value = id;
            document.getElementById('v-land-info').innerText = `${t.codigo} - ${t.nome} (${t.moeda} ${t.precio})`;
            document.getElementById('v-total').value = t.precio;
            document.getElementById('v-data1').value = new Date().toISOString().split('T')[0];
            window.calcLive();
            document.getElementById('modal-venda').classList.remove('hidden');
        }

        document.getElementById('form-venda').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');

            const tId = document.getElementById('v-land-id').value;
            const terreno = terrenos.find(x => x.$id === tId);
            const urls = await uploadFiles(document.getElementById('v-files'));
            
            const total = parseFloat(document.getElementById('v-total').value);
            const ent = parseFloat(document.getElementById('v-entrada').value);
            const qtd = parseInt(document.getElementById('v-ncuotas').value);
            const data1 = new Date(document.getElementById('v-data1').value);
            
            let cuotas = [];
            let valorParcela = (total - ent) / qtd;
            
            for(let i=0; i<qtd; i++) {
                let dt = new Date(data1);
                dt.setMonth(dt.getMonth() + i);
                cuotas.push({
                    n: i+1,
                    valor: valorParcela,
                    venc: dt.toISOString().split('T')[0],
                    pago: false,
                    valor_pago: 0
                });
            }

            const venda = {
                cliente: document.getElementById('v-cliente').value,
                ci: document.getElementById('v-ci').value,
                fotos: urls,
                landId: tId,
                landNome: terreno.nome,
                moeda: terreno.moeda,
                total: total,
                entrada: ent,
                cuotas: cuotas,
                data: new Date().toISOString()
            };

            // Cria venda segura
            await db.createDocument(DB_ID, COL_VENDAS, ID.unique(), { dados: JSON.stringify(venda) }, getPermissions());
            
            // Atualiza terreno (mas mantemos ele visível para quem criou)
            terreno.estado = 'Vendido';
            await db.updateDocument(DB_ID, COL_TERRENOS, tId, { dados: JSON.stringify(terreno) });

            closeModal('modal-venda');
            loadData();
        });

        function renderVendas() {
            const l1 = document.getElementById('lista-cobrancas');
            const l2 = document.getElementById('lista-historico');
            l1.innerHTML = ''; l2.innerHTML = '';
            
            const filtro = document.getElementById('search-venda').value.toLowerCase();

            vendas.forEach(v => {
                // Histórico
                l2.innerHTML += `
                <tr>
                    <td>${v.$id.substring(0,6)}...</td>
                    <td>${v.cliente}</td>
                    <td>${v.landNome}</td>
                    <td>${v.moeda} ${new Intl.NumberFormat('es-BO').format(v.total)}</td>
                    <td>
                        <button class="btn btn-w" onclick="openEdit('${v.$id}', 'sale')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-d" onclick="deleteItem('${v.$id}', 'sale')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;

                if (!v.cliente.toLowerCase().includes(filtro)) return;

                // Cobranças
                let pendente = v.cuotas.find(c => !c.pago);
                if (pendente) {
                    let cor = (new Date(pendente.venc) < new Date()) ? 'red' : '#333';
                    l1.innerHTML += `
                    <tr>
                        <td><strong>${v.cliente}</strong></td>
                        <td>${v.landNome}</td>
                        <td>${pendente.n} / ${v.cuotas.length}</td>
                        <td style="color:${cor}; font-weight:bold;">${pendente.venc}</td>
                        <td>${v.moeda} ${new Intl.NumberFormat('es-BO').format(pendente.valor)}</td>
                        <td><button class="btn btn-s" onclick="openPagar('${v.$id}', ${pendente.n})">Cobrar</button></td>
                    </tr>`;
                }
            });
        }

        // --- 7. PAGAMENTOS (AMORTIZAÇÃO) ---
        window.openPagar = (vId, n) => {
            const v = vendas.find(x => x.$id === vId);
            const c = v.cuotas.find(x => x.n === n);
            
            document.getElementById('p-venda-id').value = vId;
            document.getElementById('p-cuota-idx').value = v.cuotas.indexOf(c);
            document.getElementById('p-valor-display').innerText = v.moeda + ' ' + c.valor.toFixed(2);
            document.getElementById('p-valor-real').value = c.valor.toFixed(2);
            document.getElementById('p-data').value = new Date().toISOString().split('T')[0];
            
            if(v.moeda === 'USD') document.getElementById('div-tc').classList.remove('hidden');
            else document.getElementById('div-tc').classList.add('hidden');

            document.getElementById('modal-pagar').classList.remove('hidden');
        }

        document.getElementById('form-pagar').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');

            const vId = document.getElementById('p-venda-id').value;
            const idx = parseInt(document.getElementById('p-cuota-idx').value);
            const pago = parseFloat(document.getElementById('p-valor-real').value);
            const tc = parseFloat(document.getElementById('p-tc').value);
            
            const v = vendas.find(x => x.$id === vId);
            
            let saldo = pago;
            let i = idx;

            // Algoritmo de Amortização
            while(saldo > 0.1 && i < v.cuotas.length) {
                let c = v.cuotas[i];
                if(c.pago) { i++; continue; }

                if(saldo >= c.valor) {
                    saldo -= c.valor;
                    c.pago = true;
                    c.valor_pago = c.valor;
                    c.tc = tc; // Salva o câmbio do dia
                } else {
                    c.valor -= saldo;
                    saldo = 0;
                }
                i++;
            }

            await db.updateDocument(DB_ID, COL_VENDAS, vId, { dados: JSON.stringify(v) });
            closeModal('modal-pagar');
            loadData();
        });

        // --- 8. EDIÇÃO E UTILITÁRIOS ---
        window.openEdit = (id, type) => {
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            document.getElementById('e-id').value = id;
            document.getElementById('e-type').value = type;
            document.getElementById('e-nome').value = (type === 'land') ? d.nome : d.cliente;
            document.getElementById('e-valor').value = (type === 'land') ? d.precio : d.total;
            document.getElementById('e-notas').value = (type === 'land') ? d.notas : '';
            
            const g = document.getElementById('e-gallery'); g.innerHTML = '';
            if(d.fotos) d.fotos.forEach((u, i) => {
                g.innerHTML += `<div class="img-preview-box"><img src="${u}" onclick="window.open('${u}')"><div class="btn-del-img" onclick="remFoto('${id}', '${type}', ${i})">X</div></div>`;
            });
            document.getElementById('modal-edit').classList.remove('hidden');
        }

        window.remFoto = async (id, type, i) => {
            if(!confirm("¿Borrar esta foto permanentemente?")) return;
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            d.fotos.splice(i, 1);
            await db.updateDocument(DB_ID, (type==='land'?COL_TERRENOS:COL_VENDAS), id, { dados: JSON.stringify(d) });
            closeModal('modal-edit');
            loadData();
        }

        document.getElementById('form-edit').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loader').classList.remove('hidden');
            
            const id = document.getElementById('e-id').value;
            const type = document.getElementById('e-type').value;
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            
            const urls = await uploadFiles(document.getElementById('e-new-files'));
            if(!d.fotos) d.fotos = [];
            d.fotos = [...d.fotos, ...urls];

            if(type === 'land') {
                d.nome = document.getElementById('e-nome').value;
                d.precio = parseFloat(document.getElementById('e-valor').value);
                d.notas = document.getElementById('e-notas').value;
            } else {
                d.cliente = document.getElementById('e-nome').value;
            }

            await db.updateDocument(DB_ID, (type==='land'?COL_TERRENOS:COL_VENDAS), id, { dados: JSON.stringify(d) });
            closeModal('modal-edit');
            loadData();
        });

        window.deleteItem = async (id, type) => {
            if(!confirm("¿Eliminar? Esta acción no se puede deshacer.")) return;
            document.getElementById('loader').classList.remove('hidden');
            
            if(type === 'sale') {
                // Ao apagar venda, liberar terreno
                const v = vendas.find(x => x.$id === id);
                const t = terrenos.find(x => x.$id === v.landId);
                if(t) {
                    t.estado = 'Disponible';
                    await db.updateDocument(DB_ID, COL_TERRENOS, t.$id, { dados: JSON.stringify(t) });
                }
            }
            await db.deleteDocument(DB_ID, (type==='land'?COL_TERRENOS:COL_VENDAS), id);
            loadData();
        }

        window.verDetalles = (id, type) => {
            const d = (type === 'land') ? terrenos.find(x => x.$id === id) : vendas.find(x => x.$id === id);
            let imgs = '';
            if(d.fotos) d.fotos.forEach(u => imgs += `<img src="${u}" class="img-full" onclick="window.open('${u}')">`);
            
            const html = (type === 'land') ? 
                `<h2>${d.nome}</h2><p><strong>Precio:</strong> ${d.moeda} ${d.precio}</p><p><strong>Estado:</strong> ${d.estado}</p><p>${d.notas}</p><hr>${imgs}` : 
                `<h2>${d.cliente}</h2><p><strong>CI:</strong> ${d.ci}</p><hr>${imgs}`;
            
            document.getElementById('detalles-contenido').innerHTML = html;
            document.getElementById('modal-detalles').classList.remove('hidden');
        }

        // --- 9. HELPERS E CORREÇÃO 2: MENU ATIVO ---
        window.nav = (v) => { 
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); 
            document.getElementById('view-'+v).classList.remove('hidden'); 
            
            // Remove active de todos e adiciona no correto
            document.querySelectorAll('.menu button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+v).classList.add('active');

            if(v==='listado') renderTerrenos(); 
            if(v==='ventas') renderVendas(); 
        }

        window.switchVendas=(t)=>{document.getElementById('tab-vendas-resumo').classList.add('hidden'); document.getElementById('tab-vendas-hist').classList.add('hidden'); document.getElementById('tab-vendas-'+t).classList.remove('hidden');}
        window.closeModal=(id)=>document.getElementById(id).classList.add('hidden');
        
        window.showPreview = (i, id, c) => {
            document.getElementById(id).innerText = new Intl.NumberFormat('es-BO', { style: 'currency', currency: c }).format(i.value);
        }
        
        window.calcLive = () => {
            const p = parseFloat(document.getElementById('v-total').value)||0;
            const e = parseFloat(document.getElementById('v-entrada').value)||0;
            const c = parseInt(document.getElementById('v-ncuotas').value)||1;
            const m = document.getElementById('v-land-info').innerText.includes('USD') ? 'USD' : 'BOB';
            document.getElementById('live-result-text').innerText = new Intl.NumberFormat('es-BO', { style: 'currency', currency: m }).format((p-e)/c);
        }

        function updateDashboard(){ 
            document.getElementById('kpi-total').innerText=terrenos.length; 
            document.getElementById('kpi-disp').innerText=terrenos.filter(t=>t.estado==='Disponible').length; 
            
            const ctx1 = document.getElementById('chart-fin').getContext('2d');
            if(window.ch1) window.ch1.destroy();
            // Correção Gráfico: Responsive false para respeitar o container
            window.ch1 = new Chart(ctx1, { 
                type: 'doughnut', 
                data: { labels: ['Disp','Vend'], datasets:[{data:[terrenos.filter(t=>t.estado==='Disponible').length, terrenos.filter(t=>t.estado==='Vendido').length], backgroundColor:['#27ae60','#7f8c8d']}] },
                options: { maintainAspectRatio: false }
            });
        }
    </script>
</body>
</html>
