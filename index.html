<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Inmobiliario - Conectado Firebase</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- ESTILOS CSS (MANTIDOS IDÊNTICOS) --- */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #2980b9;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
            --light-bg: #f4f6f9;
            --white: #ffffff;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body { background-color: var(--light-bg); color: #333; height: 100vh; overflow: hidden; }

        .hidden { display: none !important; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 10px; }
        .text-right { text-align: right; }
        .text-bold { font-weight: bold; }
        
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: #fff; }
        .btn-secondary { background-color: #7f8c8d; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .money-preview { font-size: 0.8rem; color: var(--success-color); margin-top: 2px; font-weight: 600; display: block; }
        .live-calc-box { background-color: #e8f6f3; border: 1px solid #a2d9ce; padding: 15px; border-radius: 6px; margin-top: 15px; text-align: center; }
        .live-result { font-size: 1.5rem; color: var(--success-color); font-weight: bold; }

        .gallery-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .gallery-item { position: relative; width: 80px; height: 80px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; background: #fff; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
        .gallery-delete {
            position: absolute; top: 0; right: 0; background: rgba(255, 0, 0, 0.8); color: white;
            width: 20px; height: 20px; text-align: center; font-size: 12px; cursor: pointer;
            line-height: 20px; border-bottom-left-radius: 4px; z-index: 10;
        }

        .thumb-preview { 
            width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; 
            cursor: pointer; transition: transform 0.2s; background-color: #fff;
        }
        .thumb-preview:hover { transform: scale(2.5); z-index: 100; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .img-full { width: 100%; max-height: 300px; object-fit: contain; border-radius: 4px; border: 1px solid #eee; margin-bottom: 5px; background: #f9f9f9; }

        #login-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); }
        .login-card { background: var(--white); padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        
        #dashboard-container { display: flex; height: 100vh; }
        aside { width: 260px; background-color: var(--primary-color); color: white; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .menu-items { flex: 1; padding: 20px 0; overflow-y: auto; }
        .menu-btn { display: block; width: 100%; padding: 15px 20px; background: none; border: none; color: #ecf0f1; text-align: left; cursor: pointer; font-size: 1rem; }
        .menu-btn.active { background-color: var(--secondary-color); border-left: 4px solid var(--accent-color); }
        .menu-btn i { margin-right: 10px; width: 20px; }
        
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { background: var(--white); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #content-area { flex: 1; padding: 20px; overflow-y: auto; }
        
        .card { background: var(--white); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: var(--primary-color); }
        
        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .status-disponible { background-color: #e8f8f5; color: #27ae60; border: 1px solid #27ae60; }
        .status-vendido { background-color: #eaeded; color: #7f8c8d; border: 1px solid #7f8c8d; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); text-align: center; }
        .stat-card h3 { font-size: 2rem; color: var(--accent-color); margin: 10px 0; }
        .charts-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .chart-box { flex: 1; min-width: 300px; background: white; padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: var(--border-radius); width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        /* Loader simple */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loader" class="loading-overlay hidden">
        <i class="fas fa-spinner fa-spin fa-3x" style="color:var(--accent-color)"></i>
        <p style="margin-top:10px; font-weight:bold;">Procesando...</p>
    </div>

    <div id="login-screen">
        <div class="login-card">
            <div class="text-center">
                <h2>Corvac Inmobiliaria</h2>
                <p>Sistema Online</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label>Usuario (Email)</label>
                    <input type="email" id="login-email" placeholder="admin@empresa.com" required>
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="login-pass" placeholder="******" required>
                </div>
                <p id="login-error" class="error-msg" style="color:red; display:none;">Error de credenciales.</p>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Entrar</button>
            </form>
        </div>
    </div>

    <div id="dashboard-container" class="hidden">
        <aside>
            <div class="sidebar-header">
                <h3>Panel de Control</h3>
                <small id="user-email-display" style="font-size:0.7rem; color:#ccc;"></small>
            </div>
            <nav class="menu-items">
                <button class="menu-btn active" onclick="window.showSection('resumen')"><i class="fas fa-chart-line"></i> Resumen</button>
                <button class="menu-btn" onclick="window.showSection('registro')"><i class="fas fa-plus"></i> Registrar Terreno</button>
                <button class="menu-btn" onclick="window.showSection('listado')"><i class="fas fa-th-list"></i> Inventario</button>
                <button class="menu-btn" onclick="window.showSection('ventas')"><i class="fas fa-hand-holding-usd"></i> Cobranzas y Ventas</button>
            </nav>
        </aside>

        <main>
            <header>
                <h3 id="page-title">Resumen General</h3>
                <button onclick="window.logout()" class="btn btn-secondary">Salir</button>
            </header>

            <div id="content-area">
                <div id="sec-resumen" class="section-view">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <p>Terrenos Totales</p>
                            <h3 id="stat-total">0</h3>
                        </div>
                        <div class="stat-card">
                            <p>Disponibles</p>
                            <h3 id="stat-disponibles" style="color:var(--success-color)">0</h3>
                        </div>
                        <div class="stat-card">
                            <p>Total Recaudado (Ref. en Bs)</p>
                            <h3 id="stat-recaudado" style="color:var(--accent-color)">0</h3>
                        </div>
                    </div>
                    <div class="charts-container">
                        <div class="chart-box">
                            <h4>Estado del Inventario</h4>
                            <canvas id="chartStatus"></canvas>
                        </div>
                        <div class="chart-box">
                            <h4>Finanzas Globales (Convertido a Bs)</h4>
                            <canvas id="chartFinanzas"></canvas>
                        </div>
                    </div>
                </div>

                <div id="sec-registro" class="section-view hidden">
                    <div class="card">
                        <h3>Registrar Nuevo Terreno</h3>
                        <form id="form-terreno">
                            <div class="flex gap-2" style="flex-wrap:wrap;">
                                <div class="form-group" style="flex:1"><label>Código *</label><input type="text" id="t-codigo" required placeholder="Ej: L-01"></div>
                                <div class="form-group" style="flex:2"><label>Nombre / Ubicación *</label><input type="text" id="t-nombre" required></div>
                            </div>
                            <div class="flex gap-2" style="flex-wrap:wrap;">
                                <div class="form-group" style="flex:1"><label>Superficie (m²)</label><input type="number" id="t-superficie"></div>
                                <div class="form-group" style="flex:1">
                                    <label>Moneda *</label>
                                    <select id="t-moneda" onchange="window.showPreview(document.getElementById('t-precio'), 'preview-precio-t', this.value)">
                                        <option value="BOB">Bolivianos (Bs)</option>
                                        <option value="USD">Dólares ($us)</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex:1">
                                    <label>Precio Base *</label>
                                    <input type="number" id="t-precio" required min="0" oninput="window.showPreview(this, 'preview-precio-t', document.getElementById('t-moneda').value)">
                                    <small id="preview-precio-t" class="money-preview">0,00</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-camera"></i> Fotos del Terreno</label>
                                <input type="file" id="t-foto" accept="image/*" multiple>
                            </div>
                            <div class="form-group"><label>Notas Adicionales</label><textarea id="t-notas" rows="3"></textarea></div>
                            <button type="submit" class="btn btn-success">Guardar Terreno (Nube)</button>
                        </form>
                    </div>
                </div>

                <div id="sec-listado" class="section-view hidden">
                    <div class="card">
                        <div class="flex justify-between items-center" style="margin-bottom:15px;">
                            <h3>Inventario de Terrenos</h3>
                            <input type="text" id="search-land" placeholder="Buscar..." style="padding:8px; border:1px solid #ccc; border-radius:4px;">
                        </div>
                        <div class="table-responsive">
                            <table id="table-lands">
                                <thead>
                                    <tr>
                                        <th>Fotos</th><th>Código</th><th>Nombre</th><th>Precio</th><th>Estado</th><th>Acciones</th><th>Habilitar</th><th>Eliminar</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="sec-ventas" class="section-view hidden">
                    <div id="alerts-panel"></div>
                    <div class="card">
                        <div class="flex justify-between items-center" style="margin-bottom: 15px;">
                            <div class="flex gap-2">
                                <button class="btn btn-primary" onclick="window.showSection('ventas-resumen')">Cobranzas (Resumen)</button>
                                <button class="btn btn-secondary" onclick="window.showSection('ventas-historial')">Historial & Edición</button>
                            </div>
                            <button class="btn btn-success" onclick="window.initSystem()"><i class="fas fa-sync"></i></button>
                        </div>
                        
                        <div id="view-cobros-resumen">
                            <input type="text" id="search-deudor" placeholder="Buscar cliente..." style="padding:8px; width:100%; max-width:300px; margin-bottom:10px;" onkeyup="window.renderCobranzas()">
                            <div class="table-responsive"><table id="table-cobros"><thead><tr><th>Cliente</th><th>Terreno</th><th>Cuota</th><th>Vencimiento</th><th>Monto</th><th>Acción</th></tr></thead><tbody></tbody></table></div>
                        </div>

                        <div id="view-cobros-historial" class="hidden">
                            <div class="table-responsive"><table id="table-sales-history"><thead><tr><th>ID</th><th>Cliente</th><th>Terreno</th><th>Total</th><th>Moneda</th><th>Editar</th><th>Eliminar</th></tr></thead><tbody></tbody></table></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="modal-venta" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header"><h3>Realizar Venta</h3><button class="close-modal" onclick="window.closeModal('modal-venta')">&times;</button></div>
            <form id="form-venta">
                <input type="hidden" id="v-land-id">
                <input type="hidden" id="v-land-moneda">
                <div style="background:#f0f0f0; padding:10px; margin-bottom:10px; border-radius:4px;">
                    Terreno: <b id="v-land-name"></b> | Base: <b id="v-land-price"></b>
                </div>
                <div class="flex gap-2"><input type="text" id="v-cliente" class="form-group" style="width:100%" placeholder="Nombre Cliente *" required><input type="text" id="v-ci" class="form-group" style="width:100%" placeholder="Carnet / ID"></div>
                <div class="form-group"><label>Documentos / Fotos Cliente</label><input type="file" id="v-doc" accept="image/*" multiple></div>
                <hr>
                <div id="div-aviso-tc" class="form-group hidden" style="background:#fff3cd; padding:10px;"><i class="fas fa-info-circle"></i> Venta en USD. T.C. se pide al cobrar.</div>
                <div class="flex gap-2">
                    <div style="flex:1" class="form-group"><label>Precio Final</label><input type="number" id="v-precio-final" required oninput="window.calcLive()"></div>
                    <div style="flex:1" class="form-group"><label>Entrada</label><input type="number" id="v-entrada" value="0" oninput="window.calcLive()"></div>
                </div>
                <div class="flex gap-2">
                    <div style="flex:1" class="form-group"><label>Nº Cuotas</label><input type="number" id="v-cuotas" value="12" min="1" oninput="window.calcLive()"></div>
                    <div style="flex:1" class="form-group"><label>1er Vencimiento</label><input type="date" id="v-fecha1" required></div>
                </div>
                <div class="live-calc-box"><h4>Cuota Mensual</h4><div id="live-result-text" class="live-result">0,00</div><small id="live-detail-text">...</small></div>
                <div class="text-right" style="margin-top:20px;"><button type="submit" class="btn btn-primary">Confirmar Venta</button></div>
            </form>
        </div>
    </div>

    <div id="modal-cobro" class="modal hidden">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header"><h3>Registrar Pago</h3><button class="close-modal" onclick="window.closeModal('modal-cobro')">&times;</button></div>
            <form id="form-cobro">
                <input type="hidden" id="c-sale-id"><input type="hidden" id="c-idx">
                <div class="text-center" style="background:#f0f0f0; padding:10px; margin-bottom:10px;">
                    <p>Cuota: <span id="c-num" class="text-bold"></span></p>
                    <p>Valor Original: <span id="c-monto-original" style="font-weight:bold"></span> <small id="c-moneda-ref"></small></p>
                </div>
                <div class="form-group">
                    <label style="color:var(--accent-color); font-weight:bold;">Monto a Pagar (Amortizable)</label>
                    <input type="number" id="c-monto-pagar" required step="0.01" style="font-size:1.2rem; font-weight:bold; color:var(--success-color);">
                </div>
                <div id="div-tc-cobro" class="form-group hidden" style="background:#e8f8f5; padding:10px;">
                    <label>Tipo de Cambio del Día (Bs/USD) *</label><input type="number" step="0.01" id="c-tasa-dia">
                </div>
                <div class="form-group"><label>Fecha</label><input type="date" id="c-fecha" required style="width:100%"></div>
                <button type="submit" class="btn btn-success" style="width:100%">Confirmar Pago</button>
            </form>
        </div>
    </div>

    <div id="modal-editar-terreno" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Terreno</h3><button class="close-modal" onclick="window.closeModal('modal-editar-terreno')">&times;</button></div>
            <form id="form-editar-terreno">
                <input type="hidden" id="e-t-id">
                <div class="form-group"><label>Nombre</label><input type="text" id="e-t-nombre" required></div>
                <div class="flex gap-2">
                    <div style="flex:1"><label>Precio</label><input type="number" id="e-t-precio" required></div>
                    <div style="flex:1"><label>Superficie</label><input type="number" id="e-t-superficie"></div>
                </div>
                <div class="form-group"><label>Notas</label><textarea id="e-t-notas" rows="3"></textarea></div>
                <div class="form-group"><label>Galería Actual</label><div id="e-t-gallery" class="gallery-container"></div></div>
                <div class="form-group"><label>Agregar Fotos</label><input type="file" id="e-t-foto-new" accept="image/*" multiple></div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="modal-editar-venta" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header"><h3>Editar Cliente</h3><button class="close-modal" onclick="window.closeModal('modal-editar-venta')">&times;</button></div>
            <form id="form-editar-venta">
                <input type="hidden" id="e-v-id">
                <div class="form-group"><label>Cliente</label><input type="text" id="e-v-cliente" required></div>
                <div class="form-group"><label>ID/Carnet</label><input type="text" id="e-v-ci"></div>
                <div class="form-group"><label>Docs Actuales</label><div id="e-v-gallery" class="gallery-container"></div></div>
                <div class="form-group"><label>Agregar Docs</label><input type="file" id="e-v-doc-new" accept="image/*" multiple></div>
                <button type="submit" class="btn btn-primary" style="width:100%">Guardar</button>
            </form>
        </div>
    </div>

    <div id="modal-detalles" class="modal hidden">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header"><h3>Detalles</h3><button class="close-modal" onclick="window.closeModal('modal-detalles')">&times;</button></div>
            <div id="detalles-contenido"></div>
        </div>
    </div>

    <script type="module">
        // 1. IMPORTAR FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // 2. CONFIGURACIÓN (Tus datos)
        const firebaseConfig = {
            apiKey: "AIzaSyDH1JuZinm_5M0D5EI2uokBYZcuXGtLJjI",
            authDomain: "corvac-4867f.firebaseapp.com",
            projectId: "corvac-4867f",
            storageBucket: "corvac-4867f.firebasestorage.app",
            messagingSenderId: "1052536733344",
            appId: "1:1052536733344:web:01e2978fbbc438ad5993c5",
            measurementId: "G-DRL6VDBPRE"
        };

        // INICIALIZAR
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ESTADO LOCAL (Para rendimiento, sincronizamos al cargar)
        let localData = { terrenos: [], ventas: [] };

        // --- FUNCIONES GLOBALES (Attach to window) ---
        
        // Helpers UI
        window.showLoader = (show) => document.getElementById('loader').classList.toggle('hidden', !show);
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.formatMoney = (amount, currency = 'BOB') => parseFloat(amount).toLocaleString('es-BO', { style: 'currency', currency: currency === 'USD' ? 'USD' : 'BOB' }).replace('US$', '$us');
        
        // Auth
        const loginForm = document.getElementById('login-form');
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try {
                window.showLoader(true);
                await signInWithEmailAndPassword(auth, email, pass);
                // El onAuthStateChanged manejará la redirección
            } catch (error) {
                console.error(error);
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('login-error').innerText = "Error: " + error.message;
                window.showLoader(false);
            }
        });

        window.logout = async () => {
            await signOut(auth);
            location.reload();
        };

        // Monitor de Sesión
        onAuthStateChanged(auth, (user) => {
            window.showLoader(false);
            if (user) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('dashboard-container').classList.remove('hidden');
                document.getElementById('user-email-display').innerText = user.email;
                window.initSystem(); // Cargar datos de Firestore
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('dashboard-container').classList.add('hidden');
            }
        });

        // --- LÓGICA DE DATOS (FIRESTORE) ---

        window.initSystem = async () => {
            window.showLoader(true);
            try {
                // Fetch Terrenos
                const tSnap = await getDocs(collection(db, "terrenos"));
                localData.terrenos = tSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // Fetch Ventas
                const vSnap = await getDocs(collection(db, "ventas"));
                localData.ventas = vSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // Render Inicial
                window.updateDashboard();
                window.showSection('resumen');
                
                // Set Date inputs to today
                const today = new Date().toISOString().split('T')[0];
                if(document.getElementById('v-fecha1')) document.getElementById('v-fecha1').value = today;
                if(document.getElementById('c-fecha')) document.getElementById('c-fecha').value = today;

            } catch (e) {
                console.error("Error cargando datos:", e);
                alert("Error de conexión con Firebase. Revise la consola.");
            }
            window.showLoader(false);
        };

        // Helper: Upload Multiple Files
        async function uploadFilesToStorage(files, path) {
            if (!files || files.length === 0) return [];
            const urls = [];
            for (const file of files) {
                // Crear referencia única: carpeta/timestamp_nombre
                const storageRef = ref(storage, `${path}/${Date.now()}_${file.name}`);
                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);
                urls.push(url);
            }
            return urls;
        }

        // --- SECCIONES Y RENDER ---
        window.showSection = (id) => {
            if(id === 'ventas-resumen') { 
                document.getElementById('view-cobros-resumen').classList.remove('hidden'); 
                document.getElementById('view-cobros-historial').classList.add('hidden'); 
                id = 'ventas';
            }
            if(id === 'ventas-historial') { 
                document.getElementById('view-cobros-resumen').classList.add('hidden'); 
                document.getElementById('view-cobros-historial').classList.remove('hidden'); 
                id = 'ventas';
            }

            document.querySelectorAll('.section-view').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            
            // Highlight Menu
            const menus = document.querySelectorAll('.menu-btn');
            if(id==='resumen') menus[0].classList.add('active');
            if(id==='registro') menus[1].classList.add('active');
            if(id==='listado') { menus[2].classList.add('active'); window.renderLands(); }
            if(id==='ventas') { menus[3].classList.add('active'); window.renderCobranzas(); }
            if(id==='resumen') window.updateDashboard();
        };

        // --- TERRENOS (CRUD) ---

        // CREAR
        document.getElementById('form-terreno').addEventListener('submit', async (e) => {
            e.preventDefault();
            window.showLoader(true);
            try {
                const files = document.getElementById('t-foto').files;
                const urls = await uploadFilesToStorage(files, 'terrenos');
                
                const newLand = {
                    codigo: document.getElementById('t-codigo').value,
                    nombre: document.getElementById('t-nombre').value,
                    superficie: document.getElementById('t-superficie').value,
                    moneda: document.getElementById('t-moneda').value,
                    precio: parseFloat(document.getElementById('t-precio').value),
                    notas: document.getElementById('t-notas').value,
                    galeria: urls,
                    habilitado: true,
                    estado: 'Disponible',
                    createdAt: new Date().toISOString()
                };

                await addDoc(collection(db, "terrenos"), newLand);
                alert("Terreno registrado en la nube.");
                document.getElementById('form-terreno').reset();
                document.getElementById('preview-precio-t').innerText = "0,00";
                await window.initSystem(); // Recargar datos
            } catch (e) {
                console.error(e);
                alert("Error al guardar: " + e.message);
                window.showLoader(false);
            }
        });

        // LEER (Render)
        window.renderLands = () => {
            const tbody = document.querySelector('#table-lands tbody');
            tbody.innerHTML = '';
            const filtro = document.getElementById('search-land').value.toLowerCase();

            localData.terrenos.forEach(land => {
                if(!land.codigo.toLowerCase().includes(filtro) && !land.nombre.toLowerCase().includes(filtro)) return;
                
                const tr = document.createElement('tr');
                
                // Botones
                const btnStateClass = land.habilitado ? 'btn-danger' : 'btn-success';
                const btnStateText = land.habilitado ? 'Deshabilitar' : 'Habilitar';
                const btnSell = (land.estado === 'Disponible' && land.habilitado) 
                    ? `<button class="btn btn-primary" style="padding:4px 8px;" onclick="window.openSaleModal('${land.id}')">Vender</button>` : `<span style="color:#ccc;">-</span>`;
                
                // Imagen forzada pequeña
                const imgHtml = (land.galeria && land.galeria.length > 0)
                    ? `<img src="${land.galeria[0]}" style="width:50px; height:50px; object-fit:cover; border-radius:4px; cursor:pointer;" onclick="window.verDetalles('${land.id}')"><br><small>${land.galeria.length} fotos</small>`
                    : `<div style="width:50px; height:50px; background:#eee; display:flex; align-items:center; justify-content:center;"><i class="fas fa-image"></i></div>`;

                tr.innerHTML = `
                    <td>${imgHtml}</td>
                    <td><strong>${land.codigo}</strong></td>
                    <td>${land.nombre}</td>
                    <td>${window.formatMoney(land.precio, land.moneda)}</td>
                    <td><span class="status-badge ${land.estado==='Disponible'?'status-disponible':'status-vendido'}">${land.estado}</span></td>
                    <td>
                        <button class="btn btn-secondary" style="padding:4px;" onclick="window.verDetalles('${land.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-warning" style="padding:4px;" onclick="window.openEditLand('${land.id}')"><i class="fas fa-edit"></i></button>
                        ${btnSell}
                    </td>
                    <td><button class="btn ${btnStateClass}" style="padding:4px 8px; font-size:0.8rem;" onclick="window.toggleLand('${land.id}')">${btnStateText}</button></td>
                    <td><button class="btn btn-danger" style="padding:4px;" onclick="window.deleteLand('${land.id}')"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        };
        
        // Search trigger
        document.getElementById('search-land').addEventListener('input', window.renderLands);

        // ACTUALIZAR ESTADO (Habilitar/Deshabilitar)
        window.toggleLand = async (id) => {
            const land = localData.terrenos.find(t => t.id === id);
            if(!land) return;
            window.showLoader(true);
            try {
                await updateDoc(doc(db, "terrenos", id), { habilitado: !land.habilitado });
                await window.initSystem();
            } catch(e) { alert("Error actualizando"); window.showLoader(false); }
        };

        // BORRAR TERRENO
        window.deleteLand = async (id) => {
            const land = localData.terrenos.find(t => t.id === id);
            if(land.estado === 'Vendido') { if(!confirm('Terreno VENDIDO. ¿Seguro?')) return; } 
            else { if(!confirm('¿Eliminar terreno permanentemente?')) return; }
            
            window.showLoader(true);
            try {
                await deleteDoc(doc(db, "terrenos", id));
                await window.initSystem();
            } catch(e) { alert("Error eliminando"); window.showLoader(false); }
        };

        // --- EDITAR TERRENO (MODAL) ---
        let currentEditLandId = null;
        window.openEditLand = (id) => {
            currentEditLandId = id;
            const land = localData.terrenos.find(t => t.id === id);
            document.getElementById('e-t-id').value = id;
            document.getElementById('e-t-nombre').value = land.nombre;
            document.getElementById('e-t-precio').value = land.precio;
            document.getElementById('e-t-superficie').value = land.superficie;
            document.getElementById('e-t-notas').value = land.notas;
            document.getElementById('e-t-foto-new').value = '';
            
            window.renderGallery('e-t-gallery', land.galeria || [], 'window.deleteLandPhoto');
            document.getElementById('modal-editar-terreno').classList.remove('hidden');
        };

        window.deleteLandPhoto = async (idx) => {
            if(!confirm("¿Borrar esta foto?")) return;
            const land = localData.terrenos.find(t => t.id === currentEditLandId);
            const newGallery = [...land.galeria];
            newGallery.splice(idx, 1);
            
            window.showLoader(true);
            await updateDoc(doc(db, "terrenos", currentEditLandId), { galeria: newGallery });
            await window.initSystem();
            window.openEditLand(currentEditLandId); // Reabrir para actualizar vista
        };

        document.getElementById('form-editar-terreno').addEventListener('submit', async (e) => {
            e.preventDefault();
            window.showLoader(true);
            const id = document.getElementById('e-t-id').value;
            const land = localData.terrenos.find(t => t.id === id);
            
            // Subir nuevas fotos
            const files = document.getElementById('e-t-foto-new').files;
            const newUrls = await uploadFilesToStorage(files, 'terrenos');
            const finalGallery = (land.galeria || []).concat(newUrls);

            const updateData = {
                nombre: document.getElementById('e-t-nombre').value,
                precio: parseFloat(document.getElementById('e-t-precio').value),
                superficie: document.getElementById('e-t-superficie').value,
                notas: document.getElementById('e-t-notas').value,
                galeria: finalGallery
            };

            await updateDoc(doc(db, "terrenos", id), updateData);
            window.closeModal('modal-editar-terreno');
            await window.initSystem();
        });

        // --- VENTAS (CRUD) ---

        window.openSaleModal = (id) => {
            const land = localData.terrenos.find(t => t.id === id);
            document.getElementById('v-land-id').value = id;
            document.getElementById('v-land-name').innerText = land.nombre;
            const moneda = land.moneda || 'BOB';
            document.getElementById('v-land-moneda').value = moneda;
            document.getElementById('v-land-price').innerText = window.formatMoney(land.precio, moneda);
            document.getElementById('lbl-moneda').innerText = moneda;
            
            document.getElementById('div-aviso-tc').classList.toggle('hidden', moneda !== 'USD');
            
            // Defaults
            document.getElementById('v-precio-final').value = land.precio;
            document.getElementById('v-entrada').value = 0;
            document.getElementById('v-cuotas').value = 12;
            window.calcLive();
            document.getElementById('modal-venta').classList.remove('hidden');
        };

        window.calcLive = () => {
            const p = parseFloat(document.getElementById('v-precio-final').value)||0;
            const e = parseFloat(document.getElementById('v-entrada').value)||0;
            const c = parseInt(document.getElementById('v-cuotas').value)||1;
            const m = document.getElementById('v-land-moneda').value;
            const saldo = p - e;
            const cuota = (saldo > 0 && c > 0) ? saldo/c : 0;
            document.getElementById('live-result-text').innerText = window.formatMoney(cuota, m);
            document.getElementById('live-detail-text').innerText = `Saldo: ${window.formatMoney(saldo, m)} en ${c} cuotas`;
        };
        
        window.showPreview = (input, elId, curr) => {
            document.getElementById(elId).innerText = window.formatMoney(parseFloat(input.value)||0, curr);
        };

        document.getElementById('form-venta').addEventListener('submit', async (e) => {
            e.preventDefault();
            window.showLoader(true);
            try {
                // Upload docs
                const files = document.getElementById('v-doc').files;
                const urls = await uploadFilesToStorage(files, 'ventas');

                // Data logic
                const landId = document.getElementById('v-land-id').value;
                const precio = parseFloat(document.getElementById('v-precio-final').value);
                const entrada = parseFloat(document.getElementById('v-entrada').value);
                const nCuotas = parseInt(document.getElementById('v-cuotas').value);
                const fecha1 = new Date(document.getElementById('v-fecha1').value);
                const montoCuota = (precio - entrada) / nCuotas;

                const cuotas = [];
                for(let i=0; i<nCuotas; i++){
                    let f = new Date(fecha1);
                    f.setMonth(f.getMonth() + i);
                    cuotas.push({ n: i+1, vencimiento: f.toISOString().split('T')[0], monto: montoCuota, estado: 'Pendiente', fechaPago: null });
                }

                const newSale = {
                    landId: landId,
                    cliente: document.getElementById('v-cliente').value,
                    ci: document.getElementById('v-ci').value,
                    galeria: urls,
                    moneda: document.getElementById('v-land-moneda').value,
                    total: precio,
                    entrada: entrada,
                    cuotas: cuotas,
                    fechaVenta: new Date().toISOString()
                };

                // Guardar Venta
                await addDoc(collection(db, "ventas"), newSale);
                // Actualizar Terreno a Vendido
                await updateDoc(doc(db, "terrenos", landId), { estado: 'Vendido' });

                window.closeModal('modal-venta');
                await window.initSystem();
            } catch(e) { alert("Error venta: " + e.message); window.showLoader(false); }
        });

        // --- RENDER COBRANZAS ---
        window.renderCobranzas = () => {
            const tbody = document.querySelector('#table-cobros tbody');
            const tbodyHist = document.querySelector('#table-sales-history tbody');
            tbody.innerHTML = ''; tbodyHist.innerHTML = '';
            const filtro = document.getElementById('search-deudor').value.toLowerCase();

            localData.ventas.forEach(v => {
                const land = localData.terrenos.find(t => t.id === v.landId);
                const landName = land ? land.nombre : 'Borrado';
                const mon = v.moneda || 'BOB';

                // Historial
                const trH = document.createElement('tr');
                trH.innerHTML = `
                    <td>${v.id.substr(0,5)}...</td><td>${v.cliente}</td><td>${landName}</td>
                    <td>${window.formatMoney(v.total, mon)}</td><td>${mon}</td>
                    <td><button class="btn btn-warning" style="padding:4px;" onclick="window.openEditSale('${v.id}')"><i class="fas fa-edit"></i></button></td>
                    <td><button class="btn btn-danger" style="padding:4px;" onclick="window.deleteSale('${v.id}')"><i class="fas fa-trash"></i></button></td>
                `;
                tbodyHist.appendChild(trH);

                // Resumen
                if(!v.cliente.toLowerCase().includes(filtro)) return;
                const prox = v.cuotas.find(c => c.estado !== 'Pagada');
                const tr = document.createElement('tr');
                if(prox) {
                    const today = new Date().toISOString().split('T')[0];
                    let color = (prox.vencimiento < today) ? 'red' : '#333';
                    const icon = (v.galeria && v.galeria.length>0) ? `<i class="fas fa-images" style="color:blue; cursor:pointer" onclick="window.verDetalles('${v.id}')"></i>` : '';
                    
                    tr.innerHTML = `
                        <td><strong>${v.cliente}</strong> ${icon}</td>
                        <td>${landName}</td>
                        <td>${prox.n}/${v.cuotas.length}</td>
                        <td style="color:${color}; font-weight:bold">${prox.vencimiento}</td>
                        <td>${window.formatMoney(prox.monto, mon)}</td>
                        <td><button class="btn btn-success" style="padding:4px;" onclick="window.abrirCobro('${v.id}', ${prox.n})">Cobrar</button></td>
                    `;
                } else {
                    tr.innerHTML = `<td><strong>${v.cliente}</strong></td><td>${landName}</td><td colspan="3" class="text-center" style="color:green">Completado</td><td>-</td>`;
                }
                tbody.appendChild(tr);
            });
        };

        // --- COBRO INTELIGENTE ---
        window.abrirCobro = (saleId, cNum) => {
            const v = localData.ventas.find(x => x.id === saleId);
            const idx = v.cuotas.findIndex(c => c.n === cNum);
            const c = v.cuotas[idx];
            
            document.getElementById('c-sale-id').value = saleId;
            document.getElementById('c-idx').value = idx;
            document.getElementById('c-num').innerText = c.n;
            document.getElementById('c-monto-original').innerText = window.formatMoney(c.monto, v.moneda);
            document.getElementById('c-monto-pagar').value = c.monto.toFixed(2); // Editable
            
            const isUSD = (v.moneda === 'USD');
            document.getElementById('c-moneda-ref').innerText = isUSD ? 'USD' : 'Bs';
            document.getElementById('div-tc-cobro').classList.toggle('hidden', !isUSD);
            document.getElementById('c-tasa-dia').required = isUSD;

            document.getElementById('modal-cobro').classList.remove('hidden');
        };

        document.getElementById('form-cobro').addEventListener('submit', async (e) => {
            e.preventDefault();
            window.showLoader(true);
            const sId = document.getElementById('c-sale-id').value;
            const idx = parseInt(document.getElementById('c-idx').value);
            const pago = parseFloat(document.getElementById('c-monto-pagar').value);
            const fecha = document.getElementById('c-fecha').value;
            const tc = parseFloat(document.getElementById('c-tasa-dia').value)||1;

            const v = localData.ventas.find(x => x.id === sId);
            let dinero = pago;
            let i = idx;
            
            // Lógica Amortización
            const cuotasUpdate = [...v.cuotas]; // Copia para modificar
            while(dinero > 0.01 && i < cuotasUpdate.length) {
                const curr = cuotasUpdate[i];
                if(curr.estado === 'Pagada') { i++; continue; }

                if(dinero >= curr.monto) {
                    dinero -= curr.monto;
                    curr.estado = 'Pagada';
                    curr.fechaPago = fecha;
                    curr.tcPago = (v.moneda === 'USD') ? tc : null;
                } else {
                    curr.monto -= dinero;
                    dinero = 0;
                }
                i++;
            }

            await updateDoc(doc(db, "ventas", sId), { cuotas: cuotasUpdate });
            window.closeModal('modal-cobro');
            await window.initSystem();
        });

        // --- ELIMINAR VENTA ---
        window.deleteSale = async (id) => {
            if(!confirm("¿Eliminar venta? El terreno quedará DISPONIBLE.")) return;
            window.showLoader(true);
            const v = localData.ventas.find(x => x.id === id);
            
            // 1. Liberar Terreno
            if(v && v.landId) {
                try { await updateDoc(doc(db, "terrenos", v.landId), { estado: 'Disponible' }); } 
                catch(e) { console.log("Terreno ya no existe o error"); }
            }
            // 2. Borrar Venta
            await deleteDoc(doc(db, "ventas", id));
            await window.initSystem();
        };

        // --- EDITAR VENTA ---
        let currentEditSaleId = null;
        window.openEditSale = (id) => {
            currentEditSaleId = id;
            const v = localData.ventas.find(x => x.id === id);
            document.getElementById('e-v-id').value = id;
            document.getElementById('e-v-cliente').value = v.cliente;
            document.getElementById('e-v-ci').value = v.ci;
            document.getElementById('e-v-doc-new').value = '';
            window.renderGallery('e-v-gallery', v.galeria || [], 'window.deleteSalePhoto');
            document.getElementById('modal-editar-venta').classList.remove('hidden');
        };

        window.deleteSalePhoto = async (idx) => {
            if(!confirm("¿Borrar doc?")) return;
            const v = localData.ventas.find(x => x.id === currentEditSaleId);
            const newG = [...v.galeria];
            newG.splice(idx, 1);
            window.showLoader(true);
            await updateDoc(doc(db, "ventas", currentEditSaleId), { galeria: newG });
            await window.initSystem();
            window.openEditSale(currentEditSaleId);
        };

        document.getElementById('form-editar-venta').addEventListener('submit', async (e) => {
            e.preventDefault();
            window.showLoader(true);
            const id = document.getElementById('e-v-id').value;
            const v = localData.ventas.find(x => x.id === id);
            
            const files = document.getElementById('e-v-doc-new').files;
            const urls = await uploadFilesToStorage(files, 'ventas');
            const finalG = (v.galeria || []).concat(urls);

            await updateDoc(doc(db, "ventas", id), {
                cliente: document.getElementById('e-v-cliente').value,
                ci: document.getElementById('e-v-ci').value,
                galeria: finalG
            });
            window.closeModal('modal-editar-venta');
            await window.initSystem();
        });

        // --- DETALLES ---
        window.renderGallery = (containerId, images, deleteFnName) => {
            const c = document.getElementById(containerId);
            c.innerHTML = '';
            if(!images) return;
            images.forEach((url, idx) => {
                c.innerHTML += `<div class="gallery-item"><img src="${url}"><div class="gallery-delete" onclick="${deleteFnName}(${idx})">X</div></div>`;
            });
        };

        window.verDetalles = (id) => {
            let d = localData.terrenos.find(x => x.id === id);
            let isLand = true;
            if(!d) { d = localData.ventas.find(x => x.id === id); isLand = false; }
            if(!d) return;

            const c = document.getElementById('detalles-contenido');
            let imgs = '';
            if(d.galeria && d.galeria.length > 0) {
                d.galeria.forEach(url => imgs += `<img src="${url}" class="img-full" onclick="window.open(this.src)">`);
            } else { imgs = '<p>Sin fotos</p>'; }

            if(isLand) {
                c.innerHTML = `<h4>${d.nombre}</h4><p>Estado: ${d.estado}</p><p>Precio: ${window.formatMoney(d.precio, d.moneda)}</p><p>${d.notas}</p><hr>${imgs}`;
            } else {
                c.innerHTML = `<h4>Cliente: ${d.cliente}</h4><p>CI: ${d.ci}</p><hr>${imgs}`;
            }
            document.getElementById('modal-detalles').classList.remove('hidden');
        };

        // --- CHARTS ---
        let ch1 = null, ch2 = null;
        window.updateDashboard = () => {
            // Stats
            document.getElementById('stat-total').innerText = localData.terrenos.length;
            document.getElementById('stat-disponibles').innerText = localData.terrenos.filter(t=>t.estado==='Disponible').length;

            let rec = 0, pend = 0;
            localData.ventas.forEach(v => {
                let entF = (v.moneda === 'USD') ? 6.96 : 1;
                rec += (v.entrada * entF);
                v.cuotas.forEach(c => {
                    if(c.estado==='Pagada') {
                        let f = (v.moneda==='USD') ? (c.tcPago||6.96) : 1;
                        rec += (c.monto * f);
                    } else {
                        let f = (v.moneda==='USD') ? 6.96 : 1;
                        pend += (c.monto * f);
                    }
                });
            });
            document.getElementById('stat-recaudado').innerText = window.formatMoney(rec, 'BOB');

            // Charts
            const ctx1 = document.getElementById('chartStatus').getContext('2d');
            const d1 = [localData.terrenos.filter(t=>t.estado==='Disponible').length, localData.terrenos.filter(t=>t.estado==='Vendido').length];
            if(ch1) ch1.destroy();
            ch1 = new Chart(ctx1, { type: 'doughnut', data: { labels: ['Disp','Vend'], datasets:[{data:d1, backgroundColor:['#27ae60','#7f8c8d']}] } });

            const ctx2 = document.getElementById('chartFinanzas').getContext('2d');
            if(ch2) ch2.destroy();
            ch2 = new Chart(ctx2, { type: 'bar', data: { labels: ['Recaudado (Bs)','Pendiente (Bs)'], datasets:[{label:'Total', data:[rec, pend], backgroundColor:['#2980b9','#c0392b']}] } });
        };

    </script>
</body>
</html>
